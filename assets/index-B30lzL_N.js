var $=c=>{throw TypeError(c)};var q=(c,e,t)=>e.has(c)||$("Cannot "+t);var x=(c,e,t)=>(q(c,e,"read from private field"),t?t.call(c):e.get(c)),k=(c,e,t)=>e.has(c)?$("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(c):e.set(c,t),F=(c,e,t,n)=>(q(c,e,"write to private field"),n?n.call(c,t):e.set(c,t),t),O=(c,e,t)=>(q(c,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();class j{constructor(e,t){this.boggedState=e,this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.frameBuffer=new Uint8ClampedArray(this.boggedState.gameWidth*this.boggedState.gameHeight*4),this.queuedParticles=[],this.queuedOverlayPixels=[],this.queuedUIPixels=[],this.canvas.style.aspectRatio=(this.boggedState.gameWidth/this.boggedState.gameHeight).toString(),this.canvas.width=this.boggedState.gameWidth,this.canvas.height=this.boggedState.gameHeight,this.ctx.imageSmoothingEnabled=!1,this.ctx.translate(0,this.canvas.height),this.ctx.scale(1,-1)}queueUIPixels(e){this.queuedUIPixels=[],this.queuedUIPixels=e}queueParticles(e,t){if(this.queuedParticles.push(...e),t){const n=this.boggedState.gameWidth,i=this.boggedState.gameHeight;for(const s of e){const a=(i-1-s.position.y)*n+s.position.x;this.queuedOverlayPixels.push({index:a,value:t})}}}queueOverlayPixels(e){this.queuedOverlayPixels.push(...e)}renderThisFrame(){if(this.boggedState.isBrushOutlineVisible){const n=this.getBrushOutline(Math.floor(this.boggedState.mouseX),Math.floor(this.boggedState.mouseY));this.queuedUIPixels=n}this.processQueuedParticles();let e=new Uint8ClampedArray(this.frameBuffer);this.addBuffer(e,this.queuedOverlayPixels),this.addBuffer(e,this.queuedUIPixels);const t=new ImageData(e,this.boggedState.gameWidth,this.boggedState.gameHeight);this.ctx.putImageData(t,0,0),this.queuedParticles.length=0,this.queuedOverlayPixels=[],this.queuedUIPixels=[]}processQueuedParticles(){const e=this.queuedParticles,t=this.boggedState.gameWidth,n=this.boggedState.gameHeight;for(const i of e){const s=i.position.x,o=i.position.y,d=(n-1-o)*t+s;let r=this.processParticleColor(i);this.frameBuffer[d*4+0]=r[0],this.frameBuffer[d*4+1]=r[1],this.frameBuffer[d*4+2]=r[2],this.frameBuffer[d*4+3]=r[3]}}processParticleColor(e){return e.color}addBuffer(e,t){for(const{index:n,value:i}of t){const s=e[n*4+0],o=e[n*4+1],a=e[n*4+2],d=e[n*4+3],r=i[0],l=i[1],h=i[2],m=i[3],u=m/255,p=Math.round(r*u+s*(1-u)),g=Math.round(l*u+o*(1-u)),w=Math.round(h*u+a*(1-u)),E=Math.min(d,m);e[n*4+0]=p,e[n*4+1]=g,e[n*4+2]=w,e[n*4+3]=E}}getBrushOutline(e,t){const n=this.boggedState.currentBrushSize,i=[],s=227,o=227,a=227,d=180,r=this.boggedState.gameWidth,l=this.boggedState.gameHeight,h=[-1,1],m=(w,E)=>{for(const b of h)for(const v of h){const f=e+w*v,y=t+E*b,S=e+E*v,P=t+w*b;if(f>=0&&f<r&&y>=0&&y<l){const C=(l-y)*r+f;i.push({index:C,value:new Uint8ClampedArray([s,o,a,d])})}if(S>=0&&S<r&&P>=0&&P<l){const C=(l-P)*r+S;i.push({index:C,value:new Uint8ClampedArray([s,o,a,d])})}}};let u=n,p=0,g=n-n;for(m(u,p);p<u;)p++,g<0?g+=2*p+1:(u--,g+=2*(p-u)+1),m(u,p);return i}}const Y=Object.freeze({WHITE:new Uint8ClampedArray([255,255,255,255]),BLACK:new Uint8ClampedArray([0,0,0,255]),GRAY:new Uint8ClampedArray([128,128,128,255]),RED:new Uint8ClampedArray([255,0,0,255]),GREEN:new Uint8ClampedArray([0,255,0,255]),BLUE:new Uint8ClampedArray([0,0,255,255]),YELLOW:new Uint8ClampedArray([255,255,0,255]),CYAN:new Uint8ClampedArray([0,255,255,255]),MAGENTA:new Uint8ClampedArray([255,0,255,255]),TRANSPARENT_BLACK:new Uint8ClampedArray([0,0,0,0]),SEMI_TRANSPARENT_WHITE:new Uint8ClampedArray([255,255,255,128])}),D={createColor(c){return this.hexToColor(c)},hexToColor(c){if(c==null)return Y.BLACK;let e=c.replace("#","");if(e.length===6)e+="FF";else if(e.length===3){let n="";for(const i of e)n+=i,n+=i;e=n+"FF"}else return Y.BLACK;const t=parseInt(e,16);return new Uint8ClampedArray([t>>24&255,t>>16&255,t>>8&255,t&255])},colorToHex(c){const[e,t,n,i]=c,s=o=>o.toString(16).padStart(2,"0");return`#${s(e)}${s(t)}${s(n)}${s(i)}`},lerpColor(c,e,t){const n=c[0]+(e[0]-c[0])*t,i=c[1]+(e[1]-c[1])*t,s=c[2]+(e[2]-c[2])*t,o=c[3]+(e[3]-c[3])*t;return new Uint8ClampedArray([n,i,s,o])},createColorRamp(c,e,t){if(t<2)return[c,e];const n=1/(t-1),i=new Array(t);for(let s=0;s<t;s++){const o=s*n;i[s]=this.lerpColor(c,e,o)}return i},invertColor(c){const e=255-c[0],t=255-c[1],n=255-c[2],i=c[3];return new Uint8ClampedArray([e,t,n,i])},getLuminance(c){const e=c[0],t=c[1],n=c[2];return .299*e+.587*t+.114*n},getHexLuminance(c){const e=c.startsWith("#")?c.substring(1):c;if(e.length<6)return 0;const t=parseInt(e,16),n=t>>16&255,i=t>>8&255,s=t&255;return .299*n+.587*i+.114*s}},H={lerp(c,e,t){return c+(e-c)*t},shuffleArray(c){const e=[...c];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e},calculateRepose(c){let e=Math.max(10,Math.min(c,80));const t=e*Math.PI/180;let n=[];if(n.push([{dx:0,dy:-1}]),e<50){n.push([{dx:1,dy:-1},{dx:-1,dy:-1}]);const i=Math.round(1/Math.tan(t));n.push([{dx:i,dy:-1},{dx:i*-1,dy:-1}])}else{const i=Math.round(Math.tan(t));n.push([{dx:1,dy:-i},{dx:-1,dy:-i}])}return n}},Z=Object.freeze({ALL_NEIGHBORS:[{dx:-1,dy:1},{dx:0,dy:1},{dx:1,dy:1},{dx:-1,dy:0},{dx:1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}]}),T=Object.freeze({UP_LEFT:{dx:-1,dy:1},UP:{dx:0,dy:1},UP_RIGHT:{dx:1,dy:1},LEFT:{dx:-1,dy:0},RIGHT:{dx:1,dy:0},DOWN_LEFT:{dx:-1,dy:-1},DOWN:{dx:0,dy:-1},DOWN_RIGHT:{dx:1,dy:-1}});var _,L,I,R,X;class J{constructor(e,t,n){k(this,I);k(this,_);k(this,L);this.width=e,this.height=t,F(this,_,new Array(e*t)),F(this,L,new Set),this.particleData=n,O(this,I,X).call(this,0)}get data(){return x(this,_)}get dirtyParticles(){return x(this,L)}createParticleAt(e,t,n,i,s){if(!this.isInBounds(e,t))return!1;let o=O(this,I,R).call(this,n);return o.position.x=e,o.position.y=t,o.index=t*this.width+e,i&&this.markDirty(o,s),x(this,_)[t*this.width+e]=o,!0}getParticleAt(e,t){return this.isInBounds(e,t)?x(this,_)[t*this.width+e]:null}tryMoveParticle(e,t,n=!1,i=!1,s=!1){for(const o of t){if(!o)continue;const a=H.shuffleArray(o);for(const d of a){let r=d.dx;n&&Math.random()>.5&&(r=d.dx*-1);const l=e.position.x+r,h=e.position.y+d.dy,m=this.getParticleAt(l,h);if(m&&m.isMovable&&e.density>m.density){x(this,_)[m.index]=e,x(this,_)[e.index]=m;const u={x:e.position.x,y:e.position.y},p=e.index;return e.position=m.position,e.index=m.index,m.position=u,m.index=p,i&&(this.markDirty(e,s),this.markDirty(m,s)),m}}}return null}swapParticles(e,t,n,i){x(this,_)[e.index]=t,x(this,_)[t.index]=e;const s={x:e.position.x,y:e.position.y},o=e.index;e.position=t.position,e.index=t.index,t.position=s,t.index=o,n&&(this.markDirty(e,i),this.markDirty(t,i))}getNeighborOf(e,t){const n=e.position.x+t.dx,i=e.position.y+t.dy;return this.getParticleAt(n,i)}getNeighborsOf(e,t,n,i){return t.map(o=>this.getNeighborOf(e,o)).filter(o=>o!==null).filter(o=>{const a=n===void 0||o.category===n,d=i===void 0||o.id===i;return a&&d})}markDirty(e,t){if(x(this,L).add(e.index),t){const n=this.getNeighborsOf(e,Z.ALL_NEIGHBORS);for(const i of n)x(this,L).add(i.index)}}isInBounds(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height}fillCircleAt(e,t,n,i){for(let s=-n;s<=n;s++)for(let o=-n;o<=n;o++){if(s*s+o*o>n*n)continue;const a=e+s,d=t+o;if(!this.isInBounds(a,d))continue;const r=this.getParticleAt(a,d);(i===0||r===null||r.id===0)&&this.createParticleAt(a,d,i,!0,!0)}}}_=new WeakMap,L=new WeakMap,I=new WeakSet,R=function(e){const t=this.particleData[e];if(!t)return null;let i=Math.random(),o=6-1,a=Math.round(i*o)/o;const d=D.hexToColor(t.baseColor),r=D.hexToColor(t.variantColor),l=D.lerpColor(d,r,a);let h={handle:-1,id:t.id,name:t.name,color:l,position:{x:-1,y:-1},index:0,isMovable:t.isMovable,density:t.density};return t.category===0?{...h,category:0}:t.category===1?{...h,category:1}:t.category===2?{...h,category:2,concentration:0,maxConcentration:t.maxConcentration}:t.category===3?{...h,category:3}:t.category===4?{...h,category:4,reposeAngle:t.reposeAngle,reposeDirections:t.reposeDirections}:t.category===5?{...h,category:5,node:-1}:null},X=function(e){const t=this.width,n=this.height;F(this,_,new Array(t*n));for(let i=0;i<n;i++)for(let s=0;s<t;s++){let o=i*t+s,a=O(this,I,R).call(this,e);a&&(a.position.x=s,a.position.y=i,a.index=o,x(this,_)[o]=a,x(this,L).add(a.index))}};var N,Q;class tt{constructor(e,t,n,i){k(this,N);this.isRunning=!1,this.animationFrameId=null,this.lastFrameTime=0,this.tickCount=0,this.accumulator=0,this.clearDirtyDelta=0,this.clearDirtyFreq=2,this.neighborKeys=Object.keys(T),this.gameLoop=s=>{if(!this.isRunning)return;this.lastFrameTime===0&&(this.lastFrameTime=s);const o=s-this.lastFrameTime;this.lastFrameTime=s,this.debug.updateDisplay(s,this),this.handleInput(),this.accumulator+=o;let a=0;for(;this.accumulator>=this.physicsInterval;)if(this.stepPhysics(),a++,this.tickCount++,this.accumulator-=this.physicsInterval,a>60){this.accumulator=0;break}this.renderer.renderThisFrame(),this.animationFrameId=requestAnimationFrame(this.gameLoop)},this.boggedState=e,this.renderer=t,this.inputManager=n,this.debug=i,this.currentGrid=new J(this.boggedState.gameWidth,this.boggedState.gameHeight,this.boggedState.particleData),this.particlesProcessed=new Set,this.renderInterval=this.boggedState.renderInterval,this.physicsInterval=this.boggedState.physicsInterval,this.boggedState.currentGrid=this.currentGrid}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=0,this.animationFrameId=requestAnimationFrame(this.gameLoop))}stop(){this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}handleInput(){this.boggedState.isInspectingParticle||(this.boggedState.isRightMouseButtonDown?this.currentGrid.fillCircleAt(Math.floor(this.boggedState.mouseX),Math.floor(this.boggedState.mouseY),this.boggedState.currentBrushSize,0):this.boggedState.isLeftMouseButtonDown&&this.currentGrid.fillCircleAt(Math.floor(this.boggedState.mouseX),Math.floor(this.boggedState.mouseY),this.boggedState.currentBrushSize,this.boggedState.selectedParticleId))}stepPhysics(){let e=[];for(const n of this.currentGrid.dirtyParticles)e.push(this.currentGrid.data[n]);this.clearDirtyDelta++,this.clearDirtyDelta>this.clearDirtyFreq&&(this.currentGrid.dirtyParticles.clear(),this.clearDirtyDelta=0),this.renderer.queueParticles(e,this.debug.isOverlayEnabled?new Uint8ClampedArray([210,55,55,180]):void 0),this.particlesProcessed.clear(),e=H.shuffleArray(e),e.sort((n,i)=>n.position.y-i.position.y);for(const n of e)if(n&&!this.particlesProcessed.has(n.index))switch(n.category){case 1:break;case 2:this.handleLiquids(n);break;case 3:this.handleGases(n);break;case 4:O(this,N,Q).call(this,n);break;case 5:break;default:continue}let t=this.groupParticles(this.currentGrid,2);this.simulateEqualisation(t)}handleLiquids(e){let t=[[{dx:0,dy:-1}],[{dx:-1,dy:-1},{dx:1,dy:-1}],[{dx:-1,dy:0},{dx:1,dy:0}]];const n=this.currentGrid.tryMoveParticle(e,t,!1,!0,!0);n&&(this.particlesProcessed.add(e.index),this.particlesProcessed.add(n.index))}handleGases(e){const t=this.neighborKeys[Math.floor(Math.random()*this.neighborKeys.length)];let i=[[T[t]]];const s=this.currentGrid.tryMoveParticle(e,i,!1,!0,!0);s&&(this.particlesProcessed.add(e.index),this.particlesProcessed.add(s.index))}simulateEqualisation(e){for(const t of e){const n=t.liquidParticle.sort((d,r)=>r.position.y-d.position.y),i=t.emptyParticle.sort((d,r)=>d.position.y-r.position.y),s=n.length;let o=0;const a=s/4;for(let d=0;d<s;d++){const r=n[d],l=i[d];if(Math.sqrt(r.position.x*l.position.x+r.position.y*l.position.y),r.position.y>l.position.y&&(this.currentGrid.swapParticles(r,l,!0,!0),this.particlesProcessed.add(r.index),this.particlesProcessed.add(l.index),o++,o>=a))break}}}groupParticles(e,t){const n=e.width,i=e.height,s=[],o=[],a={};for(let r=i-1;r>=0;r--)for(let l=0;l<n;l++){const h=r*n+l,m=e.getParticleAt(l,r);if(!m||m.category!==t||m.category!==t)continue;const u=e.getNeighborOf(m,T.UP),p=e.getNeighborOf(m,T.LEFT),g=u&&u.id===m.id,w=p&&p.id===m.id;let E=-1;w&&(E=r*n+(l-1));let b=-1;g&&(b=(r+1)*n+l);const v=u&&u.id===0;if(!w&&!g){const f=o.length;s.push([h]),o.push({liquidParticle:[],emptyParticle:[]}),v&&(o[f].liquidParticle.push(m),o[f].emptyParticle.push(u)),a[h]=f}else if(w&&!g){const f=a[E];s[f].push(h),v&&(o[f].liquidParticle.push(m),o[f].emptyParticle.push(u)),a[h]=f}else if(!w&&g){const f=a[b];s[f].push(h),v&&(o[f].liquidParticle.push(m),o[f].emptyParticle.push(u)),a[h]=f}else{const f=a[b];s[f].push(h),v&&(o[f].liquidParticle.push(m),o[f].emptyParticle.push(u)),a[h]=f;const y=a[E];if(y!==f){const S=o[y];for(const C of S.liquidParticle)o[f].liquidParticle.push(C);for(const C of S.emptyParticle)o[f].emptyParticle.push(C);const P=s[y];for(const C of P)a[C]=f;s[y]=[],o[y]={liquidParticle:[],emptyParticle:[]}}}}return o.filter(r=>r.liquidParticle.length>30)}}N=new WeakSet,Q=function(e){let t=e.reposeDirections;const n=this.currentGrid.tryMoveParticle(e,t,!0,!0,!0);n&&(this.particlesProcessed.add(e.index),this.particlesProcessed.add(n.index))};const M=class M{constructor(e,t,n,i,s){this.contents=[],this.contentBarButtons=[],this.selectedContent=0,this.contentBarOrientation="left",this.isFocused=!1,this.isDragging=!1,this.dragOffset={x:0,y:0},this.onViewportResize=()=>{this.snapWindowBacc()},this.onWindowFocus=()=>{this.isFocused||(M.currentZIndex++,this.windowEl.style.zIndex=M.currentZIndex.toString())},this.onPointerDown=o=>{if(o.stopPropagation(),this.onWindowFocus(),o.button===0){this.titlebarEl.setPointerCapture(o.pointerId);const a=this.windowEl.getBoundingClientRect();this.dragOffset.x=o.clientX-a.left,this.dragOffset.y=o.clientY-a.top,this.isDragging=!0}else this.isDragging=!1},this.onPointerUp=o=>{this.isDragging&&(this.titlebarEl.releasePointerCapture(o.pointerId),this.isDragging=!1)},this.onPointerMove=o=>{if(this.isDragging){const a=this.hostEl.getBoundingClientRect(),d=o.clientX-this.dragOffset.x-a.left,r=o.clientY-this.dragOffset.y-a.top;this.setPosition({x:d,y:r})}},this.title=t,this.position=n,this.size=i,this.maxSize=s,this.isVisible=!1,this.hostEl=e,this.windowEl=this.createWindowElement(n,i,s,M.currentZIndex),this.titlebarEl=this.createTitlebarElement(t),this.controlBarEl=this.createControlBarElement(),this.contentWrapperEl=this.createContentWrapperElement(),this.contentBarEl=this.createContentBarElement(),this.contentContainerEl=this.createContentContainerElement(),this.hostEl.appendChild(this.windowEl),this.titlebarEl.appendChild(this.controlBarEl),this.windowEl.appendChild(this.titlebarEl),this.contentWrapperEl.appendChild(this.contentBarEl),this.contentWrapperEl.appendChild(this.contentContainerEl),this.windowEl.appendChild(this.contentWrapperEl),window.addEventListener("resize",this.onViewportResize)}destroy(){window.removeEventListener("resize",this.onViewportResize),this.windowEl.removeEventListener("mousedown",this.onWindowFocus),this.titlebarEl.removeEventListener("pointerdown",this.onPointerDown),this.titlebarEl.removeEventListener("pointermove",this.onPointerMove),this.titlebarEl.removeEventListener("pointerup",this.onPointerUp),this.windowEl&&this.windowEl.parentElement&&this.windowEl.parentElement.removeChild(this.windowEl),this.windowEl=null,this.titlebarEl=null,this.controlBarEl=null,this.contentWrapperEl=null,this.contentBarEl=null,this.contentContainerEl=null}setVisibility(e){e?this.windowEl.classList.add("is-visible"):this.windowEl.classList.remove("is-visible"),this.isVisible=e}setContentBarVisibility(e){e?this.contentBarEl.classList.add("is-visible"):this.contentBarEl.classList.remove("is-visible")}getContentBarButtonAtIndex(e){return this.contentBarButtons[e]}setPosition(e){const t=this.windowEl.offsetWidth,n=this.windowEl.offsetHeight,i=this.hostEl.offsetWidth,s=this.hostEl.offsetHeight,o=Math.max(0,Math.min(e.x,i-t)),a=Math.max(0,Math.min(e.y,s-n));this.windowEl.style.left=`${o}px`,this.windowEl.style.top=`${a}px`}setContentBarOrientation(e){this.contentWrapperEl.classList.remove("top","bottom","left","right"),this.contentWrapperEl.classList.add(e),this.contentBarOrientation=e}addNewContent(e,t,n){let i=this.contents.length;this.contents.length!==0&&(e.style.display="none"),e.id="container-"+i,this.contentContainerEl.appendChild(e);const s=document.createElement("button");s.classList.add("ui-window__content-bar__button"),s.title=t,this.contentBarEl.appendChild(s);const o=document.createElement("img");o.classList.add("ui-window__content-bar__button__icon"),o.alt=t,o.src=n,s.appendChild(o),s.addEventListener("click",()=>this.displayContentAtIndex(i)),this.contentBarButtons.push(s),this.contents.push(e)}displayContent(e){const t=this.contents;for(let n=0;n<t.length;n++){const i=t[n];if(i===e){this.contents.forEach((s,o)=>{s.style.display="none"}),i.style.display="",this.selectedContent=n,this.contentBarButtons.forEach((s,o)=>{o===n?s.classList.add("active"):s.classList.remove("active")});return}}}displayContentAtIndex(e){const t=this.contents[e];t&&this.displayContent(t)}addContentBarSeparator(e=!1){const t=document.createElement("div");return t.classList.add("ui-window__content-bar__separator"),e&&t.classList.add("is-spacer"),this.contentBarEl.appendChild(t),t}createWindowElement(e,t,n,i){const s=document.createElement("div");return s.classList.add("ui-window"),s.style.left=`${e.x}px`,s.style.top=`${e.y}px`,s.style.width=`${t.width}px`,s.style.height=`${t.height}px`,s.style.maxWidth=`${n.width}px`,s.style.maxHeight=`${n.height}px`,s.style.zIndex=i.toString(),s.addEventListener("mousedown",this.onWindowFocus),s}createTitlebarElement(e){const t=document.createElement("div");t.classList.add("ui-window__title-bar");const n=document.createElement("span");return n.classList.add("ui-window__title"),n.textContent=e,t.appendChild(n),t.addEventListener("pointerdown",this.onPointerDown),t.addEventListener("pointermove",this.onPointerMove),t.addEventListener("pointerup",this.onPointerUp),t}createControlBarElement(){const e=document.createElement("div");e.classList.add("ui-window__title-bar__button__wrapper");const t=document.createElement("button");t.classList.add("ui-window__title-bar__button");const n=document.createElement("img");return n.src="./assets/icons/close.svg",t.appendChild(n),e.appendChild(t),t.addEventListener("pointerdown",i=>{i.stopPropagation()}),t.addEventListener("click",()=>{this.setVisibility(!1)}),e}createContentWrapperElement(){const e=document.createElement("div");return e.classList.add("ui-window__content__wrapper","left"),e}createContentBarElement(){const e=document.createElement("div");return e.classList.add("ui-window__content-bar"),e}createContentContainerElement(){const e=document.createElement("div");return e.classList.add("ui-window__content-container"),e}snapWindowBacc(){const e=this.windowEl.offsetWidth,t=this.windowEl.offsetHeight,n=this.hostEl.offsetWidth,i=this.hostEl.offsetHeight,s=Math.max(0,n-e),o=Math.max(0,i-t),a=this.windowEl.offsetLeft,d=this.windowEl.offsetTop,r=Math.max(0,Math.min(a,s)),l=Math.max(0,Math.min(d,o));(r!==a||l!==d)&&(this.windowEl.style.left=`${r}px`,this.windowEl.style.top=`${l}px`)}};M.currentZIndex=100;let B=M;class W{constructor(){this.contentElement=document.createElement("div"),this.contentElement.classList.add("ui-window__content")}addSeparator(e=1,t=!1){const n=document.createElement("div");if(n.classList.add("ui-window__content__separator"),n.style.height=`${e}px`,t){const i=document.createElement("div");i.classList.add("ui-window__content__separator__line"),n.appendChild(i)}return this.contentElement.appendChild(n),n}addTitle(e){const t=document.createElement("h3");return t.classList.add("ui-window__content__heading-title"),t.textContent=e,this.contentElement.appendChild(t),t}addSection(e){const t=document.createElement("h4");return t.classList.add("ui-window__content__heading-section"),t.textContent=e,this.contentElement.appendChild(t),t}addText(e,t,n,i){const s=document.createElement("p");return s.classList.add("ui-window__content__text"),s.textContent=e,t!=null&&(s.style.color=t),i!=null&&(s.id=i),n!=null&&(s.style.fontWeight=n),this.contentElement.appendChild(s),s}addPropertyPanel(e,t,n){const i=r=>r.length===0?!1:/^#([0-9A-Fa-f]{3,4}|[0-9A-Fa-f]{6}|[0-9A-Fa-f]{8})$/.test(r.trim()),s=document.createElement("div");s.classList.add("ui-window__helper__flex-row","ui-window__content__info-row"),n!=null&&(s.id=n);const o=document.createElement("label");o.textContent=`${e}:`,s.appendChild(o);const a=document.createElement("div");a.classList.add("ui-window__helper__spacer"),s.appendChild(a);const d=document.createElement("span");return d.classList.add("ui-window__content__info-value"),d.textContent=t,s.appendChild(d),i(t)&&(d.style.backgroundColor=t,d.style.padding="0 6px",d.style.borderRadius="6px",d.style.color=D.getHexLuminance(t)>115?"#323238":"#FFFFFF"),this.contentElement.appendChild(s),s}addDropperPanel(e,t){const n=document.createElement("div");n.classList.add("ui-window__helper__flex-row"),t!=null&&(n.id=t);const i=document.createElement("label");i.textContent=`${e}:`,n.appendChild(i);const s=document.createElement("div");s.classList.add("ui-window__helper__spacer"),n.appendChild(s);const o=document.createElement("button");o.classList.add("ui-window__mini-button"),o.style.backgroundColor="transparent";const a=document.createElement("img");return a.classList.add("ui-window__mini-button__icon"),a.src="./assets/icons/dropper.svg",o.appendChild(a),n.appendChild(o),this.contentElement.appendChild(n),n}addLink(e,t,n){const i=document.createElement("p");i.classList.add("ui-window__content__text"),n!=null&&(i.id=n);const s=document.createElement("a");return s.href=t,s.textContent=e,s.target="_blank",i.appendChild(s),this.contentElement.appendChild(i),i}addBulletedList(e){const t=document.createElement("ul");return t.classList.add("ui-window__content"),e.forEach(n=>{const i=document.createElement("li");i.classList.add("ui-window__content"),i.textContent=n,t.appendChild(i)}),this.contentElement.appendChild(t),t}addNumberedList(e){const t=document.createElement("ol");return t.classList.add("ui-window__content"),e.forEach(n=>{const i=document.createElement("li");i.classList.add("ui-window__content"),i.textContent=n,t.appendChild(i)}),this.contentElement.appendChild(t),t}addImage(e,t,n,i){const s=document.createElement("img");return s.classList.add("ui-window__content__image"),s.src=t,s.alt=n,s.width=e.width,s.height=e.height,i!=null&&(s.id=i),this.contentElement.appendChild(s),s}addSlider(e,t,n,i,s,o){const a=document.createElement("div");a.classList.add("ui-window__helper__flex-row"),o!=null&&(a.id=o);const d=document.createElement("label");d.textContent=e+":",a.appendChild(d);const r=document.createElement("input");r.type="range",r.min=t.toString(),r.max=n.toString(),r.value=i.toString(),r.step=s.toString(),o!=null&&(r.id=o+"-range"),a.appendChild(r);const l=document.createElement("input");return l.style.minWidth="40px",l.type="number",l.min=t.toString(),l.max=n.toString(),l.value=i.toString(),l.step=s.toString(),o!=null&&(l.id=o+"-number"),a.appendChild(l),r.oninput=()=>l.value=r.value,l.onchange=()=>{const h=Math.max(t,Math.min(n,parseInt(l.value))).toString();r.value=h,l.value=h},this.contentElement.appendChild(a),a}addTextInput(e,t,n,i){const s=document.createElement("div");s.classList.add("ui-window__content__text-input__wrapper");const o=document.createElement("label");o.textContent=e+":",s.appendChild(o);const a=document.createElement("input");return a.type="text",a.placeholder=t,a.value=n,i!=null&&(a.id=i),s.appendChild(a),this.contentElement.appendChild(s),s}addButton(e,t,n){const i=document.createElement("button");return i.classList.add("ui-window__content__button"),i.textContent=e,t!=null&&(i.id=t),n!=null&&(i.style.backgroundColor=n),this.contentElement.appendChild(i),i}addDropdownButton(e,t,n=0,i){const s=document.createElement("div");s.classList.add("ui-window__helper__flex-row");const o=document.createElement("label");o.textContent=e+":",s.appendChild(o);const a=document.createElement("div");a.classList.add("ui-window__content__dropdown-button__wrapper"),s.appendChild(a);const d=document.createElement("div");d.classList.add("ui-window__content__dropdown-button");const r=document.createElement("span");r.textContent=t[0]?t[0]:"Template Item",i!=null&&(r.id=`${i}-display`),d.appendChild(r),a.appendChild(d);const l=document.createElement("ul");l.classList.add("ui-window__content__dropdown-list"),i!=null&&(l.id=`${i}-list`),a.appendChild(l);let h=Math.max(0,Math.min(n,t.length-1));const m=[];for(let u=0;u<t.length;u++){const p=t[u],g=document.createElement("li");g.style.marginBottom="0px",g.classList.add("ui-window__content__dropdown-item"),g.textContent=p,g.dataset.index=u.toString(),g.dataset.value=p.toLowerCase().replace(/\s/g,"-"),u===h&&(g.classList.add("is-selected"),r.textContent=p),g.addEventListener("click",w=>{w.stopPropagation(),m[h].classList.remove("is-selected"),h=u,g.classList.add("is-selected"),r.textContent=p,l.classList.remove("is-open")}),l.appendChild(g),m.push(g)}return d.addEventListener("click",u=>{if(u.stopPropagation(),l.classList.toggle("is-open")){l.parentElement,l.dataset.originId=a.id,document.body.appendChild(l);const g=d.getBoundingClientRect(),w=l.getBoundingClientRect(),E=l.scrollHeight||w.height,b=document.documentElement.clientHeight;l.style.position="absolute",l.style.left=`${g.left}px`,l.style.width=`${g.width}px`,l.style.zIndex="9999";const v=l.querySelector(".dropdown-item.is-selected");if(v){const f=v.offsetTop;let y=g.top-f;y<0&&(y=0),y+E>b&&(y=Math.max(0,b-E)),l.style.top=`${Math.round(y)}px`,l.scrollTop=f}else{let f=g.bottom;f+E>b&&(f=Math.max(0,b-E)),l.style.top=`${Math.round(f)}px`,l.scrollTop=0}}else l.parentElement===document.body&&a.appendChild(l)}),this.contentElement.appendChild(s),{button:d,items:m}}addToggleSwitch(e,t=!1,n){const i=document.createElement("div");i.classList.add("ui-window__helper__flex-row");const s=document.createElement("label");s.textContent=e+":",i.appendChild(s);const o=document.createElement("div");o.classList.add("ui-window__content__toggle-button__wrapper"),i.appendChild(o);const a=document.createElement("div");a.classList.add("ui-window__content__toggle-button"),a.dataset.state=t?"on":"off",t&&a.classList.add("is-on"),n!=null&&(a.id=n+"-switch"),o.appendChild(a);const d=document.createElement("span");d.classList.add("ui-window__content__toggle-button__indicator","indicator-o"),d.textContent="O",a.appendChild(d);const r=document.createElement("span");r.classList.add("ui-window__content__toggle-button__indicator","indicator-i"),r.textContent="I",a.appendChild(r);const l=document.createElement("div");return l.classList.add("ui-window__content__toggle-button__slider"),a.appendChild(l),a.addEventListener("click",()=>{const h=a.classList.toggle("is-on");a.dataset.state=h?"on":"off"}),this.contentElement.appendChild(i),a}}var A=(c=>(c[c.Palette=1]="Palette",c[c.DebugStats=2]="DebugStats",c[c.DebugQuickLook=3]="DebugQuickLook",c))(A||{});class et{constructor(e,t){this.windows=new Map,this.selectedParticleButton=null,this.host=e,this.boggedState=t,this.addWindowDropdownListener()}openWindow(e,t){const n=this.getOrCreateWindow(e);n&&!n.isVisible&&n.setVisibility(!0)}closeWindow(e){const t=this.windows.get(e);t&&t.isVisible&&t.setVisibility(!1)}toggleWindow(e,t){const n=this.getOrCreateWindow(e);n&&(n.isVisible?n.setVisibility(!1):n.setVisibility(!0))}getOrCreateWindow(e){let t=this.windows.get(e);if(!t){switch(e){case 1:t=this.createPaletteWindow();break;case 2:t=this.createDebugStatsWindow();break;case 3:t=this.createQuickLookWindow();break;default:return}this.windows.set(e,t)}return t}createPaletteWindow(){const e=u=>{const p=[],g=document.createElement("div");g.classList.add("particle-palette-container"),u.addNewContent(g,"Solids","./assets/icons/solid.svg"),p.push(g);const w=document.createElement("div");w.classList.add("particle-palette-container"),u.addNewContent(w,"Liquids","./assets/icons/liquid.svg"),p.push(w);const E=document.createElement("div");E.classList.add("particle-palette-container"),u.addNewContent(E,"Gases","./assets/icons/gas.svg"),p.push(E);const b=document.createElement("div");b.classList.add("particle-palette-container"),u.addNewContent(b,"Sands","./assets/icons/sand.svg"),p.push(b);const v=document.createElement("div");v.classList.add("particle-palette-container"),u.addNewContent(v,"Electronics","./assets/icons/electronics.svg"),p.push(v);const f=new W;let{button:y,items:S}=f.addDropdownButton("Orientation",["Top","Left","Right","Bottom"],3,"palette-orientation");return S.forEach(P=>{P.addEventListener("click",()=>{const C=P.dataset.value;C&&u.setContentBarOrientation(C)})}),u.addContentBarSeparator(!0),u.addNewContent(f.contentElement,"Settings","./assets/icons/settings.svg"),p.push(f.contentElement),p},t=(u,p,g)=>{p.addEventListener("click",()=>{if(this.boggedState.selectedCategoryId===g+1)return;this.selectedParticleButton&&this.selectedParticleButton.classList.remove("selected");const w=u.querySelector(".particle-button");w?(w.classList.add("selected"),this.selectedParticleButton=w,this.boggedState.selectedParticleId=parseInt(w.dataset.particleId||"0",10),this.boggedState.selectedCategoryId=parseInt(w.dataset.category||"0",10)):(this.boggedState.selectedParticleId=0,this.boggedState.selectedCategoryId=0)})},n=u=>{const p=document.createElement("button");p.className="particle-button",p.textContent=u.name;const g=D.getHexLuminance(u.baseColor)>210,w=g?"#323238":"#FFFFFF",E=g?"#FFFFFF":"#323238";return p.style.setProperty("--particle-button-base-color",u.baseColor),p.style.setProperty("--particle-button-variant-color",u.variantColor),p.style.color=w,p.style.textShadow=`1px 1px 2px rgba(${E[0]}, ${E[1]}, ${E[2]}, 0.6)`,p.dataset.particleId=u.id.toString(),p.dataset.category=u.category.toString(),p},i="Particle Palette",s={x:390,y:124},o={width:332,height:206},a={width:420,height:400},d=new B(this.host,i,s,o,a),r=e(d);for(let u=0;u<r.length-1;u++){const p=r[u],g=d.getContentBarButtonAtIndex(u);g!==void 0&&t(p,g,u)}d.setContentBarVisibility(!0),d.setContentBarOrientation("bottom");const l=2;d.displayContentAtIndex(l-1);const h=this.boggedState.particleData;let m=null;for(const u in h){const p=h[u],g=r[p.category-1];if(!g)continue;const w=n(p);w.addEventListener("click",()=>{this.selectedParticleButton&&this.selectedParticleButton.classList.remove("selected"),w.classList.add("selected"),this.selectedParticleButton=w,this.boggedState.selectedParticleId=p.id,this.boggedState.selectedCategoryId=p.category}),g.appendChild(w),!m&&p.category===l&&(m=w,m.classList.add("selected"),this.selectedParticleButton=m,this.boggedState.selectedParticleId=p.id,this.boggedState.selectedCategoryId=p.category)}return d}createDebugStatsWindow(){const e="Debug Stats",t={x:80,y:80},n={width:260,height:46},i={width:260,height:46},s=new B(this.host,e,t,n,i),o=document.createElement("div");o.classList.add("debug__stats-content"),s.addNewContent(o,"Stats Content","./assets/icons/settings.svg");const a=document.createElement("div");a.classList.add("debug__stats-content__info-container"),o.appendChild(a);const d=document.createElement("div");d.classList.add("debug__stats-content__info-container"),o.appendChild(d);const r=this.boggedState.debugInstance;return r&&r.setStatsElements(a,d),s}createQuickLookWindow(){const e="Quick Look",t={x:160,y:120},n={width:340,height:460},i={width:420,height:600},s=new B(this.host,e,t,n,i),o=new W;s.addNewContent(o.contentElement,"Look up","./assets/icons/settings.svg");const a=o.addDropperPanel("Select Particle");o.addSeparator(0),o.addSection("Properties:");let d=o.addPropertyPanel("Name","Undefined"),r=o.addPropertyPanel("Color","#000000"),l=o.addPropertyPanel("Position","NaN"),h=o.addPropertyPanel("Index","NaN"),m=o.addPropertyPanel("Handle","NaN"),u=o.addPropertyPanel("Particle ID","NaN"),p=o.addPropertyPanel("Is Movable","NaN"),g=o.addPropertyPanel("Density","NaN");return a.querySelector("button")?.addEventListener("click",()=>{this.boggedState.isInspectingParticle?this.boggedState.isInspectingParticle=!1:(this.boggedState.canvasElement?.classList.add("cursor-picker"),this.boggedState.isInspectingParticle=!0)}),this.boggedState.canvasElement?.addEventListener("pointerdown",()=>{if(this.boggedState.isInspectingParticle){this.boggedState.canvasElement?.classList.remove("cursor-picker"),this.boggedState.isInspectingParticle=!1;const w=this.boggedState.mouseX,E=this.boggedState.mouseY,b=this.boggedState.currentGrid?.getParticleAt(Math.floor(w),Math.floor(E));if(b){let v=m.querySelector("span");v&&(v.textContent=b.handle.toString());let f=u.querySelector("span");f&&(f.textContent=b.id.toString());let y=d.querySelector("span");y&&(y.textContent=b.name);let S=r.querySelector("span");if(S){let z=D.colorToHex(b.color);S.textContent=z,S.style.backgroundColor=z}let P=l.querySelector("span");P&&(P.textContent=`X: ${b.position.x},Y: ${b.position.y}`);let C=h.querySelector("span");C&&(C.textContent=b.index.toString());let U=p.querySelector("span");U&&(U.textContent=b.isMovable.toString());let G=g.querySelector("span");G&&(G.textContent=b.density.toString())}}}),s}addWindowDropdownListener(){document.addEventListener("click",e=>{document.querySelectorAll(".ui-window__content__dropdown-list.is-open").forEach(t=>{const n=t.dataset.originId,i=n?document.getElementById(n):null;!t.contains(e.target)&&!i?.contains(e.target)&&(t.classList.remove("is-open"),i?.appendChild(t))})})}}class nt{constructor(e,t,n){this.activePointerId=null,this.isAppMenuOpen=!1,this.boggedState=e,this.windowManager=new et(t,e),this.viewport=t,this.canvas=n,this.initAppMenu(),this.bindCanvasEvents(),this.viewport.addEventListener("contextmenu",i=>{i.preventDefault()}),document.addEventListener("click",()=>{const i=document.querySelector(".app-menu__dropdown.is-open");i instanceof HTMLDivElement&&(i.classList.remove("is-open"),this.isAppMenuOpen=!1)}),this.windowManager.openWindow(A.Palette)}initAppMenu(){const e=[{id:"bog-menu-item",items:["Settings","Quit"]},{id:"world-item",items:["Particle Palette"]},{id:"debug-item",items:["Quick Look","Stats","Debug Menu"]},{id:"help-item",items:["About","Report Issue"]}],t=[];for(let n=0;n<e.length;n++){const i=e[n];if(!i)continue;const s=document.getElementById(i.id);if(!(s instanceof HTMLDivElement))continue;const o=this.createAppMenuDropdowns(s,i.items);o.items.forEach(d=>{t.push(d)});const a=o.menu;s.addEventListener("click",d=>{d.stopPropagation();const r=document.querySelector(".app-menu__dropdown.is-open");r&&r!==a&&r.classList.remove("is-open");const l=a.classList.toggle("is-open");this.isAppMenuOpen=l}),s.addEventListener("mouseenter",()=>{if(this.isAppMenuOpen&&!a.classList.contains("is-open")){const d=document.querySelector(".app-menu__dropdown.is-open");d&&d!==a&&d.classList.remove("is-open"),a.classList.add("is-open")}})}t.forEach(n=>{switch(n.textContent){case"Particle Palette":n.classList.remove("is-disabled"),n.addEventListener("click",()=>{this.windowManager.openWindow(A.Palette)});break;case"Stats":n.classList.remove("is-disabled"),n.addEventListener("click",()=>{this.windowManager.openWindow(A.DebugStats)});break;case"Quick Look":n.classList.remove("is-disabled"),n.addEventListener("click",()=>{this.windowManager.openWindow(A.DebugQuickLook)});break;case"About":n.classList.remove("is-disabled"),n.addEventListener("click",()=>{window.open("https://github.com/misuldansin/bog-engine/","_blank")});break;case"Report Issue":n.classList.remove("is-disabled"),n.addEventListener("click",()=>{window.open("https://github.com/misuldansin/bog-engine/issues/new","_blank")});break}})}createAppMenuDropdowns(e,t){const n=document.createElement("div");n.classList.add("app-menu__dropdown");let i=[];return t.forEach(s=>{const o=document.createElement("div");o.classList.add("app-menu__dropdown-item","is-disabled"),o.textContent=s,n.appendChild(o),i.push(o)}),e.appendChild(n),{menu:n,items:i}}bindCanvasEvents(){const e=i=>{try{this.canvas.releasePointerCapture(i.pointerId)}catch{}},t=i=>{try{this.canvas.setPointerCapture(i.pointerId)}catch{}},n=i=>{const s=this.canvas.getBoundingClientRect(),o=this.boggedState.gameWidth/s.width,a=this.boggedState.gameHeight/s.height,d=(i.clientX-s.left)*o,r=this.canvas.height-(i.clientY-s.top)*a;this.boggedState.mouseX=d,this.boggedState.mouseY=r};this.canvas.addEventListener("pointerdown",i=>{switch(n(i),i.button){case 0:this.boggedState.isLeftMouseButtonDown=!0;break;case 2:this.boggedState.isRightMouseButtonDown=!0;break;default:this.boggedState.isLeftMouseButtonDown=!1,this.boggedState.isRightMouseButtonDown=!1;break}t(i),this.activePointerId=i.pointerId}),this.canvas.addEventListener("pointermove",i=>{n(i),typeof i.buttons=="number"&&(this.boggedState.isLeftMouseButtonDown=(i.buttons&1)===1,this.boggedState.isRightMouseButtonDown=(i.buttons&2)===2)}),this.canvas.addEventListener("pointerup",i=>{this.activePointerId===i.pointerId&&(e(i),this.activePointerId=null),this.boggedState.isLeftMouseButtonDown=!1,this.boggedState.isRightMouseButtonDown=!1}),this.canvas.addEventListener("pointercancel",i=>{this.activePointerId===i.pointerId&&(e(i),this.activePointerId=null),this.boggedState.isLeftMouseButtonDown=!1,this.boggedState.isRightMouseButtonDown=!1}),this.canvas.addEventListener("lostpointercapture",i=>{this.activePointerId===i.pointerId&&(e(i),this.activePointerId=null),this.boggedState.isLeftMouseButtonDown=!1,this.boggedState.isRightMouseButtonDown=!1}),this.canvas.addEventListener("pointerenter",()=>{this.boggedState.isBrushOutlineVisible=!0}),this.canvas.addEventListener("pointerleave",()=>{this.boggedState.isBrushOutlineVisible=!1}),this.canvas.addEventListener("focus",()=>{this.boggedState.isBrushOutlineVisible=!0}),this.canvas.addEventListener("blur",()=>{this.boggedState.isBrushOutlineVisible=!1}),this.canvas.addEventListener("wheel",i=>{i.preventDefault();const s=Math.floor(this.boggedState.currentBrushSize-i.deltaY*this.boggedState.brushSensitivity),o=Math.max(0,Math.min(s,this.boggedState.brushMaxSize));this.boggedState.currentBrushSize=o},{passive:!1}),window.addEventListener("pointerup",()=>{this.boggedState.isLeftMouseButtonDown=!1,this.boggedState.isRightMouseButtonDown=!1,this.activePointerId=null}),document.addEventListener("visibilitychange",()=>{document.hidden&&(this.boggedState.isLeftMouseButtonDown=!1,this.boggedState.isRightMouseButtonDown=!1,this.activePointerId=null)})}}class it{constructor(e,t,n=!1){this.isStatsEnabled=!1,this.fpsElement=null,this.tpsElement=null,this.frameCount=0,this.fps=0,this.tps=0,this.lastStatsUpdateTime=0,this.boggedState=e,this.isEnabled=n,this.isOverlayEnabled=!1,this.elements=new Map,this.initDebug(t)}setStatsElements(e,t){this.fpsElement=e,this.tpsElement=t,this.isStatsEnabled=!0}enableDebug(e){this.isEnabled=!0,e&&(this.isOverlayEnabled=!0)}disableDebug(){this.isEnabled=!1,this.isOverlayEnabled=!1}updateDisplay(e,t){if(this.isEnabled){if(this.frameCount++,e>=this.lastStatsUpdateTime+1e3){const n=e-this.lastStatsUpdateTime;this.fps=this.frameCount*1e3/n,this.tps=t.tickCount*1e3/n,this.frameCount=0,t.tickCount=0,this.lastStatsUpdateTime=e}this.fpsElement&&(this.fpsElement.textContent=`FPS: ${this.fps.toFixed(0)}`),this.tpsElement&&(this.tpsElement.textContent=`TPS: ${this.tps.toFixed(0)}`)}}initDebug(e){const t=document.createElement("div");t.classList.add("debug-container"),e.appendChild(t),this.elements.set("debug-container",t);const n=document.createElement("div");n.classList.add("debug-info-container"),t.appendChild(n),this.elements.set("info-container",n)}}async function K(c){try{const e=await fetch(c);if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return await e.text()}catch(e){throw console.error(`Failed to read particle data from ${c}:`,e),new Error("Failed to load particle data.")}}async function st(c){const e=await K(c);let t={},n=new Set,i=null;for(const o of e.split(`
`)){const a=o.trim();if(!(a.length===0||a.startsWith("#"))){if(a.startsWith("[")&&a.endsWith("]")){const d=a.slice(1,-1),r=parseInt(d,10);if(isNaN(r)||r<10){i=null;continue}if(n.has(r)){console.warn(`[Loader] Duplicate ID found: ${r}. Ignoring.`),i=null;continue}n.add(r),i=r,t[r]={};continue}if(i!==null){const d=a.split(":").map(r=>r.trim());if(d.length===2){const r=d[0],l=d[1],h=t[i];switch(r){case"name":h.name=l;break;case"category":h.category=parseInt(l,10);break;case"base_color":h.base_color=l;break;case"variant_color":h.variant_color=l;break;case"is_movable":h.is_movable=l==="true";break;case"density":h.density=parseFloat(l);break;case"max_concentration":h.max_concentration=parseInt(l);break;case"repose_angle":h.repose_angle=parseFloat(l);break}}}}}const s={};for(const o in t){const a=t[o],d=parseInt(o,10);if(a.name===void 0||a.category===void 0||a.base_color===void 0||a.variant_color===void 0||a.is_movable===void 0||a.density===void 0){console.warn(`[Loader] Corrupted particle block found of ID: ${d}. Missing core properties.`);continue}let r={id:d,name:a.name,baseColor:a.base_color,variantColor:a.variant_color,isMovable:a.is_movable,density:a.density};a.category===1?s[d]={...r,category:1}:a.category===2?s[d]={...r,maxConcentration:a.max_concentration,category:2}:a.category===3?s[d]={...r,category:3}:a.category===4?s[d]={...r,category:4,reposeAngle:a.repose_angle,reposeDirections:H.calculateRepose(a.repose_angle)}:a.category===5&&(s[d]={...r,category:5})}return s[0]={id:0,name:"Empty",category:0,baseColor:"#0E0E11",variantColor:"#0E0E11",isMovable:!0,density:0},s}async function ot(c){const e=await K(c),t={},n=e.split(/\r?\n/);for(const i of n){const s=i.trim();if(s.length===0||s.startsWith("#"))continue;const o=s.indexOf("."),a=s.indexOf(":");if(a===-1||o===-1||o>=a)continue;const d=s.substring(0,o).trim(),r=s.substring(o+1,a).trim(),l=s.substring(a+1).trim();if(!d||!r||l===void 0||l.length===0)continue;let h;if(d==="engine")switch(r){case"width":h=parseInt(l),isNaN(h)||(t.gameWidth=h);break;case"height":h=parseInt(l),isNaN(h)||(t.gameHeight=h);break;case"render_interval":h=parseFloat(l),isNaN(h)||(t.renderInterval=h);break;case"physics_interval":h=parseFloat(l),isNaN(h)||(t.physicsInterval=h);break}else if(d==="input")switch(r){case"brush_size":h=parseInt(l),isNaN(h)||(t.brushSize=h);break;case"brush_max_size":h=parseInt(l),isNaN(h)||(t.brushMaxSize=h);break;case"brush_sensitivity":h=parseFloat(l),isNaN(h)||(t.brushSensitivity=h);break}else if(d==="debug")switch(r){case"start_enabled":l.toLowerCase()==="true"?t.debugEnabled=!0:l.toLowerCase()==="false"&&(t.debugEnabled=!1);break;case"overlay_start_enabled":l.toLowerCase()==="true"?t.debugOverlayEnabled=!0:l.toLowerCase()==="false"&&(t.debugOverlayEnabled=!1);break}}return{gameWidth:t.gameWidth??342,gameHeight:t.gameHeight??192,renderInterval:t.renderInterval??16.667,physicsInterval:t.physicsInterval??25,brushSize:t.brushSize??4,brushMaxSize:t.brushMaxSize??42,brushSensitivity:t.brushSensitivity??.02,debugEnabled:t.debugEnabled??!1,debugOverlayEnabled:t.debugOverlayEnabled??!1}}class at{constructor(e,t){this.debugInstance=null,this.canvasElement=null,this.mouseX=0,this.mouseY=0,this.isLeftMouseButtonDown=!1,this.isRightMouseButtonDown=!1,this.isBrushOutlineVisible=!0,this.isInspectingParticle=!1,this.currentGrid=null,this.gameWidth=e.gameWidth,this.gameHeight=e.gameHeight,this.particleData=t,this.brushMaxSize=e.brushMaxSize,this.brushSensitivity=e.brushSensitivity,this.selectedParticleId=0,this.selectedCategoryId=2,this.renderInterval=e.renderInterval,this.physicsInterval=e.physicsInterval,this.currentBrushSize=e.brushSize}}async function rt(){try{const c=V("viewport",HTMLDivElement),e=V("render-surface",HTMLCanvasElement),t=await st("./src/data/particles.data");if(!t)throw new Error('Failed to load particle data from "./src/data/particles.data"');const n=await ot("./src/data/settings.data");if(!n)throw new Error('Failed to load settings from "./src/data/settings.data"');const i=new at(n,t);i.canvasElement=e;const s=new j(i,e),o=new nt(i,c,e),a=new it(i,c);a.enableDebug(!1),i.debugInstance=a,new tt(i,s,o,a).start(),console.log(t),dt(c)}catch(c){console.error("ERROR: Failed to initialize app:",c)}}function V(c,e){const t=document.getElementById(c);if(!(t instanceof e))throw new Error(`Missing or invalid <${e.name.toLowerCase()} id='${c}'> element in DOM.`);return t}rt();function dt(c){const e={x:80,y:80},t={width:380,height:600},n={width:800,height:1200},i=new B(c,"Demo Window",e,t,n);i.setVisibility(!1);const s=new W;s.addTitle("Emitter Controls");const o={width:300,height:100};s.addImage(o,"./assets/preview_image.jpg","Windows XP Background Image"),s.addText("Server Status: Source code loaded.","#4cae50"),s.addSeparator(1),s.addSection("Emitor Settings"),s.addSlider("Emitor Size",0,38,14,1),s.addSlider("Opacity",0,1,.9,.01),s.addToggleSwitch("Anti-aliasing"),s.addDropdownButton("GPU Render Mode",["Fastest","High Quality","Wireframe","Debug"]),s.addSeparator(1),s.addSection("Save & Load"),s.addButton("Save Emitor","save-emitor","#73a2e0ff"),s.addButton("Load Emitor","load-emitor","#84da62ff"),s.addButton("Delete Emitor","delete-emitor","#e04e4eff"),i.addNewContent(s.contentElement,"Emitor Controls","./assets/icons/electronics.svg");const a=new W;a.addTitle("Application Settings"),a.addSection("Display"),a.addDropdownButton("Theme",["Light","Dark","System Default","Cyan","party","Amogus","Sus","nerd","nerd2","nerd3"]),a.addSlider("Brightness",0,100,75,1),a.addToggleSwitch("Enable Animations"),a.addSeparator(1),a.addSection("Performance"),a.addDropdownButton("Render Backend",["Auto","WebGPU","WebGL"]),a.addToggleSwitch("Use Hardware Acceleration"),a.addSlider("Max FPS",30,240,120,10),a.addSeparator(1),a.addSection("System"),a.addButton("Reset Settings","reset-settings","#e04e4eff"),a.addButton("Check for Updates","check-updates"),i.addContentBarSeparator(!0),i.addNewContent(a.contentElement,"Settings","./assets/icons/settings.svg")}
