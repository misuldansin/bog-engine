var _t=l=>{throw TypeError(l)};var lt=(l,t,e)=>t.has(l)||_t("Cannot "+e);var d=(l,t,e)=>(lt(l,t,"read from private field"),e?e.call(l):t.get(l)),m=(l,t,e)=>t.has(l)?_t("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(l):t.set(l,e),p=(l,t,e,n)=>(lt(l,t,"write to private field"),n?n.call(l,e):t.set(l,e),e),P=(l,t,e)=>(lt(l,t,"access private method"),e);var ct=(l,t,e,n)=>({set _(i){p(l,t,i,e)},get _(){return d(l,t,n)}});(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=e(i);fetch(i.href,s)}})();const dt={GAME_WIDTH:342,GAME_HEIGHT:192,SELECTED_PARTICLE:10,SELECTED_CATEGORY:1,BRUSH_MAX_SIZE:42,BRUSH_CUR_SIZE:4,BRUSH_SENSITIVITY:.02,CURRENT_PRESSURE:0,CURRENT_CONCENTRATION:1,DEBUG_START_ENABLED:!0,DEBUG_OVERLAY_START_ENABLED:!1,RENDER_UPDATE_INTERVAL:16.667,PHYSICS_UPDATE_INTERVAL:25},Et={lerp(l,t,e){return l+(t-l)*e},shuffleArray(l){const t=[...l];for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t},calculateRepose(l){let t=Math.max(10,Math.min(l,80));const e=t*Math.PI/180;let n=[];if(n.push([{dx:0,dy:-1}]),t<50){n.push([{dx:1,dy:-1},{dx:-1,dy:-1}]);const i=Math.round(1/Math.tan(e));n.push([{dx:i,dy:-1},{dx:i*-1,dy:-1}])}else{const i=Math.round(Math.tan(e));n.push([{dx:1,dy:-i},{dx:-1,dy:-i}])}return n}};async function At(l){try{const t=await fetch(l);if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return await t.text()}catch(t){throw console.error(`Failed to read particle data from ${l}:`,t),new Error("Failed to load particle data.")}}async function Dt(l){const t=await At(l);let e={},n=new Set,i=null;for(const o of t.split(`
`)){const a=o.trim();if(!(a.length===0||a.startsWith("#"))){if(a.startsWith("[")&&a.endsWith("]")){const c=a.slice(1,-1),r=parseInt(c,10);if(isNaN(r)||r<10){i=null;continue}if(n.has(r)){console.warn(`[Loader] Duplicate ID found: ${r}. Ignoring.`),i=null;continue}n.add(r),i=r,e[r]={};continue}if(i!==null){const c=a.split(":").map(r=>r.trim());if(c.length===2){const r=c[0],h=c[1],u=e[i];switch(r){case"name":u.name=h;break;case"category":u.category=parseInt(h,10);break;case"base_color":u.base_color=h;break;case"variant_color":u.variant_color=h;break;case"is_movable":u.is_movable=h==="true";break;case"density":u.density=parseFloat(h);break;case"max_concentration":u.max_concentration=parseInt(h);break;case"repose_angle":u.repose_angle=parseFloat(h);break}}}}}const s={};for(const o in e){const a=e[o],c=parseInt(o,10);if(a.name===void 0||a.category===void 0||a.base_color===void 0||a.variant_color===void 0||a.is_movable===void 0||a.density===void 0){console.warn(`[Loader] Corrupted particle block found of ID: ${c}. Missing core properties.`);continue}let r={id:c,name:a.name,baseColor:a.base_color,variantColor:a.variant_color,isMovable:a.is_movable,density:a.density};a.category===1?s[c]={...r,category:1}:a.category===2?s[c]={...r,maxConcentration:a.max_concentration,category:2}:a.category===3?s[c]={...r,category:3}:a.category===4?s[c]={...r,category:4,reposeAngle:a.repose_angle,reposeDirections:Et.calculateRepose(a.repose_angle)}:a.category===5&&(s[c]={...r,category:5})}return s[0]={id:0,name:"Empty",category:0,baseColor:"#0E0E11",variantColor:"#0E0E11",isMovable:!0,density:0},s}var R,yt,wt,ht;class Mt{constructor(t,e){m(this,R);this._canvas=t,this._ctx=this._canvas.getContext("2d"),this._renderWidth=e.GAME_WIDTH,this._renderHeight=e.GAME_HEIGHT,this._frameBuffer=new Uint8ClampedArray(this._renderWidth*this._renderHeight*4),this._queuedParticles=[],this._queuedOverlayPixels=[],this._queuedUIPixels=[],this._canvas.width=this._renderWidth,this._canvas.height=this._renderHeight,this._ctx.imageSmoothingEnabled=!1,this._ctx.translate(0,this._canvas.height),this._ctx.scale(1,-1)}queueUIPixels(t){this._queuedUIPixels=[],this._queuedUIPixels=t}queueParticles(t,e){if(this._queuedParticles.push(...t),e){const n=this._renderWidth,i=this._renderHeight;for(const s of t){const a=(i-1-s.position.y)*n+s.position.x;this._queuedOverlayPixels.push({index:a,value:e})}}}queueOverlayPixels(t){this._queuedOverlayPixels.push(...t)}renderThisFrame(){P(this,R,yt).call(this);let t=new Uint8ClampedArray(this._frameBuffer);P(this,R,ht).call(this,t,this._queuedOverlayPixels),P(this,R,ht).call(this,t,this._queuedUIPixels);const e=new ImageData(t,this._renderWidth,this._renderHeight);this._ctx.putImageData(e,0,0),this._queuedParticles.length=0,this._queuedOverlayPixels=[],this._queuedUIPixels=[]}}R=new WeakSet,yt=function(){const t=this._queuedParticles,e=this._renderWidth,n=this._renderHeight;for(const i of t){const s=i.position.x,o=i.position.y,c=(n-1-o)*e+s;let r=P(this,R,wt).call(this,i);this._frameBuffer[c*4+0]=r[0],this._frameBuffer[c*4+1]=r[1],this._frameBuffer[c*4+2]=r[2],this._frameBuffer[c*4+3]=r[3]}},wt=function(t){return t.color},ht=function(t,e){for(const{index:n,value:i}of e){const s=t[n*4+0],o=t[n*4+1],a=t[n*4+2],c=t[n*4+3],r=i[0],h=i[1],u=i[2],E=i[3],_=E/255,g=Math.round(r*_+s*(1-_)),C=Math.round(h*_+o*(1-_)),v=Math.round(u*_+a*(1-_)),x=Math.min(c,E);t[n*4+0]=g,t[n*4+1]=C,t[n*4+2]=v,t[n*4+3]=x}};const mt=Object.freeze({WHITE:new Uint8ClampedArray([255,255,255,255]),BLACK:new Uint8ClampedArray([0,0,0,255]),GRAY:new Uint8ClampedArray([128,128,128,255]),RED:new Uint8ClampedArray([255,0,0,255]),GREEN:new Uint8ClampedArray([0,255,0,255]),BLUE:new Uint8ClampedArray([0,0,255,255]),YELLOW:new Uint8ClampedArray([255,255,0,255]),CYAN:new Uint8ClampedArray([0,255,255,255]),MAGENTA:new Uint8ClampedArray([255,0,255,255]),TRANSPARENT_BLACK:new Uint8ClampedArray([0,0,0,0]),SEMI_TRANSPARENT_WHITE:new Uint8ClampedArray([255,255,255,128])}),$={createColor(l){return this.hexToColor(l)},hexToColor(l){if(l==null)return mt.BLACK;let t=l.replace("#","");if(t.length===6)t+="FF";else if(t.length===3){let n="";for(const i of t)n+=i,n+=i;t=n+"FF"}else return mt.BLACK;const e=parseInt(t,16);return new Uint8ClampedArray([e>>24&255,e>>16&255,e>>8&255,e&255])},colorToHex(l){const[t,e,n,i]=l,s=o=>o.toString(16).padStart(2,"0");return`#${s(t)}${s(e)}${s(n)}${s(i)}`},lerpColor(l,t,e){const n=l[0]+(t[0]-l[0])*e,i=l[1]+(t[1]-l[1])*e,s=l[2]+(t[2]-l[2])*e,o=l[3]+(t[3]-l[3])*e;return new Uint8ClampedArray([n,i,s,o])},createColorRamp(l,t,e){if(e<2)return[l,t];const n=1/(e-1),i=new Array(e);for(let s=0;s<e;s++){const o=s*n;i[s]=this.lerpColor(l,t,o)}return i},invertColor(l){const t=255-l[0],e=255-l[1],n=255-l[2],i=l[3];return new Uint8ClampedArray([t,e,n,i])},getLuminance(l){const t=l[0],e=l[1],n=l[2];return .299*t+.587*e+.114*n}},Tt=Object.freeze({ALL_NEIGHBORS:[{dx:-1,dy:1},{dx:0,dy:1},{dx:1,dy:1},{dx:-1,dy:0},{dx:1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}]}),ot=Object.freeze({UP_LEFT:{dx:-1,dy:1},UP:{dx:0,dy:1},UP_RIGHT:{dx:1,dy:1},LEFT:{dx:-1,dy:0},RIGHT:{dx:1,dy:0},DOWN_LEFT:{dx:-1,dy:-1},DOWN:{dx:0,dy:-1},DOWN_RIGHT:{dx:1,dy:-1}});var S,N,Y,ut,Ct;class Rt{constructor(t,e,n){m(this,Y);m(this,S);m(this,N);this.width=t,this.height=e,p(this,S,new Array(t*e)),p(this,N,new Set),this.ParticleDataBlueprint=n,P(this,Y,Ct).call(this,0)}get data(){return d(this,S)}get dirtyParticles(){return d(this,N)}createParticleAt(t,e,n,i,s){if(!this.isInBounds(t,e))return!1;let o=P(this,Y,ut).call(this,n);return o.position.x=t,o.position.y=e,o.index=e*this.width+t,i&&this.markDirty(o,s),d(this,S)[e*this.width+t]=o,!0}getParticleAt(t,e){return this.isInBounds(t,e)?d(this,S)[e*this.width+t]:null}tryMoveParticle(t,e,n=!1,i=!1,s=!1){for(const o of e){if(!o)continue;const a=Et.shuffleArray(o);for(const c of a){let r=c.dx;n&&Math.random()>.5&&(r=c.dx*-1);const h=t.position.x+r,u=t.position.y+c.dy,E=this.getParticleAt(h,u);if(E&&E.isMovable&&t.density>E.density){d(this,S)[E.index]=t,d(this,S)[t.index]=E;const _={x:t.position.x,y:t.position.y},g=t.index;return t.position=E.position,t.index=E.index,E.position=_,E.index=g,i&&(this.markDirty(t,s),this.markDirty(E,s)),E}}}return null}swapParticles(t,e,n,i){d(this,S)[t.index]=e,d(this,S)[e.index]=t;const s={x:t.position.x,y:t.position.y},o=t.index;t.position=e.position,t.index=e.index,e.position=s,e.index=o,n&&(this.markDirty(t,i),this.markDirty(e,i))}getNeighborOf(t,e){const n=t.position.x+e.dx,i=t.position.y+e.dy;return this.getParticleAt(n,i)}getNeighborsOf(t,e,n,i){return e.map(o=>this.getNeighborOf(t,o)).filter(o=>o!==null).filter(o=>{const a=n===void 0||o.category===n,c=i===void 0||o.id===i;return a&&c})}markDirty(t,e){if(d(this,N).add(t.index),e){const n=this.getNeighborsOf(t,Tt.ALL_NEIGHBORS);for(const i of n)d(this,N).add(i.index)}}isInBounds(t,e){return t>=0&&t<this.width&&e>=0&&e<this.height}fillCircleAt(t,e,n,i){for(let s=-n;s<=n;s++)for(let o=-n;o<=n;o++){if(s*s+o*o>n*n)continue;const a=t+s,c=e+o;if(!this.isInBounds(a,c))continue;const r=this.getParticleAt(a,c);(i===0||r===null||r.id===0)&&this.createParticleAt(a,c,i,!0,!0)}}}S=new WeakMap,N=new WeakMap,Y=new WeakSet,ut=function(t){const e=this.ParticleDataBlueprint[t];if(!e)return null;let i=Math.random(),o=6-1,a=Math.round(i*o)/o;const c=$.hexToColor(e.baseColor),r=$.hexToColor(e.variantColor),h=$.lerpColor(c,r,a);let u={handle:-1,id:e.id,name:e.name,color:h,position:{x:-1,y:-1},index:0,isMovable:e.isMovable,density:e.density};return e.category===0?{...u,category:0}:e.category===1?{...u,category:1}:e.category===2?{...u,category:2,concentration:0,maxConcentration:e.maxConcentration}:e.category===3?{...u,category:3}:e.category===4?{...u,category:4,reposeAngle:e.reposeAngle,reposeDirections:e.reposeDirections}:e.category===5?{...u,category:5,node:-1}:null},Ct=function(t){const e=this.width,n=this.height;p(this,S,new Array(e*n));for(let i=0;i<n;i++)for(let s=0;s<e;s++){let o=i*e+s,a=P(this,Y,ut).call(this,t);a&&(a.position.x=s,a.position.y=i,a.index=o,d(this,S)[o]=a,d(this,N).add(a.index))}};const gt=Object.keys(ot);var W,it,X,nt,st,B,I,H,T,at,V,U,q,j,rt,K,D,xt,vt,Pt,Lt,It;class Ot{constructor(t,e,n,i,s){m(this,D);m(this,W);m(this,it);m(this,X);m(this,nt);m(this,st);m(this,B);m(this,I);m(this,H);m(this,T);m(this,at);m(this,V);m(this,U);m(this,q);m(this,j,0);m(this,rt,60);m(this,K,t=>{if(!d(this,H))return;if(!d(this,U)){p(this,U,t),p(this,T,requestAnimationFrame(d(this,K)));return}const e=t-d(this,U);p(this,U,t),d(this,it).processInput(d(this,B),d(this,W)),p(this,q,d(this,q)+e);let n=0;for(;d(this,q)>=d(this,V);){const i=[];for(const o of d(this,B).dirtyParticles)i.push(d(this,B).data[o]);ct(this,j)._++,d(this,j)>d(this,rt)&&(d(this,B).dirtyParticles.clear(),p(this,j,0));const s=new Uint8ClampedArray([210,55,55,180]);d(this,W).queueParticles(i,d(this,X).isOverlayEnabled?s:void 0),P(this,D,xt).call(this,i),this.tickCount++,p(this,q,d(this,q)-d(this,V)),n++,n>60&&p(this,q,0)}d(this,W).renderThisFrame(),d(this,X).updateDisplay(t,this),p(this,T,requestAnimationFrame(d(this,K)))});p(this,W,n),p(this,it,i),p(this,X,s),p(this,nt,e.GAME_WIDTH),p(this,st,e.GAME_HEIGHT),p(this,B,new Rt(d(this,nt),d(this,st),t)),p(this,I,new Set),p(this,H,!1),p(this,T,null),p(this,at,dt.RENDER_UPDATE_INTERVAL),p(this,V,dt.PHYSICS_UPDATE_INTERVAL),p(this,U,null),p(this,q,0),this.tickCount=0}start(){d(this,H)||(p(this,H,!0),d(this,K).call(this,0))}stop(){p(this,H,!1),d(this,T)&&(cancelAnimationFrame(d(this,T)),p(this,T,null))}groupParticles(t,e){const n=t.width,i=t.height,s=[],o=[],a={};for(let r=i-1;r>=0;r--)for(let h=0;h<n;h++){const u=r*n+h,E=t.getParticleAt(h,r);if(!E||E.category!==e||E.category!==e)continue;const _=t.getNeighborOf(E,ot.UP),g=t.getNeighborOf(E,ot.LEFT),C=_&&_.id===E.id,v=g&&g.id===E.id;let x=-1;v&&(x=r*n+(h-1));let y=-1;C&&(y=(r+1)*n+h);const w=_&&_.id===0;if(!v&&!C){const f=o.length;s.push([u]),o.push({liquidParticle:[],emptyParticle:[]}),w&&(o[f].liquidParticle.push(E),o[f].emptyParticle.push(_)),a[u]=f}else if(v&&!C){const f=a[x];s[f].push(u),w&&(o[f].liquidParticle.push(E),o[f].emptyParticle.push(_)),a[u]=f}else if(!v&&C){const f=a[y];s[f].push(u),w&&(o[f].liquidParticle.push(E),o[f].emptyParticle.push(_)),a[u]=f}else{const f=a[y];s[f].push(u),w&&(o[f].liquidParticle.push(E),o[f].emptyParticle.push(_)),a[u]=f;const L=a[x];if(L!==f){const G=o[L];for(const b of G.liquidParticle)o[f].liquidParticle.push(b);for(const b of G.emptyParticle)o[f].emptyParticle.push(b);const O=s[L];for(const b of O)a[b]=f;s[L]=[],o[L]={liquidParticle:[],emptyParticle:[]}}}}return o.filter(r=>r.liquidParticle.length>30)}}W=new WeakMap,it=new WeakMap,X=new WeakMap,nt=new WeakMap,st=new WeakMap,B=new WeakMap,I=new WeakMap,H=new WeakMap,T=new WeakMap,at=new WeakMap,V=new WeakMap,U=new WeakMap,q=new WeakMap,j=new WeakMap,rt=new WeakMap,K=new WeakMap,D=new WeakSet,xt=function(t){d(this,I).clear(),t=Et.shuffleArray(t),t.sort((n,i)=>n.position.y-i.position.y);for(const n of t)if(n&&!d(this,I).has(n.index))switch(n.category){case 1:break;case 2:P(this,D,vt).call(this,n);break;case 3:P(this,D,Pt).call(this,n);break;case 4:P(this,D,Lt).call(this,n);break;case 5:break;default:continue}let e=this.groupParticles(d(this,B),2);P(this,D,It).call(this,e)},vt=function(t){let e=[[{dx:0,dy:-1}],[{dx:-1,dy:-1},{dx:1,dy:-1}],[{dx:-1,dy:0},{dx:1,dy:0}]];const n=d(this,B).tryMoveParticle(t,e,!1,!0,!0);n&&(d(this,I).add(t.index),d(this,I).add(n.index))},Pt=function(t){const e=gt[Math.floor(Math.random()*gt.length)];let i=[[ot[e]]];const s=d(this,B).tryMoveParticle(t,i,!1,!0,!0);s&&(d(this,I).add(t.index),d(this,I).add(s.index))},Lt=function(t){let e=t.reposeDirections;const n=d(this,B).tryMoveParticle(t,e,!0,!0,!0);n&&(d(this,I).add(t.index),d(this,I).add(n.index))},It=function(t){for(const e of t){const n=e.liquidParticle.sort((c,r)=>r.position.y-c.position.y),i=e.emptyParticle.sort((c,r)=>c.position.y-r.position.y),s=n.length;let o=0;const a=s/4;for(let c=0;c<s;c++){const r=n[c],h=i[c];if(Math.sqrt(r.position.x*h.position.x+r.position.y*h.position.y),r.position.y>h.position.y&&(d(this,B).swapParticles(r,h,!0,!0),d(this,I).add(r.index),d(this,I).add(h.index),o++,o>=a))break}}};const et=class et{constructor(t,e,n,i,s){this.contentBarButtons=[],this.contents=[],this.selectedContent=0,this._onFocus=()=>{this._isFocused||(et.currentZIndex++,this._windowEl.style.zIndex=et.currentZIndex.toString())},this._onPointerDown=o=>{if(o.stopPropagation(),this._onFocus(),o.button===0){this._titlebarEl.setPointerCapture(o.pointerId);const a=this._windowEl.getBoundingClientRect();this._dragOffset.x=o.clientX-a.left,this._dragOffset.y=o.clientY-a.top,this._isDragging=!0}else this._isDragging=!1},this._onPointerUp=o=>{this._isDragging&&(this._titlebarEl.releasePointerCapture(o.pointerId),this._isDragging=!1)},this._onPointerMove=o=>{if(this._isDragging){const a=o.clientX-this._dragOffset.x,c=o.clientY-this._dragOffset.y;this._moveWindow({x:a,y:c})}},this._onCloseButtonClick=o=>{this._closeWindow()},this._onViewportResize=()=>{this._snapWindowBacc()},this._stopDragPropagation=o=>{o.stopPropagation()},this.hostEl=t,this.title=e,this.position=n,this.size=i,this.maxSize=s,this._isFocused=!1,this._isDragging=!1,this._dragOffset={x:0,y:0},this._initWindow(e,n),this._addEventListener(),this._onFocus()}destroy(){this._closeWindow()}_initWindow(t,e){this._windowEl=document.createElement("div"),this._windowEl.classList.add("ui-window"),this._windowEl.style.left=`${e.x}px`,this._windowEl.style.top=`${e.y}px`,this._windowEl.style.width=`${this.size.width}px`,this._windowEl.style.height=`${this.size.height}px`,this._windowEl.style.maxWidth=`${this.maxSize.width}px`,this._windowEl.style.maxHeight=`${this.maxSize.height}px`,this.hostEl.appendChild(this._windowEl),this._titlebarEl=document.createElement("div"),this._titlebarEl.classList.add("ui-window__titlebar");const n=document.createElement("span");n.classList.add("ui-window__title"),n.textContent=t,this._titlebarEl.appendChild(n),this._windowEl.appendChild(this._titlebarEl);const i=document.createElement("div");i.classList.add("ui-window__controls"),this._closeButtonEl=document.createElement("button"),this._closeButtonEl.classList.add("ui-window__title-button");const s=document.createElement("img");s.src="./assets/icons/close.svg",this._closeButtonEl.appendChild(s),i.appendChild(this._closeButtonEl),this._titlebarEl.appendChild(i),this._contentAreaEl=document.createElement("div"),this._contentAreaEl.classList.add("ui-window__content-area"),this._contentAreaEl.style.flexDirection="row",this._windowEl.appendChild(this._contentAreaEl),this._contentBarEl=document.createElement("div"),this._contentBarEl.classList.add("ui-window__category-strip","strip-left"),this._contentAreaEl.appendChild(this._contentBarEl),this._contentContainer=document.createElement("div"),this._contentContainer.classList.add("ui-window__content-container"),this._contentAreaEl.appendChild(this._contentContainer)}_addEventListener(){this._windowEl.addEventListener("mousedown",this._onFocus),this._titlebarEl.addEventListener("pointerdown",this._onPointerDown),this._titlebarEl.addEventListener("pointermove",this._onPointerMove),this._titlebarEl.addEventListener("pointerup",this._onPointerUp),this._closeButtonEl.addEventListener("click",this._onCloseButtonClick),this._closeButtonEl.addEventListener("pointerdown",this._stopDragPropagation),window.addEventListener("resize",this._onViewportResize)}_closeWindow(){window.removeEventListener("resize",this._onViewportResize),this._titlebarEl.removeEventListener("pointerdown",this._onPointerDown),this._titlebarEl.removeEventListener("pointermove",this._onPointerMove),this._titlebarEl.removeEventListener("pointerup",this._onPointerUp),this._windowEl.removeEventListener("mousedown",this._onFocus),this._windowEl&&this._windowEl.parentElement&&this._windowEl.parentElement.removeChild(this._windowEl),this._windowEl=null,this._titlebarEl=null,this._closeButtonEl=null,this._contentBarEl=null,this._contentAreaEl=null}_moveWindow(t){const e=this._windowEl.offsetWidth,n=this._windowEl.offsetHeight,i=Math.max(0,Math.min(t.x,window.innerWidth-e)),s=Math.max(0,Math.min(t.y,window.innerHeight-n));this._windowEl.style.left=`${i}px`,this._windowEl.style.top=`${s}px`}_snapWindowBacc(){const t=this._windowEl.offsetWidth,e=this._windowEl.offsetHeight,n=Math.max(0,window.innerWidth-t),i=Math.max(0,window.innerHeight-e),s=this._windowEl.offsetLeft,o=this._windowEl.offsetTop,a=Math.max(0,Math.min(s,n)),c=Math.max(0,Math.min(o,i));(a!==s||c!==o)&&(this._windowEl.style.left=`${a}px`,this._windowEl.style.top=`${c}px`)}displayContent(t){const e=this.contents[t];e&&(this.contents.forEach((n,i)=>{n.style.display="none"}),e.style.display="",this.selectedContent=t,this.contentBarButtons.forEach((n,i)=>{i===t?n.classList.add("active"):n.classList.remove("active")}))}addContentBarDivider(){const t=document.createElement("div");return t.classList.add("ui-flex-divider"),this._contentBarEl.appendChild(t),t}addContentBarSpacer(){const t=document.createElement("div");return t.classList.add("ui-flex-spacer"),this._contentBarEl.appendChild(t),t}addNewContent(t,e,n){let i=this.contents.length;this.contents.length!==0&&(t.style.display="none"),t.id="container-"+i,this._contentContainer.appendChild(t);const s=document.createElement("button");s.classList.add("ui-window__category-button"),s.title=e,this._contentBarEl.appendChild(s);const o=document.createElement("img");o.classList.add("ui-window__category-icon"),o.alt=e,o.src=n,s.appendChild(o),s.addEventListener("click",()=>this.displayContent(i)),this.contents.length>0&&(this._contentBarEl.style.display="flex"),this.contentBarButtons.push(s),this.contents.push(t)}setContentOrientation(t){t==="left"||t==="top"?(this._contentAreaEl.appendChild(this._contentBarEl),this._contentAreaEl.appendChild(this._contentContainer)):(this._contentAreaEl.appendChild(this._contentContainer),this._contentAreaEl.appendChild(this._contentBarEl)),t==="left"||t==="right"?this._contentAreaEl.style.flexDirection="row":this._contentAreaEl.style.flexDirection="column",this._contentBarEl.classList.forEach(e=>{e.startsWith("strip-")&&this._contentBarEl.classList.remove(e)}),this._contentBarEl.classList.add("ui-window__category-strip",`strip-${t}`)}};et.currentZIndex=100;let pt=et;class Nt{constructor(){this.contentElement=document.createElement("div"),this.contentElement.classList.add("ui-window__content")}addDivider(){const t=document.createElement("div");return t.classList.add("ui-window__divider"),this.contentElement.appendChild(t),t}addSpacer(t=1){const e=document.createElement("div");return e.classList.add("ui-window__spacer"),e.style.height=`${t}px`,this.contentElement.appendChild(e),e}addTitle(t){const e=document.createElement("h3");return e.classList.add("ui-title"),e.textContent=t,this.contentElement.appendChild(e),e}addSection(t){const e=document.createElement("h4");return e.classList.add("ui-section"),e.textContent=t,this.contentElement.appendChild(e),e}addText(t,e,n,i){const s=document.createElement("p");return s.classList.add("ui-text"),s.textContent=t,e!=null&&(s.style.color=e),i!=null&&(s.id=i),n!=null&&(s.style.fontWeight=n),this.contentElement.appendChild(s),s}addLink(t,e,n){const i=document.createElement("p");i.classList.add("ui-text"),n!=null&&(i.id=n);const s=document.createElement("a");return s.href=e,s.textContent=t,s.target="_blank",i.appendChild(s),this.contentElement.appendChild(i),i}addBulletedList(t){const e=document.createElement("ul");return e.classList.add("ui-text"),t.forEach(n=>{const i=document.createElement("li");i.textContent=n,e.appendChild(i)}),this.contentElement.appendChild(e),e}addNumberedList(t){const e=document.createElement("ol");return e.classList.add("ui-text"),t.forEach(n=>{const i=document.createElement("li");i.textContent=n,e.appendChild(i)}),this.contentElement.appendChild(e),e}addImage(t,e,n,i){const s=document.createElement("img");return s.classList.add("ui-image"),s.src=e,s.alt=n,s.width=t.width,s.height=t.height,i!=null&&(s.id=i),this.contentElement.appendChild(s),s}addSlider(t,e,n,i,s,o){const a=document.createElement("div");a.classList.add("flex-row"),o!=null&&(a.id=o);const c=document.createElement("label");c.textContent=t+":",a.appendChild(c);const r=document.createElement("input");r.type="range",r.min=e.toString(),r.max=n.toString(),r.value=i.toString(),r.step=s.toString(),o!=null&&(r.id=o+"-range"),a.appendChild(r);const h=document.createElement("input");return h.style.minWidth="40px",h.type="number",h.min=e.toString(),h.max=n.toString(),h.value=i.toString(),h.step=s.toString(),o!=null&&(h.id=o+"-number"),a.appendChild(h),r.oninput=()=>h.value=r.value,h.onchange=()=>{const u=Math.max(e,Math.min(n,parseInt(h.value))).toString();r.value=u,h.value=u},this.contentElement.appendChild(a),a}addTextInput(t,e,n,i){const s=document.createElement("div");s.classList.add("flex-row","ui-text-input-container");const o=document.createElement("label");o.textContent=t+":",s.appendChild(o);const a=document.createElement("input");return a.type="text",a.placeholder=e,a.value=n,i!=null&&(a.id=i),s.appendChild(a),this.contentElement.appendChild(s),s}addButton(t,e,n){const i=document.createElement("button");return i.classList.add("ui-window__content__Button"),i.textContent=t,e!=null&&(i.id=e),n!=null&&(i.style.backgroundColor=n),this.contentElement.appendChild(i),i}addDropdownButton(t,e,n){const i=document.createElement("div");i.classList.add("flex-row");const s=document.createElement("label");s.textContent=t+":",i.appendChild(s);const o=document.createElement("div");o.classList.add("custom-dropdown-container"),i.appendChild(o);const a=document.createElement("div");a.classList.add("dropdown-button");const c=document.createElement("span");c.textContent=e[0]?e[0]:"Template Item",n!=null&&(c.id=`${n}-display`),a.appendChild(c),o.appendChild(a);const r=document.createElement("ul");r.classList.add("dropdown-list"),n!=null&&(r.id=`${n}-list`),o.appendChild(r);let h=0;const u=[];for(let E=0;E<e.length;E++){const _=e[E],g=document.createElement("li");g.style.marginBottom="0px",g.classList.add("dropdown-item"),g.textContent=_,g.dataset.index=E.toString(),g.dataset.value=_.toLowerCase().replace(/\s/g,"-"),E===h&&g.classList.add("is-selected"),g.addEventListener("click",C=>{C.stopPropagation(),u[h].classList.remove("is-selected"),h=E,g.classList.add("is-selected"),c.textContent=_,r.classList.remove("is-open")}),r.appendChild(g),u.push(g)}return a.addEventListener("click",E=>{if(E.stopPropagation(),r.classList.toggle("is-open")){const g=a.getBoundingClientRect(),C=r.querySelectorAll(".dropdown-item"),v=r.querySelector(".dropdown-item.is-selected");if(v){const x=v.getBoundingClientRect();r.getBoundingClientRect();const y=g.height,w=x.height,L=Array.from(C).indexOf(v)*w+6;r.style.transform="none",r.style.top=`${y-L-w}px`,r.scrollTop=L}}}),this.contentElement.appendChild(i),a}addToggleSwitch(t,e=!1,n){const i=document.createElement("div");i.classList.add("flex-row");const s=document.createElement("label");s.textContent=t+":",i.appendChild(s);const o=document.createElement("div");o.classList.add("toggle-container"),i.appendChild(o);const a=document.createElement("div");a.classList.add("toggle-switch"),a.dataset.state=e?"on":"off",e&&a.classList.add("is-on"),n!=null&&(a.id=n+"-switch"),o.appendChild(a);const c=document.createElement("span");c.classList.add("toggle-indicator","indicator-o"),c.textContent="O",a.appendChild(c);const r=document.createElement("span");r.classList.add("toggle-indicator","indicator-i"),r.textContent="I",a.appendChild(r);const h=document.createElement("div");return h.classList.add("toggle-slider"),a.appendChild(h),a.addEventListener("click",()=>{const u=a.classList.toggle("is-on");a.dataset.state=u?"on":"off"}),this.contentElement.appendChild(i),a}}class Ht{constructor(t,e,n,i,s){this._onPointerDown=o=>{this._activePointerId=o.pointerId,o.button===0?(this.isPainting=!0,this.isErasing=!1,this.activeButton="left"):o.button===2?(this.isErasing=!0,this.isPainting=!1,this.activeButton="right"):(this.isPainting=!1,this.isErasing=!1,this.activeButton="none");try{this._canvas.setPointerCapture(o.pointerId)}catch{}const a=this._canvas.getBoundingClientRect(),c=this._width/a.width,r=this._height/a.height;this.latestMouseCoords.x=(o.clientX-a.left)*c,this.latestMouseCoords.y=this._canvas.height-(o.clientY-a.top)*r},this._onPointerUp=o=>{if(this._activePointerId===o.pointerId){this._activePointerId=null,this.activeButton="none";try{this._canvas.releasePointerCapture(o.pointerId)}catch{}}this.isPainting=!1,this.isErasing=!1},this._onPointerMove=o=>{const a=this._canvas.getBoundingClientRect(),c=this._width/a.width,r=this._canvas.height/a.height;if(this.latestMouseCoords.x=(o.clientX-a.left)*c,this.latestMouseCoords.y=this._canvas.height-(o.clientY-a.top)*r,typeof o.buttons=="number"){const h=(o.buttons&1)===1,u=(o.buttons&2)===2;this.isPainting=h,this.isErasing=u}},this._onPointerCancel=o=>{if(this.isPainting=!1,this.isErasing=!1,this._activePointerId===o.pointerId){try{this._canvas.releasePointerCapture(o.pointerId)}catch{}this._activePointerId=null,this.activeButton="none"}},this._onWindowPointerUp=()=>{this.isPainting=!1,this.isErasing=!1,this._activePointerId=null,this.activeButton="none"},this._onVisibilityChange=()=>{document.hidden&&(this.isPainting=!1,this.isErasing=!1,this._activePointerId=null,this.activeButton="none")},this._onWheel=o=>{o.preventDefault(),this.shouldChangeBrushSize=!0,this.changeBrushSizeDir=o.deltaY},this._onContextMenu=o=>{o.preventDefault()},this._onPointerEnter=()=>{this.isDrawingOverlay=!0},this._onPointerLeave=()=>{this.isDrawingOverlay=!1},this._mainContainer=e,this._canvas=n,this._renderer=s,this._width=i.GAME_WIDTH,this._height=i.GAME_HEIGHT,this._brushSizeSensitivity=i.BRUSH_SENSITIVITY,this._maxBrushSize=i.BRUSH_MAX_SIZE,this._selectedParticle=i.SELECTED_PARTICLE,this._selectedCategory=i.SELECTED_CATEGORY,this._currentBrushSize=i.BRUSH_CUR_SIZE,this._currentPressure=i.CURRENT_PRESSURE,this._currentConcentration=i.CURRENT_CONCENTRATION,this._activePointerId=null,this.isPainting=!1,this.isErasing=!1,this.isDrawingOverlay=!0,this.shouldChangeBrushSize=!1,this.changeBrushSizeDir=0,this.latestMouseCoords={x:0,y:0},this.activeButton="none",this._addEventListeners(),this._addParticlePaletteWindow(t)}processInput(t,e){const n=this.latestMouseCoords.x,i=this.latestMouseCoords.y,s={x:Math.floor(n),y:Math.floor(i)};if(this.isDrawingOverlay){const o=this._calculateBrushOutline(s.x,s.y);e.queueUIPixels(o)}if(this.isPainting||this.isErasing){const o=s.x<this._width+this._currentBrushSize&&s.x>=0-this._currentBrushSize,a=s.y<this._height+this._currentBrushSize&&s.y>=0-this._currentBrushSize;if(o&&a){const c=s.x,r=s.y,h=this.isPainting?this._selectedParticle:0;t.fillCircleAt(c,r-1,this._currentBrushSize,h)}}if(this.shouldChangeBrushSize){const o=this.changeBrushSizeDir*this._brushSizeSensitivity;let a=this._currentBrushSize-o;a=Math.floor(a),a=Math.min(this._maxBrushSize,a),a=Math.max(0,a),this._currentBrushSize=a,this.changeBrushSizeDir=0}}_addEventListeners(){const t=this._canvas;t.addEventListener("pointerdown",this._onPointerDown),t.addEventListener("pointermove",this._onPointerMove),t.addEventListener("pointerup",this._onPointerUp),t.addEventListener("pointercancel",this._onPointerCancel),t.addEventListener("lostpointercapture",this._onPointerCancel),t.addEventListener("pointerenter",this._onPointerEnter),t.addEventListener("pointerleave",this._onPointerLeave),t.addEventListener("focus",this._onPointerEnter),t.addEventListener("blur",this._onPointerLeave),t.addEventListener("wheel",this._onWheel,{passive:!1}),this._mainContainer.addEventListener("contextmenu",this._onContextMenu),window.addEventListener("pointerup",this._onWindowPointerUp),window.addEventListener("mouseup",this._onWindowPointerUp),document.addEventListener("visibilitychange",this._onVisibilityChange)}_addParticlePaletteWindow(t){const e={x:320,y:300},n={width:250,height:200},i={width:420,height:400},s=new pt(this._mainContainer,"Particle Palette",e,n,i);s.setContentOrientation("bottom");const o=document.createElement("div");o.classList.add("particle-palette-container"),s.addNewContent(o,"Solids","./assets/icons/solid.svg");const a=document.createElement("div");a.classList.add("particle-palette-container"),s.addNewContent(a,"Liquids","./assets/icons/liquid.svg");const c=document.createElement("div");c.classList.add("particle-palette-container"),s.addNewContent(c,"Gases","./assets/icons/gas.svg");const r=document.createElement("div");r.classList.add("particle-palette-container"),s.addNewContent(r,"Sands","./assets/icons/sand.svg");const h=document.createElement("div");h.classList.add("particle-palette-container"),s.addNewContent(h,"Electronics","./assets/icons/electronics.svg");const u=new Nt;s.addContentBarSpacer(),s.addNewContent(u.contentElement,"Settings","./assets/icons/settings.svg");const E=2,_=E-1;s.displayContent(_),this._selectedCategory=E;const g=s.contentBarButtons,C=s.contents;for(let x=0;x<g.length-1;x++)g[x].addEventListener("click",()=>{for(const w of C){const f=w.querySelector(".selected");f&&f.classList.remove("selected")}const y=C[x];if(y){const w=y.querySelector(".particle-button");w&&(w.classList.add("selected"),this._selectedParticle=parseInt(w.dataset.particleId||"-1",10),this._selectedCategory=parseInt(w.dataset.category||"-1",10))}});let v=!1;for(const x in t){const y=t[x];if(!y)continue;const w=C[y.category-1];if(!w)continue;const f=y.baseColor,L=y.variantColor,O=$.getLuminance($.hexToColor(f))>210?"#323238":"#FFFFFFFF",b=$.hexToColor(O),A=document.createElement("button");A.className="particle-button",A.textContent=y.name,A.style.setProperty("--particle-button-base-color",f),A.style.setProperty("--particle-button-variant-color",L),A.style.color=O,A.style.textShadow=`1px 1px 2px rgba(${b[0]}, ${b[1]}, ${b[2]}, 0.6)`,A.dataset.particleId=y.id.toString(),A.dataset.category=y.category.toString(),A.addEventListener("click",()=>{for(const Bt of C){const ft=Bt.querySelector(".selected");ft&&ft.classList.remove("selected")}A.classList.add("selected"),this._selectedParticle=y.id,this._selectedCategory=y.category}),w.appendChild(A),!v&&y.category===this._selectedCategory&&(A.classList.add("selected"),this._selectedParticle=y.id,v=!0)}}_calculateBrushOutline(t,e){const n=this._currentBrushSize,i=[],s=227,o=227,a=227,c=180,r=this._width,h=this._height,u=[-1,1],E=(v,x)=>{for(const y of u)for(const w of u){const f=t+v*w,L=e+x*y,G=t+x*w,O=e+v*y;if(f>=0&&f<r&&L>=0&&L<h){const b=(h-L)*r+f;i.push({index:b,value:new Uint8ClampedArray([s,o,a,c])})}if(G>=0&&G<r&&O>=0&&O<h){const b=(h-O)*r+G;i.push({index:b,value:new Uint8ClampedArray([s,o,a,c])})}}};let _=n,g=0,C=n-n;for(E(_,g);g<_;)g++,C<0?C+=2*g+1:(_--,C+=2*(g-_)+1),E(_,g);return i}}var F,z,M,k,Z,J,Q,tt,bt,St;class Ut{constructor(t){m(this,tt);m(this,F);m(this,z);m(this,M);m(this,k);m(this,Z);m(this,J);m(this,Q);p(this,F,!1),p(this,z,!1),p(this,M,new Map),p(this,k,0),p(this,Z,0),p(this,J,0),p(this,Q,0),P(this,tt,St).call(this,t)}get isOverlayEnabled(){return d(this,z)}enableDebug(t){p(this,F,!0),t&&p(this,z,!0)}disableDebug(){p(this,F,!1),p(this,z,!1)}updateDisplay(t,e){if(!d(this,F))return;P(this,tt,bt).call(this,t,e);const n=d(this,M).get("fps");n&&(n.textContent=`FPS: ${d(this,Z).toFixed(2)}`);const i=d(this,M).get("tps");i&&(i.textContent=`TPS: ${d(this,J).toFixed(2)}`)}}F=new WeakMap,z=new WeakMap,M=new WeakMap,k=new WeakMap,Z=new WeakMap,J=new WeakMap,Q=new WeakMap,tt=new WeakSet,bt=function(t,e){const n=t-d(this,Q);n>=1e3&&(p(this,Z,d(this,k)*1e3/n),p(this,J,e.tickCount*1e3/n),p(this,k,0),e.tickCount=0,p(this,Q,t)),ct(this,k)._++},St=function(t){const e=document.createElement("div");e.classList.add("debug-container"),t.appendChild(e),d(this,M).set("debug-container",e);const n=document.createElement("div");n.classList.add("debug-info-container"),e.appendChild(n),d(this,M).set("info-container",n);const i=document.createElement("div");i.classList.add("debug-info"),n.appendChild(i),d(this,M).set("fps",i);const s=document.createElement("div");s.classList.add("debug-info"),n.appendChild(s),d(this,M).set("tps",s)};async function qt(){try{let l=dt;const t=400,e=40,n=1e3,i=4;l.GAME_WIDTH=Math.max(e,Math.min(t,l.GAME_WIDTH)),l.GAME_HEIGHT=Math.max(e,Math.min(t,l.GAME_HEIGHT)),l.PHYSICS_UPDATE_INTERVAL=Math.max(i,Math.min(n,l.PHYSICS_UPDATE_INTERVAL)),Object.freeze(l);const s=document.getElementById("main-canvas");if(!(s instanceof HTMLCanvasElement))throw new Error("HTML element 'main-canvas' does not exist.");const o=document.getElementById("main-panel");if(!(o instanceof HTMLDivElement))throw new Error("HTML element 'main-panel' does not exist.");s.style.aspectRatio=(l.GAME_WIDTH/l.GAME_HEIGHT).toString();const a=new Mt(s,l),c=await Dt("./src/data/particles.data"),r=new Ht(c,o,s,l,a),h=new Ut(o);h.enableDebug(!1),new Ot(c,l,a,r,h).start(),console.log(c)}catch(l){console.error("ERROR: Failed to initialize engine due to data loading failure.",l)}}qt();
