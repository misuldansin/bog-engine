(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();const m=Object.freeze({GAME_WIDTH:200,GAME_HEIGHT:150,SELECTED_PARTICLE:10,SELECTED_CATEGORY:1,BRUSH_MAX_SIZE:24,BRUSH_CUR_SIZE:4,BRUSH_SENSITIVITY:.02,CURRENT_PRESSURE:0,CURRENT_CONCENTRATION:1,DEBUG_START_ENABLED:!0,DEBUG_OVERLAY_START_ENABLED:!1,RENDER_UPDATE_INTERVAL:15,PHYSICS_UPDATE_INTERVAL:15}),I={lerp(a,t,e){return a+(t-a)*e},shuffleArray(a){const t=[...a];for(let e=t.length-1;e>0;e--){const i=Math.floor(Math.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}return t},calculateRepose(a){let t=Math.max(10,Math.min(a,80));const e=t*Math.PI/180;let i=[];if(i.push([{dx:0,dy:-1}]),t<50){i.push([{dx:1,dy:-1},{dx:-1,dy:-1}]);const s=Math.round(1/Math.tan(e));i.push([{dx:s,dy:-1},{dx:s*-1,dy:-1}])}else{const s=Math.round(Math.tan(e));i.push([{dx:1,dy:-s},{dx:-1,dy:-s}])}return i}};async function L(a){try{const t=await fetch(a);if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return await t.text()}catch(t){throw console.error(`Failed to read particle data from ${a}:`,t),new Error("Failed to load particle data.")}}async function T(a){const t=await L(a);let e={},i=new Set,s=null;for(const r of t.split(`
`)){const o=r.trim();if(!(o.length===0||o.startsWith("#"))){if(o.startsWith("[")&&o.endsWith("]")){const l=o.slice(1,-1),c=parseInt(l,10);if(isNaN(c)||c<10){s=null;continue}if(i.has(c)){console.warn(`[Loader] Duplicate ID found: ${c}. Ignoring.`),s=null;continue}i.add(c),s=c,e[c]={};continue}if(s!==null){const l=o.split(":").map(c=>c.trim());if(l.length===2){const c=l[0],d=l[1],h=e[s];switch(c){case"name":h.name=d;break;case"category":h.category=parseInt(d,10);break;case"base_color":h.base_color=d;break;case"variant_color":h.variant_color=d;break;case"is_movable":h.is_movable=d==="true";break;case"density":h.density=parseFloat(d);break;case"max_concentration":h.max_concentration=parseInt(d);break;case"repose_angle":h.repose_angle=parseFloat(d);break}}}}}const n={};for(const r in e){const o=e[r],l=parseInt(r,10);if(o.name===void 0||o.category===void 0||o.base_color===void 0||o.variant_color===void 0||o.is_movable===void 0||o.density===void 0){console.warn(`[Loader] Corrupted particle block found of ID: ${l}. Missing core properties.`);continue}let c={id:l,name:o.name,baseColor:o.base_color,variantColor:o.variant_color,isMovable:o.is_movable,density:o.density};o.category===1?n[l]={...c,category:1}:o.category===2?n[l]={...c,maxConcentration:o.max_concentration,category:2}:o.category===3?n[l]={...c,category:3}:o.category===4?n[l]={...c,category:4,reposeAngle:o.repose_angle,reposeDirections:I.calculateRepose(o.repose_angle)}:o.category===5&&(n[l]={...c,category:5})}return n[0]={id:0,name:"Empty",category:0,baseColor:"#0E0E11",variantColor:"#0E0E11",isMovable:!0,density:0},n}class M{#t;#e;#s;#o;#i;#n;#r;constructor(t,e,i){this.#t=i,this.#e=this.#t.getContext("2d"),this.#s=t,this.#o=e,this.#i=new Uint8ClampedArray(this.#s*this.#o*4),this.#n=[],this.#r=new Map,this.#t.width=this.#s,this.#t.height=this.#o,this.#e.imageSmoothingEnabled=!1,this.#e.translate(0,this.#t.height),this.#e.scale(1,-1)}queueParticles(t,e){if(this.#n.push(...t),e){const i=this.#s,s=this.#o;for(const n of t){const o=(s-1-n.position.y)*i+n.position.x;this.#r.set(o,e)}}}queueOverlayPixels(t){for(const e of t)this.#r.set(e.index,e.value)}renderThisFrame(){this.#d();let t=new Uint8ClampedArray(this.#i);this.#l(t);const e=new ImageData(t,this.#s,this.#o);this.#e.putImageData(e,0,0),this.#n.length=0,this.#r.clear()}#d(){const t=this.#n,e=this.#s,i=this.#o;for(const s of t){const n=s.position.x,r=s.position.y,l=(i-1-r)*e+n;let c=this.#a(s);this.#i[l*4+0]=c[0],this.#i[l*4+1]=c[1],this.#i[l*4+2]=c[2],this.#i[l*4+3]=c[3]}}#a(t){return t.color}#l(t){const e=this.#r;if(e.size!==0)for(const[i,s]of e){const n=t[i*4+0],r=t[i*4+1],o=t[i*4+2],l=t[i*4+3],c=s[0],d=s[1],h=s[2],u=s[3],f=u/255,p=Math.round(c*f+n*(1-f)),y=Math.round(d*f+r*(1-f)),E=Math.round(h*f+o*(1-f)),C=Math.min(l,u);t[i*4+0]=p,t[i*4+1]=y,t[i*4+2]=E,t[i*4+3]=C}}}const D=Object.freeze({WHITE:new Uint8ClampedArray([255,255,255,255]),BLACK:new Uint8ClampedArray([0,0,0,255]),GRAY:new Uint8ClampedArray([128,128,128,255]),RED:new Uint8ClampedArray([255,0,0,255]),GREEN:new Uint8ClampedArray([0,255,0,255]),BLUE:new Uint8ClampedArray([0,0,255,255]),YELLOW:new Uint8ClampedArray([255,255,0,255]),CYAN:new Uint8ClampedArray([0,255,255,255]),MAGENTA:new Uint8ClampedArray([255,0,255,255]),TRANSPARENT_BLACK:new Uint8ClampedArray([0,0,0,0]),SEMI_TRANSPARENT_WHITE:new Uint8ClampedArray([255,255,255,128])}),g={createColor(a){return this.hexToColor(a)},hexToColor(a){if(a==null)return D.BLACK;let t=a.replace("#","");if(t.length===6)t+="FF";else if(t.length===3){let i="";for(const s of t)i+=s,i+=s;t=i+"FF"}else return D.BLACK;const e=parseInt(t,16);return new Uint8ClampedArray([e>>24&255,e>>16&255,e>>8&255,e&255])},colorToHex(a){const[t,e,i,s]=a,n=r=>r.toString(16).padStart(2,"0");return`#${n(t)}${n(e)}${n(i)}${n(s)}`},lerpColor(a,t,e){const i=a[0]+(t[0]-a[0])*e,s=a[1]+(t[1]-a[1])*e,n=a[2]+(t[2]-a[2])*e,r=a[3]+(t[3]-a[3])*e;return new Uint8ClampedArray([i,s,n,r])},createColorRamp(a,t,e){if(e<2)return[a,t];const i=1/(e-1),s=new Array(e);for(let n=0;n<e;n++){const r=n*i;s[n]=this.lerpColor(a,t,r)}return s},invertColor(a){const t=255-a[0],e=255-a[1],i=255-a[2],s=a[3];return new Uint8ClampedArray([t,e,i,s])},getLuminance(a){const t=a[0],e=a[1],i=a[2];return .299*t+.587*e+.114*i}},_=Object.freeze({ALL_NEIGHBORS:[{dx:-1,dy:1},{dx:0,dy:1},{dx:1,dy:1},{dx:-1,dy:0},{dx:1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}]});class R{#t;#e;constructor(t,e,i){this.width=t,this.height=e,this.#t=new Array(t*e),this.#e=new Set,this.ParticleDataBlueprint=i,this.#o(0)}get data(){return this.#t}get dirtyParticles(){return this.#e}#s(t){const e=this.ParticleDataBlueprint[t];if(!e)return null;let s=Math.random(),r=6-1,o=Math.round(s*r)/r;const l=g.hexToColor(e.baseColor),c=g.hexToColor(e.variantColor),d=g.lerpColor(l,c,o);let h={handle:-1,id:e.id,name:e.name,color:d,position:{x:-1,y:-1},index:0,isMovable:e.isMovable,density:e.density};return e.category===0?{...h,category:0}:e.category===1?{...h,category:1}:e.category===2?{...h,category:2,concentration:0,maxConcentration:e.maxConcentration}:e.category===3?{...h,category:3}:e.category===4?{...h,category:4,reposeAngle:e.reposeAngle,reposeDirections:e.reposeDirections}:e.category===5?{...h,category:5,node:-1}:null}#o(t){const e=this.width,i=this.height;this.#t=new Array(e*i);for(let s=0;s<i;s++)for(let n=0;n<e;n++){let r=s*e+n,o=this.#s(t);o&&(o.position.x=n,o.position.y=s,o.index=r,this.#t[r]=o,this.#e.add(o))}}createParticleAt(t,e,i,s,n){if(!this.isInBounds(t,e))return!1;let r=this.#s(i);return r.position.x=t,r.position.y=e,r.index=e*this.width+t,s&&this.markDirty(r,n),this.#t[e*this.width+t]=r,!0}getParticleAt(t,e){return this.isInBounds(t,e)?this.#t[e*this.width+t]:null}tryMoveParticle(t,e,i=!1,s=!1,n=!1){for(const r of e){if(!r)continue;const o=I.shuffleArray(r);for(const l of o){let c=l.dx;i&&Math.random()>.5&&(c=l.dx*-1);const d=t.position.x+c,h=t.position.y+l.dy,u=this.getParticleAt(d,h);if(u&&u.isMovable&&t.density>u.density){this.#t[u.index]=t,this.#t[t.index]=u;const f={x:t.position.x,y:t.position.y},p=t.index;return t.position=u.position,t.index=u.index,u.position=f,u.index=p,s&&(this.markDirty(t,n),this.markDirty(u,n)),u}}}return null}swapParticles(t,e,i=!1,s=!1){return null}getNeighborOf(t,e){const i=t.position.x+e.dx,s=t.position.y+e.dy;return this.getParticleAt(i,s)}getNeighborsOf(t,e,i,s){return e.map(r=>this.getNeighborOf(t,r)).filter(r=>r!==null).filter(r=>{const o=i===void 0||r.category===i,l=s===void 0||r.id===s;return o&&l})}markDirty(t,e){if(this.#e.add(t),e){const i=this.getNeighborsOf(t,_.ALL_NEIGHBORS);for(const s of i)this.#e.add(s)}}isInBounds(t,e){return t>=0&&t<this.width&&e>=0&&e<this.height}fillCircleAt(t,e,i,s){for(let n=-i;n<=i;n++)for(let r=-i;r<=i;r++){if(n*n+r*r>i*i)continue;const o=t+n,l=e+r;if(!this.isInBounds(o,l))continue;const c=this.getParticleAt(o,l);(s===0||c===null||c.id===0)&&this.createParticleAt(o,l,s,!0,!0)}}}class B{#t;#e;#s;#o;#i;#n;#r;#d;#a;#l;#h;#p;#g;constructor(t,e,i,s,n,r){this.#t=s,this.#e=n,this.#s=r,this.#o=t,this.#i=e,this.#n=new R(t,e,i),this.#r=new Set,this.#d=!1,this.#a=null,this.#l=m.RENDER_UPDATE_INTERVAL,this.#h=m.PHYSICS_UPDATE_INTERVAL,this.#p=null,this.#g=0,this.tickCount=0,this.#t.queueParticles(this.#n.dirtyParticles)}start(){this.#d||(this.#d=!0,this.#u(0))}stop(){this.#d=!1,this.#a&&(cancelAnimationFrame(this.#a),this.#a=null)}#u=t=>{if(!this.#d)return;if(!this.#p){this.#p=t,this.#a=requestAnimationFrame(this.#u);return}const e=t-this.#p;for(this.#p=t,this.#e.processInput(this.#n,this.#t),this.#g+=e;this.#g>=this.#h;){let i=Array.from(this.#n.dirtyParticles);this.#t.queueParticles(this.#n.dirtyParticles),this.#n.dirtyParticles.clear(),this.#c(i),this.tickCount++,this.#g-=this.#h}this.#t.renderThisFrame(),this.#s.updateDisplay(t,this),this.#a=requestAnimationFrame(this.#u)};#c(t){if(t.length!==0){this.#r.clear(),t=I.shuffleArray(t),t.sort((e,i)=>e.position.y-i.position.y);for(const e of t)if(e&&!this.#r.has(e.index))switch(e.category){case 1:break;case 2:break;case 3:break;case 4:this.#m(e);break;case 5:break;default:continue}}}#f(t){}#m(t){let e=t.reposeDirections;const i=this.#n.tryMoveParticle(t,e,!0,!0,!0);i&&(this.#r.add(t.index),this.#r.add(i.index))}}class N{#t;#e;#s;#o;#i;#n;#r;#d;#a;#l;#h;#p;#g;#u;#c;#f;constructor(t,e,i,s,n,r,o){this.#t=t,this.#e=e,this.#s=n,this.#o=r,this.#i=o,this.#n=s,this.#r=i.BRUSH_SENSITIVITY,this.#d=i.BRUSH_MAX_SIZE,this.#a=i.SELECTED_PARTICLE,this.#l=i.SELECTED_CATEGORY,this.#h=i.BRUSH_CUR_SIZE,this.#p=i.CURRENT_PRESSURE,this.#g=i.CURRENT_CONCENTRATION,this.#u=null,this.#c=null,this.#f=null,this.isPainting=!1,this.isErasing=!1,this.isDrawingOverlay=!0,this.shouldChangeBrushSize=!1,this.changeBrushSizeDir=0,this.latestMouseCoords={x:0,y:0},this.activeButton="none";const l=document.getElementById("particle-category-bar");if(!l)throw new Error("DOM element of id 'particle-category-bar' does not exist.");this.#b(l);const c=document.getElementById("particle-button-container");if(!c)throw new Error("DOM element of id 'particle-button-container' does not exist.");this.#P(c),this.#w(),this.#c&&this.#E(this.#c)}processInput(t,e){const i=this.latestMouseCoords.x,s=this.latestMouseCoords.y,n={x:Math.floor(i),y:Math.floor(s)};if(this.isDrawingOverlay){const r=this.#m(n.x,n.y);e.queueOverlayPixels(r)}if(this.isPainting||this.isErasing){const r=n.x<this.#t+this.#h&&n.x>=0-this.#h,o=n.y<this.#e+this.#h&&n.y>=0-this.#h;if(r&&o){const l=n.x,c=n.y,d=this.isPainting?this.#a:0;t.fillCircleAt(l,c-1,this.#h,d)}}if(this.shouldChangeBrushSize){const r=this.changeBrushSizeDir*this.#r;let o=this.#h-r;o=Math.floor(o),o=Math.min(this.#d,o),o=Math.max(0,o),this.#h=o,this.changeBrushSizeDir=0}}#m(t,e){const i=this.#h,s=[],n=227,r=227,o=227,l=180,c=this.#t,d=this.#e,h=[-1,1],u=(E,C)=>{for(const A of h)for(const S of h){const v=t+E*S,x=e+C*A,b=t+C*S,P=e+E*A;if(v>=0&&v<c&&x>=0&&x<d){const w=(d-x)*c+v;s.push({index:w,value:new Uint8ClampedArray([n,r,o,l])})}if(b>=0&&b<c&&P>=0&&P<d){const w=(d-P)*c+b;s.push({index:w,value:new Uint8ClampedArray([n,r,o,l])})}}};let f=i,p=0,y=i-i;for(u(f,p);p<f;)p++,y<0?y+=2*p+1:(f--,y+=2*(p-f)+1),u(f,p);return s}#E(t){this.#c&&this.#c.classList.remove("selected"),t.classList.add("selected"),this.#c=t;const e=parseInt(t.dataset.categoryId);this.#l=e||1;let i=null;if(this.#n[this.#a]!==void 0){const s=this.#n[this.#a];s&&s.category===this.#l&&this.#u&&(i=this.#u)}document.querySelectorAll(".particle-button").forEach(s=>{const n=s,r=n.dataset.category;r&&parseInt(r)===this.#l?(n.style.display="",i||(i=n)):n.style.display="none"}),this.#C(i)}#C(t){if(!t)return;this.#u&&this.#u.classList.remove("selected"),t.classList.add("selected"),this.#u=t;const e=parseInt(t.dataset.particleId);this.#a=e||0}#b(t){t.innerHTML="";let e=this.#y(1,"Solids","./assets/icons/solid.svg");t.appendChild(e),this.#l==1&&(this.#c=e);let i=this.#y(2,"Liquids","./assets/icons/liquid.svg");t.appendChild(i),this.#l==2&&(this.#c=i);let s=this.#y(3,"Gases","./assets/icons/gas.svg");t.appendChild(s),this.#l==3&&(this.#c=s);let n=this.#y(4,"Sands","./assets/icons/sand.svg");t.appendChild(n),this.#l==4&&(this.#c=n);let r=this.#y(5,"Electronics","./assets/icons/electronics.svg");t.appendChild(r),this.#l==5&&(this.#c=r),this.#c||(this.#c=n)}#y(t,e,i){const s=document.createElement("button");s.className="category-button";const n=document.createElement("img");return n.src=i,n.alt=e,n.classList.add("category-icon"),s.dataset.categoryId=t.toString(),s.appendChild(n),s}#P(t){t.innerHTML="";for(const e in this.#n){const i=this.#n[e];if(!i)continue;const s=document.createElement("button");s.className="particle-button",s.textContent=i.name;const n=i.baseColor,r=i.variantColor,l=g.getLuminance(g.hexToColor(n))>210?"#323238":"#FFFFFFFF",c=g.hexToColor(l);s.style.setProperty("--particle-button-base-color",n),s.style.setProperty("--particle-button-variant-color",r),s.style.color=l,s.style.textShadow=`1px 1px 2px rgba(${c[0]}, ${c[1]}, ${c[2]}, 0.6)`,s.dataset.particleId=i.id.toString(),s.dataset.category=i.category.toString(),t.appendChild(s),i.id===this.#a&&(this.#u=s)}}#w(){const t=this.#i,e=document.getElementById("particle-category-bar"),i=document.getElementById("particle-button-container");if(!e||!i)throw new Error("Cannot find category bar and/ or button container");t.addEventListener("pointerdown",this.#I),t.addEventListener("pointermove",this.#S),t.addEventListener("pointerup",this.#A),t.addEventListener("pointercancel",this.#v),t.addEventListener("lostpointercapture",this.#v),t.addEventListener("pointerenter",this.#M),t.addEventListener("pointerleave",this.#_),t.addEventListener("wheel",this.#L,{passive:!1}),t.addEventListener("contextmenu",this.#T),window.addEventListener("pointerup",this.#x),window.addEventListener("mouseup",this.#x),document.addEventListener("visibilitychange",this.#D),e.addEventListener("click",s=>{if(!s.target)return;const r=s.target.closest(".category-button");r&&r&&this.#E(r)}),i.addEventListener("click",s=>{if(!s.target)return;const r=s.target.closest(".particle-button");r&&this.#C(r)})}#I=t=>{this.#f=t.pointerId,t.button===0?(this.isPainting=!0,this.isErasing=!1,this.activeButton="left"):t.button===2?(this.isErasing=!0,this.isPainting=!1,this.activeButton="right"):(this.isPainting=!1,this.isErasing=!1,this.activeButton="none");try{this.#i.setPointerCapture(t.pointerId)}catch{}const e=this.#i.getBoundingClientRect(),i=this.#t/e.width,s=this.#e/e.height;this.latestMouseCoords.x=(t.clientX-e.left)*i,this.latestMouseCoords.y=this.#i.height-(t.clientY-e.top)*s};#A=t=>{if(this.#f===t.pointerId){this.#f=null,this.activeButton="none";try{this.#i.releasePointerCapture(t.pointerId)}catch{}}this.isPainting=!1,this.isErasing=!1};#S=t=>{const e=this.#i.getBoundingClientRect(),i=this.#t/e.width,s=this.#i.height/e.height;if(this.latestMouseCoords.x=(t.clientX-e.left)*i,this.latestMouseCoords.y=this.#i.height-(t.clientY-e.top)*s,typeof t.buttons=="number"){const n=(t.buttons&1)===1,r=(t.buttons&2)===2;this.isPainting=n,this.isErasing=r}};#v=t=>{if(this.isPainting=!1,this.isErasing=!1,this.#f===t.pointerId){try{this.#i.releasePointerCapture(t.pointerId)}catch{}this.#f=null,this.activeButton="none"}};#x=()=>{this.isPainting=!1,this.isErasing=!1,this.#f=null,this.activeButton="none"};#D=()=>{document.hidden&&(this.isPainting=!1,this.isErasing=!1,this.#f=null,this.activeButton="none")};#L=t=>{t.preventDefault(),this.shouldChangeBrushSize=!0,this.changeBrushSizeDir=t.deltaY};#T=t=>{t.preventDefault()};#M=t=>{this.isDrawingOverlay=!0};#_=t=>{this.isDrawingOverlay=!1}}class O{#t;#e;#s;#o;#i;#n;#r;constructor(t){this.#t=!1,this.#e=!1,this.#s=new Map,this.#o=0,this.#i=0,this.#n=0,this.#r=0,this.#a(t)}enableDebug(t){this.#t=!0,t&&(this.#e=!0)}disableDebug(){this.#t=!1,this.#e=!1}updateDisplay(t,e){if(!this.#t)return;this.#d(t,e);const i=this.#s.get("fps");i&&(i.textContent=`FPS: ${this.#i.toFixed(2)}`);const s=this.#s.get("tps");s&&(s.textContent=`TPS: ${this.#n.toFixed(2)}`)}#d(t,e){const i=t-this.#r;i>=1e3&&(this.#i=this.#o*1e3/i,this.#n=e.tickCount*1e3/i,this.#o=0,e.tickCount=0,this.#r=t),this.#o++}#a(t){const e=document.createElement("div");e.classList.add("debug-container"),t.appendChild(e),this.#s.set("debug-container",e);const i=document.createElement("div");i.classList.add("debug-info-container"),e.appendChild(i),this.#s.set("info-container",i);const s=document.createElement("div");s.classList.add("debug-info"),i.appendChild(s),this.#s.set("fps",s);const n=document.createElement("div");n.classList.add("debug-info"),i.appendChild(n),this.#s.set("tps",n)}}async function U(){try{const a=m.GAME_WIDTH,t=m.GAME_HEIGHT,e=document.getElementById("main-canvas");if(!(e instanceof HTMLCanvasElement))throw new Error("HTML element 'main-canvas' does not exist.");const i=document.getElementById("main-panel");if(!(i instanceof HTMLDivElement))throw new Error("HTML element 'main-panel' does not exist.");const s=new M(a,t,e),n=await T("./src/data/particles.data"),r=new N(a,t,m,n,s,i,e),o=new O(i);o.enableDebug(!0),new B(a,t,n,s,r,o).start(),console.log(n)}catch(a){console.error("CRITICAL ERROR: Failed to initialize engine due to data loading failure.",a)}}U();
