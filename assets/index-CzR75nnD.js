var _t=l=>{throw TypeError(l)};var ct=(l,t,e)=>t.has(l)||_t("Cannot "+e);var h=(l,t,e)=>(ct(l,t,"read from private field"),e?e.call(l):t.get(l)),_=(l,t,e)=>t.has(l)?_t("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(l):t.set(l,e),p=(l,t,e,n)=>(ct(l,t,"write to private field"),n?n.call(l,e):t.set(l,e),e),L=(l,t,e)=>(ct(l,t,"access private method"),e);var dt=(l,t,e,n)=>({set _(i){p(l,t,i,e)},get _(){return h(l,t,n)}});(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=e(i);fetch(i.href,s)}})();const ht={GAME_WIDTH:342,GAME_HEIGHT:192,SELECTED_PARTICLE:10,SELECTED_CATEGORY:1,BRUSH_MAX_SIZE:42,BRUSH_CUR_SIZE:4,BRUSH_SENSITIVITY:.02,CURRENT_PRESSURE:0,CURRENT_CONCENTRATION:1,DEBUG_START_ENABLED:!0,DEBUG_OVERLAY_START_ENABLED:!1,RENDER_UPDATE_INTERVAL:16.667,PHYSICS_UPDATE_INTERVAL:25},ft={lerp(l,t,e){return l+(t-l)*e},shuffleArray(l){const t=[...l];for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t},calculateRepose(l){let t=Math.max(10,Math.min(l,80));const e=t*Math.PI/180;let n=[];if(n.push([{dx:0,dy:-1}]),t<50){n.push([{dx:1,dy:-1},{dx:-1,dy:-1}]);const i=Math.round(1/Math.tan(e));n.push([{dx:i,dy:-1},{dx:i*-1,dy:-1}])}else{const i=Math.round(Math.tan(e));n.push([{dx:1,dy:-i},{dx:-1,dy:-i}])}return n}};async function Tt(l){try{const t=await fetch(l);if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return await t.text()}catch(t){throw console.error(`Failed to read particle data from ${l}:`,t),new Error("Failed to load particle data.")}}async function Dt(l){const t=await Tt(l);let e={},n=new Set,i=null;for(const o of t.split(`
`)){const a=o.trim();if(!(a.length===0||a.startsWith("#"))){if(a.startsWith("[")&&a.endsWith("]")){const d=a.slice(1,-1),r=parseInt(d,10);if(isNaN(r)||r<10){i=null;continue}if(n.has(r)){console.warn(`[Loader] Duplicate ID found: ${r}. Ignoring.`),i=null;continue}n.add(r),i=r,e[r]={};continue}if(i!==null){const d=a.split(":").map(r=>r.trim());if(d.length===2){const r=d[0],c=d[1],u=e[i];switch(r){case"name":u.name=c;break;case"category":u.category=parseInt(c,10);break;case"base_color":u.base_color=c;break;case"variant_color":u.variant_color=c;break;case"is_movable":u.is_movable=c==="true";break;case"density":u.density=parseFloat(c);break;case"max_concentration":u.max_concentration=parseInt(c);break;case"repose_angle":u.repose_angle=parseFloat(c);break}}}}}const s={};for(const o in e){const a=e[o],d=parseInt(o,10);if(a.name===void 0||a.category===void 0||a.base_color===void 0||a.variant_color===void 0||a.is_movable===void 0||a.density===void 0){console.warn(`[Loader] Corrupted particle block found of ID: ${d}. Missing core properties.`);continue}let r={id:d,name:a.name,baseColor:a.base_color,variantColor:a.variant_color,isMovable:a.is_movable,density:a.density};a.category===1?s[d]={...r,category:1}:a.category===2?s[d]={...r,maxConcentration:a.max_concentration,category:2}:a.category===3?s[d]={...r,category:3}:a.category===4?s[d]={...r,category:4,reposeAngle:a.repose_angle,reposeDirections:ft.calculateRepose(a.repose_angle)}:a.category===5&&(s[d]={...r,category:5})}return s[0]={id:0,name:"Empty",category:0,baseColor:"#0E0E11",variantColor:"#0E0E11",isMovable:!0,density:0},s}var R,wt,Ct,ut;class At{constructor(t,e){_(this,R);this._canvas=t,this._ctx=this._canvas.getContext("2d"),this._renderWidth=e.GAME_WIDTH,this._renderHeight=e.GAME_HEIGHT,this._frameBuffer=new Uint8ClampedArray(this._renderWidth*this._renderHeight*4),this._queuedParticles=[],this._queuedOverlayPixels=[],this._queuedUIPixels=[],this._canvas.width=this._renderWidth,this._canvas.height=this._renderHeight,this._ctx.imageSmoothingEnabled=!1,this._ctx.translate(0,this._canvas.height),this._ctx.scale(1,-1)}queueUIPixels(t){this._queuedUIPixels=[],this._queuedUIPixels=t}queueParticles(t,e){if(this._queuedParticles.push(...t),e){const n=this._renderWidth,i=this._renderHeight;for(const s of t){const a=(i-1-s.position.y)*n+s.position.x;this._queuedOverlayPixels.push({index:a,value:e})}}}queueOverlayPixels(t){this._queuedOverlayPixels.push(...t)}renderThisFrame(){L(this,R,wt).call(this);let t=new Uint8ClampedArray(this._frameBuffer);L(this,R,ut).call(this,t,this._queuedOverlayPixels),L(this,R,ut).call(this,t,this._queuedUIPixels);const e=new ImageData(t,this._renderWidth,this._renderHeight);this._ctx.putImageData(e,0,0),this._queuedParticles.length=0,this._queuedOverlayPixels=[],this._queuedUIPixels=[]}}R=new WeakSet,wt=function(){const t=this._queuedParticles,e=this._renderWidth,n=this._renderHeight;for(const i of t){const s=i.position.x,o=i.position.y,d=(n-1-o)*e+s;let r=L(this,R,Ct).call(this,i);this._frameBuffer[d*4+0]=r[0],this._frameBuffer[d*4+1]=r[1],this._frameBuffer[d*4+2]=r[2],this._frameBuffer[d*4+3]=r[3]}},Ct=function(t){return t.color},ut=function(t,e){for(const{index:n,value:i}of e){const s=t[n*4+0],o=t[n*4+1],a=t[n*4+2],d=t[n*4+3],r=i[0],c=i[1],u=i[2],m=i[3],f=m/255,w=Math.round(r*f+s*(1-f)),g=Math.round(c*f+o*(1-f)),v=Math.round(u*f+a*(1-f)),P=Math.min(d,m);t[n*4+0]=w,t[n*4+1]=g,t[n*4+2]=v,t[n*4+3]=P}};const gt=Object.freeze({WHITE:new Uint8ClampedArray([255,255,255,255]),BLACK:new Uint8ClampedArray([0,0,0,255]),GRAY:new Uint8ClampedArray([128,128,128,255]),RED:new Uint8ClampedArray([255,0,0,255]),GREEN:new Uint8ClampedArray([0,255,0,255]),BLUE:new Uint8ClampedArray([0,0,255,255]),YELLOW:new Uint8ClampedArray([255,255,0,255]),CYAN:new Uint8ClampedArray([0,255,255,255]),MAGENTA:new Uint8ClampedArray([255,0,255,255]),TRANSPARENT_BLACK:new Uint8ClampedArray([0,0,0,0]),SEMI_TRANSPARENT_WHITE:new Uint8ClampedArray([255,255,255,128])}),$={createColor(l){return this.hexToColor(l)},hexToColor(l){if(l==null)return gt.BLACK;let t=l.replace("#","");if(t.length===6)t+="FF";else if(t.length===3){let n="";for(const i of t)n+=i,n+=i;t=n+"FF"}else return gt.BLACK;const e=parseInt(t,16);return new Uint8ClampedArray([e>>24&255,e>>16&255,e>>8&255,e&255])},colorToHex(l){const[t,e,n,i]=l,s=o=>o.toString(16).padStart(2,"0");return`#${s(t)}${s(e)}${s(n)}${s(i)}`},lerpColor(l,t,e){const n=l[0]+(t[0]-l[0])*e,i=l[1]+(t[1]-l[1])*e,s=l[2]+(t[2]-l[2])*e,o=l[3]+(t[3]-l[3])*e;return new Uint8ClampedArray([n,i,s,o])},createColorRamp(l,t,e){if(e<2)return[l,t];const n=1/(e-1),i=new Array(e);for(let s=0;s<e;s++){const o=s*n;i[s]=this.lerpColor(l,t,o)}return i},invertColor(l){const t=255-l[0],e=255-l[1],n=255-l[2],i=l[3];return new Uint8ClampedArray([t,e,n,i])},getLuminance(l){const t=l[0],e=l[1],n=l[2];return .299*t+.587*e+.114*n}},Rt=Object.freeze({ALL_NEIGHBORS:[{dx:-1,dy:1},{dx:0,dy:1},{dx:1,dy:1},{dx:-1,dy:0},{dx:1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}]}),ot=Object.freeze({UP_LEFT:{dx:-1,dy:1},UP:{dx:0,dy:1},UP_RIGHT:{dx:1,dy:1},LEFT:{dx:-1,dy:0},RIGHT:{dx:1,dy:0},DOWN_LEFT:{dx:-1,dy:-1},DOWN:{dx:0,dy:-1},DOWN_RIGHT:{dx:1,dy:-1}});var b,H,z,pt,xt;class Ot{constructor(t,e,n){_(this,z);_(this,b);_(this,H);this.width=t,this.height=e,p(this,b,new Array(t*e)),p(this,H,new Set),this.ParticleDataBlueprint=n,L(this,z,xt).call(this,0)}get data(){return h(this,b)}get dirtyParticles(){return h(this,H)}createParticleAt(t,e,n,i,s){if(!this.isInBounds(t,e))return!1;let o=L(this,z,pt).call(this,n);return o.position.x=t,o.position.y=e,o.index=e*this.width+t,i&&this.markDirty(o,s),h(this,b)[e*this.width+t]=o,!0}getParticleAt(t,e){return this.isInBounds(t,e)?h(this,b)[e*this.width+t]:null}tryMoveParticle(t,e,n=!1,i=!1,s=!1){for(const o of e){if(!o)continue;const a=ft.shuffleArray(o);for(const d of a){let r=d.dx;n&&Math.random()>.5&&(r=d.dx*-1);const c=t.position.x+r,u=t.position.y+d.dy,m=this.getParticleAt(c,u);if(m&&m.isMovable&&t.density>m.density){h(this,b)[m.index]=t,h(this,b)[t.index]=m;const f={x:t.position.x,y:t.position.y},w=t.index;return t.position=m.position,t.index=m.index,m.position=f,m.index=w,i&&(this.markDirty(t,s),this.markDirty(m,s)),m}}}return null}swapParticles(t,e,n,i){h(this,b)[t.index]=e,h(this,b)[e.index]=t;const s={x:t.position.x,y:t.position.y},o=t.index;t.position=e.position,t.index=e.index,e.position=s,e.index=o,n&&(this.markDirty(t,i),this.markDirty(e,i))}getNeighborOf(t,e){const n=t.position.x+e.dx,i=t.position.y+e.dy;return this.getParticleAt(n,i)}getNeighborsOf(t,e,n,i){return e.map(o=>this.getNeighborOf(t,o)).filter(o=>o!==null).filter(o=>{const a=n===void 0||o.category===n,d=i===void 0||o.id===i;return a&&d})}markDirty(t,e){if(h(this,H).add(t.index),e){const n=this.getNeighborsOf(t,Rt.ALL_NEIGHBORS);for(const i of n)h(this,H).add(i.index)}}isInBounds(t,e){return t>=0&&t<this.width&&e>=0&&e<this.height}fillCircleAt(t,e,n,i){for(let s=-n;s<=n;s++)for(let o=-n;o<=n;o++){if(s*s+o*o>n*n)continue;const a=t+s,d=e+o;if(!this.isInBounds(a,d))continue;const r=this.getParticleAt(a,d);(i===0||r===null||r.id===0)&&this.createParticleAt(a,d,i,!0,!0)}}}b=new WeakMap,H=new WeakMap,z=new WeakSet,pt=function(t){const e=this.ParticleDataBlueprint[t];if(!e)return null;let i=Math.random(),o=6-1,a=Math.round(i*o)/o;const d=$.hexToColor(e.baseColor),r=$.hexToColor(e.variantColor),c=$.lerpColor(d,r,a);let u={handle:-1,id:e.id,name:e.name,color:c,position:{x:-1,y:-1},index:0,isMovable:e.isMovable,density:e.density};return e.category===0?{...u,category:0}:e.category===1?{...u,category:1}:e.category===2?{...u,category:2,concentration:0,maxConcentration:e.maxConcentration}:e.category===3?{...u,category:3}:e.category===4?{...u,category:4,reposeAngle:e.reposeAngle,reposeDirections:e.reposeDirections}:e.category===5?{...u,category:5,node:-1}:null},xt=function(t){const e=this.width,n=this.height;p(this,b,new Array(e*n));for(let i=0;i<n;i++)for(let s=0;s<e;s++){let o=i*e+s,a=L(this,z,pt).call(this,t);a&&(a.position.x=s,a.position.y=i,a.index=o,h(this,b)[o]=a,h(this,H).add(a.index))}};const yt=Object.keys(ot);var q,it,X,nt,st,S,I,N,A,at,V,U,G,j,rt,K,T,vt,Pt,Lt,It,bt;class Ht{constructor(t,e,n,i,s){_(this,T);_(this,q);_(this,it);_(this,X);_(this,nt);_(this,st);_(this,S);_(this,I);_(this,N);_(this,A);_(this,at);_(this,V);_(this,U);_(this,G);_(this,j,0);_(this,rt,60);_(this,K,t=>{if(!h(this,N))return;if(!h(this,U)){p(this,U,t),p(this,A,requestAnimationFrame(h(this,K)));return}const e=t-h(this,U);p(this,U,t),h(this,it).processInput(h(this,S),h(this,q)),p(this,G,h(this,G)+e);let n=0;for(;h(this,G)>=h(this,V);){const i=[];for(const o of h(this,S).dirtyParticles)i.push(h(this,S).data[o]);dt(this,j)._++,h(this,j)>h(this,rt)&&(h(this,S).dirtyParticles.clear(),p(this,j,0));const s=new Uint8ClampedArray([210,55,55,180]);h(this,q).queueParticles(i,h(this,X).isOverlayEnabled?s:void 0),L(this,T,vt).call(this,i),this.tickCount++,p(this,G,h(this,G)-h(this,V)),n++,n>60&&p(this,G,0)}h(this,q).renderThisFrame(),h(this,X).updateDisplay(t,this),p(this,A,requestAnimationFrame(h(this,K)))});p(this,q,n),p(this,it,i),p(this,X,s),p(this,nt,e.GAME_WIDTH),p(this,st,e.GAME_HEIGHT),p(this,S,new Ot(h(this,nt),h(this,st),t)),p(this,I,new Set),p(this,N,!1),p(this,A,null),p(this,at,ht.RENDER_UPDATE_INTERVAL),p(this,V,ht.PHYSICS_UPDATE_INTERVAL),p(this,U,null),p(this,G,0),this.tickCount=0}start(){h(this,N)||(p(this,N,!0),h(this,K).call(this,0))}stop(){p(this,N,!1),h(this,A)&&(cancelAnimationFrame(h(this,A)),p(this,A,null))}groupParticles(t,e){const n=t.width,i=t.height,s=[],o=[],a={};for(let r=i-1;r>=0;r--)for(let c=0;c<n;c++){const u=r*n+c,m=t.getParticleAt(c,r);if(!m||m.category!==e||m.category!==e)continue;const f=t.getNeighborOf(m,ot.UP),w=t.getNeighborOf(m,ot.LEFT),g=f&&f.id===m.id,v=w&&w.id===m.id;let P=-1;v&&(P=r*n+(c-1));let C=-1;g&&(C=(r+1)*n+c);const y=f&&f.id===0;if(!v&&!g){const E=o.length;s.push([u]),o.push({liquidParticle:[],emptyParticle:[]}),y&&(o[E].liquidParticle.push(m),o[E].emptyParticle.push(f)),a[u]=E}else if(v&&!g){const E=a[P];s[E].push(u),y&&(o[E].liquidParticle.push(m),o[E].emptyParticle.push(f)),a[u]=E}else if(!v&&g){const E=a[C];s[E].push(u),y&&(o[E].liquidParticle.push(m),o[E].emptyParticle.push(f)),a[u]=E}else{const E=a[C];s[E].push(u),y&&(o[E].liquidParticle.push(m),o[E].emptyParticle.push(f)),a[u]=E;const x=a[P];if(x!==E){const O=o[x];for(const M of O.liquidParticle)o[E].liquidParticle.push(M);for(const M of O.emptyParticle)o[E].emptyParticle.push(M);const Y=s[x];for(const M of Y)a[M]=E;s[x]=[],o[x]={liquidParticle:[],emptyParticle:[]}}}}return o.filter(r=>r.liquidParticle.length>30)}}q=new WeakMap,it=new WeakMap,X=new WeakMap,nt=new WeakMap,st=new WeakMap,S=new WeakMap,I=new WeakMap,N=new WeakMap,A=new WeakMap,at=new WeakMap,V=new WeakMap,U=new WeakMap,G=new WeakMap,j=new WeakMap,rt=new WeakMap,K=new WeakMap,T=new WeakSet,vt=function(t){h(this,I).clear(),t=ft.shuffleArray(t),t.sort((n,i)=>n.position.y-i.position.y);for(const n of t)if(n&&!h(this,I).has(n.index))switch(n.category){case 1:break;case 2:L(this,T,Pt).call(this,n);break;case 3:L(this,T,Lt).call(this,n);break;case 4:L(this,T,It).call(this,n);break;case 5:break;default:continue}let e=this.groupParticles(h(this,S),2);L(this,T,bt).call(this,e)},Pt=function(t){let e=[[{dx:0,dy:-1}],[{dx:-1,dy:-1},{dx:1,dy:-1}],[{dx:-1,dy:0},{dx:1,dy:0}]];const n=h(this,S).tryMoveParticle(t,e,!1,!0,!0);n&&(h(this,I).add(t.index),h(this,I).add(n.index))},Lt=function(t){const e=yt[Math.floor(Math.random()*yt.length)];let i=[[ot[e]]];const s=h(this,S).tryMoveParticle(t,i,!1,!0,!0);s&&(h(this,I).add(t.index),h(this,I).add(s.index))},It=function(t){let e=t.reposeDirections;const n=h(this,S).tryMoveParticle(t,e,!0,!0,!0);n&&(h(this,I).add(t.index),h(this,I).add(n.index))},bt=function(t){for(const e of t){const n=e.liquidParticle.sort((d,r)=>r.position.y-d.position.y),i=e.emptyParticle.sort((d,r)=>d.position.y-r.position.y),s=n.length;let o=0;const a=s/4;for(let d=0;d<s;d++){const r=n[d],c=i[d];if(Math.sqrt(r.position.x*c.position.x+r.position.y*c.position.y),r.position.y>c.position.y&&(h(this,S).swapParticles(r,c,!0,!0),h(this,I).add(r.index),h(this,I).add(c.index),o++,o>=a))break}}};const et=class et{constructor(t,e,n,i,s){this.contentBarButtons=[],this.contents=[],this.selectedContent=0,this._onFocus=()=>{this._isFocused||(et.currentZIndex++,this._windowEl.style.zIndex=et.currentZIndex.toString())},this._onPointerDown=o=>{if(o.stopPropagation(),this._onFocus(),o.button===0){this._titlebarEl.setPointerCapture(o.pointerId);const a=this._windowEl.getBoundingClientRect();this._dragOffset.x=o.clientX-a.left,this._dragOffset.y=o.clientY-a.top,this._isDragging=!0}else this._isDragging=!1},this._onPointerUp=o=>{this._isDragging&&(this._titlebarEl.releasePointerCapture(o.pointerId),this._isDragging=!1)},this._onPointerMove=o=>{if(this._isDragging){const a=o.clientX-this._dragOffset.x,d=o.clientY-this._dragOffset.y;this._moveWindow({x:a,y:d})}},this._onCloseButtonClick=o=>{this._closeWindow()},this._onViewportResize=()=>{this._snapWindowBacc()},this._stopDragPropagation=o=>{o.stopPropagation()},this.hostEl=t,this.title=e,this.position=n,this.size=i,this.maxSize=s,this._isFocused=!1,this._isDragging=!1,this._dragOffset={x:0,y:0},this._initWindow(e,n),this._addEventListener(),this._onFocus()}destroy(){this._closeWindow()}_initWindow(t,e){this._windowEl=document.createElement("div"),this._windowEl.classList.add("ui-window"),this._windowEl.style.left=`${e.x}px`,this._windowEl.style.top=`${e.y}px`,this._windowEl.style.width=`${this.size.width}px`,this._windowEl.style.height=`${this.size.height}px`,this._windowEl.style.maxWidth=`${this.maxSize.width}px`,this._windowEl.style.maxHeight=`${this.maxSize.height}px`,this.hostEl.appendChild(this._windowEl),this._titlebarEl=document.createElement("div"),this._titlebarEl.classList.add("ui-window__titlebar");const n=document.createElement("span");n.classList.add("ui-window__title"),n.textContent=t,this._titlebarEl.appendChild(n),this._windowEl.appendChild(this._titlebarEl);const i=document.createElement("div");i.classList.add("ui-window__controls"),this._closeButtonEl=document.createElement("button"),this._closeButtonEl.classList.add("ui-window__title-button");const s=document.createElement("img");s.src="./assets/icons/close.svg",this._closeButtonEl.appendChild(s),i.appendChild(this._closeButtonEl),this._titlebarEl.appendChild(i),this._contentAreaEl=document.createElement("div"),this._contentAreaEl.classList.add("ui-window__content-area"),this._contentAreaEl.style.flexDirection="row",this._windowEl.appendChild(this._contentAreaEl),this._contentBarEl=document.createElement("div"),this._contentBarEl.classList.add("ui-window__category-strip","strip-left"),this._contentAreaEl.appendChild(this._contentBarEl),this._contentContainer=document.createElement("div"),this._contentContainer.classList.add("ui-window__content-container"),this._contentAreaEl.appendChild(this._contentContainer)}_addEventListener(){this._windowEl.addEventListener("mousedown",this._onFocus),this._titlebarEl.addEventListener("pointerdown",this._onPointerDown),this._titlebarEl.addEventListener("pointermove",this._onPointerMove),this._titlebarEl.addEventListener("pointerup",this._onPointerUp),this._closeButtonEl.addEventListener("click",this._onCloseButtonClick),this._closeButtonEl.addEventListener("pointerdown",this._stopDragPropagation),window.addEventListener("resize",this._onViewportResize)}_closeWindow(){window.removeEventListener("resize",this._onViewportResize),this._titlebarEl.removeEventListener("pointerdown",this._onPointerDown),this._titlebarEl.removeEventListener("pointermove",this._onPointerMove),this._titlebarEl.removeEventListener("pointerup",this._onPointerUp),this._windowEl.removeEventListener("mousedown",this._onFocus),this._windowEl&&this._windowEl.parentElement&&this._windowEl.parentElement.removeChild(this._windowEl),this._windowEl=null,this._titlebarEl=null,this._closeButtonEl=null,this._contentBarEl=null,this._contentAreaEl=null}_moveWindow(t){const e=this._windowEl.offsetWidth,n=this._windowEl.offsetHeight,i=Math.max(0,Math.min(t.x,window.innerWidth-e)),s=Math.max(0,Math.min(t.y,window.innerHeight-n));this._windowEl.style.left=`${i}px`,this._windowEl.style.top=`${s}px`}_snapWindowBacc(){const t=this._windowEl.offsetWidth,e=this._windowEl.offsetHeight,n=Math.max(0,window.innerWidth-t),i=Math.max(0,window.innerHeight-e),s=this._windowEl.offsetLeft,o=this._windowEl.offsetTop,a=Math.max(0,Math.min(s,n)),d=Math.max(0,Math.min(o,i));(a!==s||d!==o)&&(this._windowEl.style.left=`${a}px`,this._windowEl.style.top=`${d}px`)}displayContent(t){const e=this.contents[t];e&&(this.contents.forEach((n,i)=>{n.style.display="none"}),e.style.display="",this.selectedContent=t,this.contentBarButtons.forEach((n,i)=>{i===t?n.classList.add("active"):n.classList.remove("active")}))}addContentBarDivider(){const t=document.createElement("div");return t.classList.add("ui-flex-divider"),this._contentBarEl.appendChild(t),t}addContentBarSpacer(){const t=document.createElement("div");return t.classList.add("ui-flex-spacer"),this._contentBarEl.appendChild(t),t}addNewContent(t,e,n){let i=this.contents.length;this.contents.length!==0&&(t.style.display="none"),t.id="container-"+i,this._contentContainer.appendChild(t);const s=document.createElement("button");s.classList.add("ui-window__category-button"),s.title=e,this._contentBarEl.appendChild(s);const o=document.createElement("img");o.classList.add("ui-window__category-icon"),o.alt=e,o.src=n,s.appendChild(o),s.addEventListener("click",()=>this.displayContent(i)),this.contents.length>0&&(this._contentBarEl.style.display="flex"),this.contentBarButtons.push(s),this.contents.push(t)}setContentOrientation(t){t==="left"||t==="top"?(this._contentAreaEl.appendChild(this._contentBarEl),this._contentAreaEl.appendChild(this._contentContainer)):(this._contentAreaEl.appendChild(this._contentContainer),this._contentAreaEl.appendChild(this._contentBarEl)),t==="left"||t==="right"?this._contentAreaEl.style.flexDirection="row":this._contentAreaEl.style.flexDirection="column",this._contentBarEl.classList.forEach(e=>{e.startsWith("strip-")&&this._contentBarEl.classList.remove(e)}),this._contentBarEl.classList.add("ui-window__category-strip",`strip-${t}`)}};et.currentZIndex=100;let Et=et;class Nt{constructor(){this.contentElement=document.createElement("div"),this.contentElement.classList.add("ui-window__content")}addDivider(){const t=document.createElement("div");return t.classList.add("ui-window__divider"),this.contentElement.appendChild(t),t}addSpacer(t=1){const e=document.createElement("div");return e.classList.add("ui-window__spacer"),e.style.height=`${t}px`,this.contentElement.appendChild(e),e}addTitle(t){const e=document.createElement("h3");return e.classList.add("ui-title"),e.textContent=t,this.contentElement.appendChild(e),e}addSection(t){const e=document.createElement("h4");return e.classList.add("ui-section"),e.textContent=t,this.contentElement.appendChild(e),e}addText(t,e,n,i){const s=document.createElement("p");return s.classList.add("ui-text"),s.textContent=t,e!=null&&(s.style.color=e),i!=null&&(s.id=i),n!=null&&(s.style.fontWeight=n),this.contentElement.appendChild(s),s}addLink(t,e,n){const i=document.createElement("p");i.classList.add("ui-text"),n!=null&&(i.id=n);const s=document.createElement("a");return s.href=e,s.textContent=t,s.target="_blank",i.appendChild(s),this.contentElement.appendChild(i),i}addBulletedList(t){const e=document.createElement("ul");return e.classList.add("ui-text"),t.forEach(n=>{const i=document.createElement("li");i.textContent=n,e.appendChild(i)}),this.contentElement.appendChild(e),e}addNumberedList(t){const e=document.createElement("ol");return e.classList.add("ui-text"),t.forEach(n=>{const i=document.createElement("li");i.textContent=n,e.appendChild(i)}),this.contentElement.appendChild(e),e}addImage(t,e,n,i){const s=document.createElement("img");return s.classList.add("ui-image"),s.src=e,s.alt=n,s.width=t.width,s.height=t.height,i!=null&&(s.id=i),this.contentElement.appendChild(s),s}addSlider(t,e,n,i,s,o){const a=document.createElement("div");a.classList.add("flex-row"),o!=null&&(a.id=o);const d=document.createElement("label");d.textContent=t+":",a.appendChild(d);const r=document.createElement("input");r.type="range",r.min=e.toString(),r.max=n.toString(),r.value=i.toString(),r.step=s.toString(),o!=null&&(r.id=o+"-range"),a.appendChild(r);const c=document.createElement("input");return c.style.minWidth="40px",c.type="number",c.min=e.toString(),c.max=n.toString(),c.value=i.toString(),c.step=s.toString(),o!=null&&(c.id=o+"-number"),a.appendChild(c),r.oninput=()=>c.value=r.value,c.onchange=()=>{const u=Math.max(e,Math.min(n,parseInt(c.value))).toString();r.value=u,c.value=u},this.contentElement.appendChild(a),a}addTextInput(t,e,n,i){const s=document.createElement("div");s.classList.add("flex-row","ui-text-input-container");const o=document.createElement("label");o.textContent=t+":",s.appendChild(o);const a=document.createElement("input");return a.type="text",a.placeholder=e,a.value=n,i!=null&&(a.id=i),s.appendChild(a),this.contentElement.appendChild(s),s}addButton(t,e,n){const i=document.createElement("button");return i.classList.add("ui-window__content__Button"),i.textContent=t,e!=null&&(i.id=e),n!=null&&(i.style.backgroundColor=n),this.contentElement.appendChild(i),i}addDropdownButton(t,e,n=0,i){const s=document.createElement("div");s.classList.add("flex-row");const o=document.createElement("label");o.textContent=t+":",s.appendChild(o);const a=document.createElement("div");a.classList.add("custom-dropdown-container"),s.appendChild(a);const d=document.createElement("div");d.classList.add("dropdown-button");const r=document.createElement("span");r.textContent=e[0]?e[0]:"Template Item",i!=null&&(r.id=`${i}-display`),d.appendChild(r),a.appendChild(d);const c=document.createElement("ul");c.classList.add("dropdown-list"),i!=null&&(c.id=`${i}-list`),a.appendChild(c);let u=Math.max(0,Math.min(n,e.length-1));const m=[];for(let f=0;f<e.length;f++){const w=e[f],g=document.createElement("li");g.style.marginBottom="0px",g.classList.add("dropdown-item"),g.textContent=w,g.dataset.index=f.toString(),g.dataset.value=w.toLowerCase().replace(/\s/g,"-"),f===u&&(g.classList.add("is-selected"),r.textContent=w),g.addEventListener("click",v=>{v.stopPropagation(),m[u].classList.remove("is-selected"),u=f,g.classList.add("is-selected"),r.textContent=w,c.classList.remove("is-open")}),c.appendChild(g),m.push(g)}return d.addEventListener("click",f=>{if(f.stopPropagation(),c.classList.toggle("is-open")){c.parentElement,c.dataset.originId=a.id,document.body.appendChild(c);const g=d.getBoundingClientRect(),v=c.getBoundingClientRect(),P=c.scrollHeight||v.height,C=document.documentElement.clientHeight;c.style.position="absolute",c.style.left=`${g.left}px`,c.style.width=`${g.width}px`,c.style.zIndex="9999";const y=c.querySelector(".dropdown-item.is-selected");if(y){const E=y.offsetTop;let x=g.top-E;x<0&&(x=0),x+P>C&&(x=Math.max(0,C-P)),c.style.top=`${Math.round(x)}px`,c.scrollTop=E}else{let E=g.bottom;E+P>C&&(E=Math.max(0,C-P)),c.style.top=`${Math.round(E)}px`,c.scrollTop=0}}else c.parentElement===document.body&&a.appendChild(c)}),this.contentElement.appendChild(s),{button:d,items:m}}addToggleSwitch(t,e=!1,n){const i=document.createElement("div");i.classList.add("flex-row");const s=document.createElement("label");s.textContent=t+":",i.appendChild(s);const o=document.createElement("div");o.classList.add("toggle-container"),i.appendChild(o);const a=document.createElement("div");a.classList.add("toggle-switch"),a.dataset.state=e?"on":"off",e&&a.classList.add("is-on"),n!=null&&(a.id=n+"-switch"),o.appendChild(a);const d=document.createElement("span");d.classList.add("toggle-indicator","indicator-o"),d.textContent="O",a.appendChild(d);const r=document.createElement("span");r.classList.add("toggle-indicator","indicator-i"),r.textContent="I",a.appendChild(r);const c=document.createElement("div");return c.classList.add("toggle-slider"),a.appendChild(c),a.addEventListener("click",()=>{const u=a.classList.toggle("is-on");a.dataset.state=u?"on":"off"}),this.contentElement.appendChild(i),a}}class Ut{constructor(t,e,n,i,s){this._onPointerDown=o=>{this._activePointerId=o.pointerId,o.button===0?(this.isPainting=!0,this.isErasing=!1,this.activeButton="left"):o.button===2?(this.isErasing=!0,this.isPainting=!1,this.activeButton="right"):(this.isPainting=!1,this.isErasing=!1,this.activeButton="none");try{this._canvas.setPointerCapture(o.pointerId)}catch{}const a=this._canvas.getBoundingClientRect(),d=this._width/a.width,r=this._height/a.height;this.latestMouseCoords.x=(o.clientX-a.left)*d,this.latestMouseCoords.y=this._canvas.height-(o.clientY-a.top)*r},this._onPointerUp=o=>{if(this._activePointerId===o.pointerId){this._activePointerId=null,this.activeButton="none";try{this._canvas.releasePointerCapture(o.pointerId)}catch{}}this.isPainting=!1,this.isErasing=!1},this._onPointerMove=o=>{const a=this._canvas.getBoundingClientRect(),d=this._width/a.width,r=this._canvas.height/a.height;if(this.latestMouseCoords.x=(o.clientX-a.left)*d,this.latestMouseCoords.y=this._canvas.height-(o.clientY-a.top)*r,typeof o.buttons=="number"){const c=(o.buttons&1)===1,u=(o.buttons&2)===2;this.isPainting=c,this.isErasing=u}},this._onPointerCancel=o=>{if(this.isPainting=!1,this.isErasing=!1,this._activePointerId===o.pointerId){try{this._canvas.releasePointerCapture(o.pointerId)}catch{}this._activePointerId=null,this.activeButton="none"}},this._onWindowPointerUp=()=>{this.isPainting=!1,this.isErasing=!1,this._activePointerId=null,this.activeButton="none"},this._onVisibilityChange=()=>{document.hidden&&(this.isPainting=!1,this.isErasing=!1,this._activePointerId=null,this.activeButton="none")},this._onWheel=o=>{o.preventDefault(),this.shouldChangeBrushSize=!0,this.changeBrushSizeDir=o.deltaY},this._onContextMenu=o=>{o.preventDefault()},this._onPointerEnter=()=>{this.isDrawingOverlay=!0},this._onPointerLeave=()=>{this.isDrawingOverlay=!1},this._handleGlobalClick=o=>{document.querySelectorAll(".dropdown-list.is-open").forEach(a=>{const d=a.dataset.originId,r=d?document.getElementById(d):null;!a.contains(o.target)&&!r?.contains(o.target)&&(a.classList.remove("is-open"),r?.appendChild(a))})},this._mainContainer=e,this._canvas=n,this._renderer=s,this._width=i.GAME_WIDTH,this._height=i.GAME_HEIGHT,this._brushSizeSensitivity=i.BRUSH_SENSITIVITY,this._maxBrushSize=i.BRUSH_MAX_SIZE,this._selectedParticle=i.SELECTED_PARTICLE,this._selectedCategory=i.SELECTED_CATEGORY,this._currentBrushSize=i.BRUSH_CUR_SIZE,this._currentPressure=i.CURRENT_PRESSURE,this._currentConcentration=i.CURRENT_CONCENTRATION,this._activePointerId=null,this.isPainting=!1,this.isErasing=!1,this.isDrawingOverlay=!0,this.shouldChangeBrushSize=!1,this.changeBrushSizeDir=0,this.latestMouseCoords={x:0,y:0},this.activeButton="none",this._addEventListeners(),this._addParticlePaletteWindow(t),document.addEventListener("click",this._handleGlobalClick)}processInput(t,e){const n=this.latestMouseCoords.x,i=this.latestMouseCoords.y,s={x:Math.floor(n),y:Math.floor(i)};if(this.isDrawingOverlay){const o=this._calculateBrushOutline(s.x,s.y);e.queueUIPixels(o)}if(this.isPainting||this.isErasing){const o=s.x<this._width+this._currentBrushSize&&s.x>=0-this._currentBrushSize,a=s.y<this._height+this._currentBrushSize&&s.y>=0-this._currentBrushSize;if(o&&a){const d=s.x,r=s.y,c=this.isPainting?this._selectedParticle:0;t.fillCircleAt(d,r-1,this._currentBrushSize,c)}}if(this.shouldChangeBrushSize){const o=this.changeBrushSizeDir*this._brushSizeSensitivity;let a=this._currentBrushSize-o;a=Math.floor(a),a=Math.min(this._maxBrushSize,a),a=Math.max(0,a),this._currentBrushSize=a,this.changeBrushSizeDir=0}}_addEventListeners(){const t=this._canvas;t.addEventListener("pointerdown",this._onPointerDown),t.addEventListener("pointermove",this._onPointerMove),t.addEventListener("pointerup",this._onPointerUp),t.addEventListener("pointercancel",this._onPointerCancel),t.addEventListener("lostpointercapture",this._onPointerCancel),t.addEventListener("pointerenter",this._onPointerEnter),t.addEventListener("pointerleave",this._onPointerLeave),t.addEventListener("focus",this._onPointerEnter),t.addEventListener("blur",this._onPointerLeave),t.addEventListener("wheel",this._onWheel,{passive:!1}),this._mainContainer.addEventListener("contextmenu",this._onContextMenu),window.addEventListener("pointerup",this._onWindowPointerUp),window.addEventListener("mouseup",this._onWindowPointerUp),document.addEventListener("visibilitychange",this._onVisibilityChange)}_addParticlePaletteWindow(t){const e={x:320,y:300},n={width:250,height:200},i={width:420,height:400},s=new Et(this._mainContainer,"Particle Palette",e,n,i);s.setContentOrientation("bottom");const o=document.createElement("div");o.classList.add("particle-palette-container"),s.addNewContent(o,"Solids","./assets/icons/solid.svg");const a=document.createElement("div");a.classList.add("particle-palette-container"),s.addNewContent(a,"Liquids","./assets/icons/liquid.svg");const d=document.createElement("div");d.classList.add("particle-palette-container"),s.addNewContent(d,"Gases","./assets/icons/gas.svg");const r=document.createElement("div");r.classList.add("particle-palette-container"),s.addNewContent(r,"Sands","./assets/icons/sand.svg");const c=document.createElement("div");c.classList.add("particle-palette-container"),s.addNewContent(c,"Electronics","./assets/icons/electronics.svg");const u=new Nt;u.addDropdownButton("Orientation",["Left","Right","Top","Bottom"],3,"palette-orientation").items.forEach(C=>{C.addEventListener("click",()=>{const y=C.dataset.value;y&&s.setContentOrientation(y)})}),s.addContentBarSpacer(),s.addNewContent(u.contentElement,"Settings","./assets/icons/settings.svg");const f=2,w=f-1;s.displayContent(w),this._selectedCategory=f;const g=s.contentBarButtons,v=s.contents;for(let C=0;C<g.length-1;C++)g[C].addEventListener("click",()=>{for(const E of v){const x=E.querySelector(".selected");x&&x.classList.remove("selected")}const y=v[C];if(y){const E=y.querySelector(".particle-button");E&&(E.classList.add("selected"),this._selectedParticle=parseInt(E.dataset.particleId||"-1",10),this._selectedCategory=parseInt(E.dataset.category||"-1",10))}});let P=!1;for(const C in t){const y=t[C];if(!y)continue;const E=v[y.category-1];if(!E)continue;const x=y.baseColor,O=y.variantColor,M=$.getLuminance($.hexToColor(x))>210?"#323238":"#FFFFFFFF",lt=$.hexToColor(M),B=document.createElement("button");B.className="particle-button",B.textContent=y.name,B.style.setProperty("--particle-button-base-color",x),B.style.setProperty("--particle-button-variant-color",O),B.style.color=M,B.style.textShadow=`1px 1px 2px rgba(${lt[0]}, ${lt[1]}, ${lt[2]}, 0.6)`,B.dataset.particleId=y.id.toString(),B.dataset.category=y.category.toString(),B.addEventListener("click",()=>{for(const Bt of v){const mt=Bt.querySelector(".selected");mt&&mt.classList.remove("selected")}B.classList.add("selected"),this._selectedParticle=y.id,this._selectedCategory=y.category}),E.appendChild(B),!P&&y.category===this._selectedCategory&&(B.classList.add("selected"),this._selectedParticle=y.id,P=!0)}}_calculateBrushOutline(t,e){const n=this._currentBrushSize,i=[],s=227,o=227,a=227,d=180,r=this._width,c=this._height,u=[-1,1],m=(v,P)=>{for(const C of u)for(const y of u){const E=t+v*y,x=e+P*C,O=t+P*y,Y=e+v*C;if(E>=0&&E<r&&x>=0&&x<c){const M=(c-x)*r+E;i.push({index:M,value:new Uint8ClampedArray([s,o,a,d])})}if(O>=0&&O<r&&Y>=0&&Y<c){const M=(c-Y)*r+O;i.push({index:M,value:new Uint8ClampedArray([s,o,a,d])})}}};let f=n,w=0,g=n-n;for(m(f,w);w<f;)w++,g<0?g+=2*w+1:(f--,g+=2*(w-f)+1),m(f,w);return i}}var W,F,D,k,Z,J,Q,tt,St,Mt;class Gt{constructor(t){_(this,tt);_(this,W);_(this,F);_(this,D);_(this,k);_(this,Z);_(this,J);_(this,Q);p(this,W,!1),p(this,F,!1),p(this,D,new Map),p(this,k,0),p(this,Z,0),p(this,J,0),p(this,Q,0),L(this,tt,Mt).call(this,t)}get isOverlayEnabled(){return h(this,F)}enableDebug(t){p(this,W,!0),t&&p(this,F,!0)}disableDebug(){p(this,W,!1),p(this,F,!1)}updateDisplay(t,e){if(!h(this,W))return;L(this,tt,St).call(this,t,e);const n=h(this,D).get("fps");n&&(n.textContent=`FPS: ${h(this,Z).toFixed(2)}`);const i=h(this,D).get("tps");i&&(i.textContent=`TPS: ${h(this,J).toFixed(2)}`)}}W=new WeakMap,F=new WeakMap,D=new WeakMap,k=new WeakMap,Z=new WeakMap,J=new WeakMap,Q=new WeakMap,tt=new WeakSet,St=function(t,e){const n=t-h(this,Q);n>=1e3&&(p(this,Z,h(this,k)*1e3/n),p(this,J,e.tickCount*1e3/n),p(this,k,0),e.tickCount=0,p(this,Q,t)),dt(this,k)._++},Mt=function(t){const e=document.createElement("div");e.classList.add("debug-container"),t.appendChild(e),h(this,D).set("debug-container",e);const n=document.createElement("div");n.classList.add("debug-info-container"),e.appendChild(n),h(this,D).set("info-container",n);const i=document.createElement("div");i.classList.add("debug-info"),n.appendChild(i),h(this,D).set("fps",i);const s=document.createElement("div");s.classList.add("debug-info"),n.appendChild(s),h(this,D).set("tps",s)};async function qt(){try{let l=ht;const t=400,e=40,n=1e3,i=4;l.GAME_WIDTH=Math.max(e,Math.min(t,l.GAME_WIDTH)),l.GAME_HEIGHT=Math.max(e,Math.min(t,l.GAME_HEIGHT)),l.PHYSICS_UPDATE_INTERVAL=Math.max(i,Math.min(n,l.PHYSICS_UPDATE_INTERVAL)),Object.freeze(l);const s=document.getElementById("main-canvas");if(!(s instanceof HTMLCanvasElement))throw new Error("HTML element 'main-canvas' does not exist.");const o=document.getElementById("main-panel");if(!(o instanceof HTMLDivElement))throw new Error("HTML element 'main-panel' does not exist.");s.style.aspectRatio=(l.GAME_WIDTH/l.GAME_HEIGHT).toString();const a=new At(s,l),d=await Dt("./src/data/particles.data"),r=new Ut(d,o,s,l,a),c=new Gt(o);c.enableDebug(!1),new Ht(d,l,a,r,c).start(),console.log(d)}catch(l){console.error("ERROR: Failed to initialize engine due to data loading failure.",l)}}qt();
