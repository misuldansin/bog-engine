var G=c=>{throw TypeError(c)};var q=(c,e,t)=>e.has(c)||G("Cannot "+t);var _=(c,e,t)=>(q(c,e,"read from private field"),t?t.call(c):e.get(c)),O=(c,e,t)=>e.has(c)?G("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(c):e.set(c,t),k=(c,e,t,i)=>(q(c,e,"write to private field"),i?i.call(c,t):e.set(c,t),t),A=(c,e,t)=>(q(c,e,"access private method"),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function i(n){if(n.ep)return;n.ep=!0;const s=t(n);fetch(n.href,s)}})();class Z{constructor(e,t){this.boggedState=e,this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.frameBuffer=new Uint8ClampedArray(this.boggedState.gameWidth*this.boggedState.gameHeight*4),this.queuedParticles=[],this.queuedOverlayPixels=[],this.queuedUIPixels=[],this.canvas.style.aspectRatio=(this.boggedState.gameWidth/this.boggedState.gameHeight).toString(),this.canvas.width=this.boggedState.gameWidth,this.canvas.height=this.boggedState.gameHeight,this.ctx.imageSmoothingEnabled=!1,this.ctx.translate(0,this.canvas.height),this.ctx.scale(1,-1)}queueUIPixels(e){this.queuedUIPixels=[],this.queuedUIPixels=e}queueParticles(e,t){if(this.queuedParticles.push(...e),t){const i=this.boggedState.gameWidth,n=this.boggedState.gameHeight;for(const s of e){const a=(n-1-s.position.y)*i+s.position.x;this.queuedOverlayPixels.push({index:a,value:t})}}}queueOverlayPixels(e){this.queuedOverlayPixels.push(...e)}renderThisFrame(){if(this.boggedState.isBrushOutlineVisible){const i=this.getBrushOutline(Math.floor(this.boggedState.mouseX),Math.floor(this.boggedState.mouseY));this.queuedUIPixels=i}this.processQueuedParticles();let e=new Uint8ClampedArray(this.frameBuffer);this.addBuffer(e,this.queuedOverlayPixels),this.addBuffer(e,this.queuedUIPixels);const t=new ImageData(e,this.boggedState.gameWidth,this.boggedState.gameHeight);this.ctx.putImageData(t,0,0),this.queuedParticles.length=0,this.queuedOverlayPixels=[],this.queuedUIPixels=[]}processQueuedParticles(){const e=this.queuedParticles,t=this.boggedState.gameWidth,i=this.boggedState.gameHeight;for(const n of e){const s=n.position.x,o=n.position.y,l=(i-1-o)*t+s;let r=this.processParticleColor(n);this.frameBuffer[l*4+0]=r[0],this.frameBuffer[l*4+1]=r[1],this.frameBuffer[l*4+2]=r[2],this.frameBuffer[l*4+3]=r[3]}}processParticleColor(e){return e.color}addBuffer(e,t){for(const{index:i,value:n}of t){const s=e[i*4+0],o=e[i*4+1],a=e[i*4+2],l=e[i*4+3],r=n[0],d=n[1],h=n[2],p=n[3],g=p/255,y=Math.round(r*g+s*(1-g)),m=Math.round(d*g+o*(1-g)),b=Math.round(h*g+a*(1-g)),v=Math.min(l,p);e[i*4+0]=y,e[i*4+1]=m,e[i*4+2]=b,e[i*4+3]=v}}getBrushOutline(e,t){const i=this.boggedState.currentBrushSize,n=[],s=227,o=227,a=227,l=180,r=this.boggedState.gameWidth,d=this.boggedState.gameHeight,h=[-1,1],p=(b,v)=>{for(const w of h)for(const f of h){const u=e+b*f,E=t+v*w,L=e+v*f,M=t+b*w;if(u>=0&&u<r&&E>=0&&E<d){const C=(d-E)*r+u;n.push({index:C,value:new Uint8ClampedArray([s,o,a,l])})}if(L>=0&&L<r&&M>=0&&M<d){const C=(d-M)*r+L;n.push({index:C,value:new Uint8ClampedArray([s,o,a,l])})}}};let g=i,y=0,m=i-i;for(p(g,y);y<g;)y++,m<0?m+=2*y+1:(g--,m+=2*(y-g)+1),p(g,y);return n}}const $=Object.freeze({WHITE:new Uint8ClampedArray([255,255,255,255]),BLACK:new Uint8ClampedArray([0,0,0,255]),GRAY:new Uint8ClampedArray([128,128,128,255]),RED:new Uint8ClampedArray([255,0,0,255]),GREEN:new Uint8ClampedArray([0,255,0,255]),BLUE:new Uint8ClampedArray([0,0,255,255]),YELLOW:new Uint8ClampedArray([255,255,0,255]),CYAN:new Uint8ClampedArray([0,255,255,255]),MAGENTA:new Uint8ClampedArray([255,0,255,255]),TRANSPARENT_BLACK:new Uint8ClampedArray([0,0,0,0]),SEMI_TRANSPARENT_WHITE:new Uint8ClampedArray([255,255,255,128])}),D={createColor(c){return this.hexToColor(c)},hexToColor(c){if(c==null)return $.BLACK;let e=c.replace("#","");if(e.length===6)e+="FF";else if(e.length===3){let i="";for(const n of e)i+=n,i+=n;e=i+"FF"}else return $.BLACK;const t=parseInt(e,16);return new Uint8ClampedArray([t>>24&255,t>>16&255,t>>8&255,t&255])},colorToHex(c){const[e,t,i,n]=c,s=o=>o.toString(16).padStart(2,"0");return`#${s(e)}${s(t)}${s(i)}${s(n)}`},lerpColor(c,e,t){const i=c[0]+(e[0]-c[0])*t,n=c[1]+(e[1]-c[1])*t,s=c[2]+(e[2]-c[2])*t,o=c[3]+(e[3]-c[3])*t;return new Uint8ClampedArray([i,n,s,o])},createColorRamp(c,e,t){if(t<2)return[c,e];const i=1/(t-1),n=new Array(t);for(let s=0;s<t;s++){const o=s*i;n[s]=this.lerpColor(c,e,o)}return n},invertColor(c){const e=255-c[0],t=255-c[1],i=255-c[2],n=c[3];return new Uint8ClampedArray([e,t,i,n])},getLuminance(c){const e=c[0],t=c[1],i=c[2];return .299*e+.587*t+.114*i}},z={lerp(c,e,t){return c+(e-c)*t},shuffleArray(c){const e=[...c];for(let t=e.length-1;t>0;t--){const i=Math.floor(Math.random()*(t+1));[e[t],e[i]]=[e[i],e[t]]}return e},calculateRepose(c){let e=Math.max(10,Math.min(c,80));const t=e*Math.PI/180;let i=[];if(i.push([{dx:0,dy:-1}]),e<50){i.push([{dx:1,dy:-1},{dx:-1,dy:-1}]);const n=Math.round(1/Math.tan(t));i.push([{dx:n,dy:-1},{dx:n*-1,dy:-1}])}else{const n=Math.round(Math.tan(t));i.push([{dx:1,dy:-n},{dx:-1,dy:-n}])}return i}},Q=Object.freeze({ALL_NEIGHBORS:[{dx:-1,dy:1},{dx:0,dy:1},{dx:1,dy:1},{dx:-1,dy:0},{dx:1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}]}),T=Object.freeze({UP_LEFT:{dx:-1,dy:1},UP:{dx:0,dy:1},UP_RIGHT:{dx:1,dy:1},LEFT:{dx:-1,dy:0},RIGHT:{dx:1,dy:0},DOWN_LEFT:{dx:-1,dy:-1},DOWN:{dx:0,dy:-1},DOWN_RIGHT:{dx:1,dy:-1}});var x,P,I,N,X;class J{constructor(e,t,i){O(this,I);O(this,x);O(this,P);this.width=e,this.height=t,k(this,x,new Array(e*t)),k(this,P,new Set),this.particleData=i,A(this,I,X).call(this,0)}get data(){return _(this,x)}get dirtyParticles(){return _(this,P)}createParticleAt(e,t,i,n,s){if(!this.isInBounds(e,t))return!1;let o=A(this,I,N).call(this,i);return o.position.x=e,o.position.y=t,o.index=t*this.width+e,n&&this.markDirty(o,s),_(this,x)[t*this.width+e]=o,!0}getParticleAt(e,t){return this.isInBounds(e,t)?_(this,x)[t*this.width+e]:null}tryMoveParticle(e,t,i=!1,n=!1,s=!1){for(const o of t){if(!o)continue;const a=z.shuffleArray(o);for(const l of a){let r=l.dx;i&&Math.random()>.5&&(r=l.dx*-1);const d=e.position.x+r,h=e.position.y+l.dy,p=this.getParticleAt(d,h);if(p&&p.isMovable&&e.density>p.density){_(this,x)[p.index]=e,_(this,x)[e.index]=p;const g={x:e.position.x,y:e.position.y},y=e.index;return e.position=p.position,e.index=p.index,p.position=g,p.index=y,n&&(this.markDirty(e,s),this.markDirty(p,s)),p}}}return null}swapParticles(e,t,i,n){_(this,x)[e.index]=t,_(this,x)[t.index]=e;const s={x:e.position.x,y:e.position.y},o=e.index;e.position=t.position,e.index=t.index,t.position=s,t.index=o,i&&(this.markDirty(e,n),this.markDirty(t,n))}getNeighborOf(e,t){const i=e.position.x+t.dx,n=e.position.y+t.dy;return this.getParticleAt(i,n)}getNeighborsOf(e,t,i,n){return t.map(o=>this.getNeighborOf(e,o)).filter(o=>o!==null).filter(o=>{const a=i===void 0||o.category===i,l=n===void 0||o.id===n;return a&&l})}markDirty(e,t){if(_(this,P).add(e.index),t){const i=this.getNeighborsOf(e,Q.ALL_NEIGHBORS);for(const n of i)_(this,P).add(n.index)}}isInBounds(e,t){return e>=0&&e<this.width&&t>=0&&t<this.height}fillCircleAt(e,t,i,n){for(let s=-i;s<=i;s++)for(let o=-i;o<=i;o++){if(s*s+o*o>i*i)continue;const a=e+s,l=t+o;if(!this.isInBounds(a,l))continue;const r=this.getParticleAt(a,l);(n===0||r===null||r.id===0)&&this.createParticleAt(a,l,n,!0,!0)}}}x=new WeakMap,P=new WeakMap,I=new WeakSet,N=function(e){const t=this.particleData[e];if(!t)return null;let n=Math.random(),o=6-1,a=Math.round(n*o)/o;const l=D.hexToColor(t.baseColor),r=D.hexToColor(t.variantColor),d=D.lerpColor(l,r,a);let h={handle:-1,id:t.id,name:t.name,color:d,position:{x:-1,y:-1},index:0,isMovable:t.isMovable,density:t.density};return t.category===0?{...h,category:0}:t.category===1?{...h,category:1}:t.category===2?{...h,category:2,concentration:0,maxConcentration:t.maxConcentration}:t.category===3?{...h,category:3}:t.category===4?{...h,category:4,reposeAngle:t.reposeAngle,reposeDirections:t.reposeDirections}:t.category===5?{...h,category:5,node:-1}:null},X=function(e){const t=this.width,i=this.height;k(this,x,new Array(t*i));for(let n=0;n<i;n++)for(let s=0;s<t;s++){let o=n*t+s,a=A(this,I,N).call(this,e);a&&(a.position.x=s,a.position.y=n,a.index=o,_(this,x)[o]=a,_(this,P).add(a.index))}};var R,K;class tt{constructor(e,t,i,n,s){O(this,R);this.isRunning=!1,this.animationFrameId=null,this.lastFrameTime=null,this.accumulator=0,this.tickCount=0,this.clearDirtyDelta=0,this.clearDirtyFreq=60,this.neighborKeys=Object.keys(T),this.gameLoop=o=>{if(!this.isRunning)return;if(!this.lastFrameTime){this.lastFrameTime=o,this.animationFrameId=requestAnimationFrame(this.gameLoop);return}const a=o-this.lastFrameTime;this.lastFrameTime=o,this.handleInput(),this.accumulator+=a;let l=0;for(;this.accumulator>=this.physicsInterval;){const r=[];for(const h of this.currentGrid.dirtyParticles)r.push(this.currentGrid.data[h]);this.clearDirtyDelta++,this.clearDirtyDelta>this.clearDirtyFreq&&(this.currentGrid.dirtyParticles.clear(),this.clearDirtyDelta=0);const d=new Uint8ClampedArray([210,55,55,180]);this.renderer.queueParticles(r,this.debug.isOverlayEnabled?d:void 0),this.stepPhysics(r),this.tickCount++,this.accumulator-=this.physicsInterval,l++,l>60&&(this.accumulator=0)}this.renderer.renderThisFrame(),this.debug.updateDisplay(o,this),this.animationFrameId=requestAnimationFrame(this.gameLoop)},this.boggedState=e,this.renderer=t,this.inputManager=i,this.debug=n,this.currentGrid=new J(this.boggedState.gameWidth,this.boggedState.gameHeight,s),this.particlesProcessed=new Set,this.renderInterval=this.boggedState.renderInterval,this.physicsInterval=this.boggedState.physicsInterval}start(){this.isRunning||(this.isRunning=!0,this.gameLoop(0))}stop(){this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}handleInput(){this.boggedState.isLeftMouseButtonDown&&this.currentGrid.fillCircleAt(Math.floor(this.boggedState.mouseX),Math.floor(this.boggedState.mouseY),this.boggedState.currentBrushSize,this.boggedState.selectedParticleId),this.boggedState.isRightMouseButtonDown&&this.currentGrid.fillCircleAt(Math.floor(this.boggedState.mouseX),Math.floor(this.boggedState.mouseY),this.boggedState.currentBrushSize,0)}stepPhysics(e){this.particlesProcessed.clear(),e=z.shuffleArray(e),e.sort((i,n)=>i.position.y-n.position.y);for(const i of e)if(i&&!this.particlesProcessed.has(i.index))switch(i.category){case 1:break;case 2:this.handleLiquids(i);break;case 3:this.handleGases(i);break;case 4:A(this,R,K).call(this,i);break;case 5:break;default:continue}let t=this.groupParticles(this.currentGrid,2);this.simulateEqualisation(t)}handleLiquids(e){let t=[[{dx:0,dy:-1}],[{dx:-1,dy:-1},{dx:1,dy:-1}],[{dx:-1,dy:0},{dx:1,dy:0}]];const i=this.currentGrid.tryMoveParticle(e,t,!1,!0,!0);i&&(this.particlesProcessed.add(e.index),this.particlesProcessed.add(i.index))}handleGases(e){const t=this.neighborKeys[Math.floor(Math.random()*this.neighborKeys.length)];let n=[[T[t]]];const s=this.currentGrid.tryMoveParticle(e,n,!1,!0,!0);s&&(this.particlesProcessed.add(e.index),this.particlesProcessed.add(s.index))}simulateEqualisation(e){for(const t of e){const i=t.liquidParticle.sort((l,r)=>r.position.y-l.position.y),n=t.emptyParticle.sort((l,r)=>l.position.y-r.position.y),s=i.length;let o=0;const a=s/4;for(let l=0;l<s;l++){const r=i[l],d=n[l];if(Math.sqrt(r.position.x*d.position.x+r.position.y*d.position.y),r.position.y>d.position.y&&(this.currentGrid.swapParticles(r,d,!0,!0),this.particlesProcessed.add(r.index),this.particlesProcessed.add(d.index),o++,o>=a))break}}}groupParticles(e,t){const i=e.width,n=e.height,s=[],o=[],a={};for(let r=n-1;r>=0;r--)for(let d=0;d<i;d++){const h=r*i+d,p=e.getParticleAt(d,r);if(!p||p.category!==t||p.category!==t)continue;const g=e.getNeighborOf(p,T.UP),y=e.getNeighborOf(p,T.LEFT),m=g&&g.id===p.id,b=y&&y.id===p.id;let v=-1;b&&(v=r*i+(d-1));let w=-1;m&&(w=(r+1)*i+d);const f=g&&g.id===0;if(!b&&!m){const u=o.length;s.push([h]),o.push({liquidParticle:[],emptyParticle:[]}),f&&(o[u].liquidParticle.push(p),o[u].emptyParticle.push(g)),a[h]=u}else if(b&&!m){const u=a[v];s[u].push(h),f&&(o[u].liquidParticle.push(p),o[u].emptyParticle.push(g)),a[h]=u}else if(!b&&m){const u=a[w];s[u].push(h),f&&(o[u].liquidParticle.push(p),o[u].emptyParticle.push(g)),a[h]=u}else{const u=a[w];s[u].push(h),f&&(o[u].liquidParticle.push(p),o[u].emptyParticle.push(g)),a[h]=u;const E=a[v];if(E!==u){const L=o[E];for(const C of L.liquidParticle)o[u].liquidParticle.push(C);for(const C of L.emptyParticle)o[u].emptyParticle.push(C);const M=s[E];for(const C of M)a[C]=u;s[E]=[],o[E]={liquidParticle:[],emptyParticle:[]}}}}return o.filter(r=>r.liquidParticle.length>30)}}R=new WeakSet,K=function(e){let t=e.reposeDirections;const i=this.currentGrid.tryMoveParticle(e,t,!0,!0,!0);i&&(this.particlesProcessed.add(e.index),this.particlesProcessed.add(i.index))};const B=class B{constructor(e,t,i,n,s){this._onFocus=()=>{this._isFocused||(B.currentZIndex++,this.windowEl.style.zIndex=B.currentZIndex.toString())},this._onPointerDown=o=>{if(o.stopPropagation(),this._onFocus(),o.button===0){this.titlebarEl.setPointerCapture(o.pointerId);const a=this.windowEl.getBoundingClientRect();this._dragOffset.x=o.clientX-a.left,this._dragOffset.y=o.clientY-a.top,this._isDragging=!0}else this._isDragging=!1},this._onPointerUp=o=>{this._isDragging&&(this.titlebarEl.releasePointerCapture(o.pointerId),this._isDragging=!1)},this._onPointerMove=o=>{if(this._isDragging){const a=this.hostEl.getBoundingClientRect(),l=o.clientX-this._dragOffset.x-a.left,r=o.clientY-this._dragOffset.y-a.top;this._moveWindow({x:l,y:r})}},this._onCloseButtonClick=o=>{this._closeWindow()},this._onViewportResize=()=>{this._snapWindowBacc()},this._stopDragPropagation=o=>{o.stopPropagation()},this.title=t,this.position=i,this.size=n,this.maxSize=s,this.contentBarButtons=[],this.contents=[],this.selectedContent=0,this.contentBarOrientation="left",this.hostEl=e,this._initWindow(t,i),this._isFocused=!1,this._isDragging=!1,this._dragOffset={x:0,y:0},this._addEventListener()}destroy(){this._closeWindow()}_initWindow(e,t){this.windowEl=document.createElement("div"),this.windowEl.classList.add("ui-window"),this.windowEl.style.left=`${t.x}px`,this.windowEl.style.top=`${t.y}px`,this.windowEl.style.width=`${this.size.width}px`,this.windowEl.style.height=`${this.size.height}px`,this.windowEl.style.maxWidth=`${this.maxSize.width}px`,this.windowEl.style.maxHeight=`${this.maxSize.height}px`,this.windowEl.style.zIndex=B.currentZIndex.toString(),this.hostEl.appendChild(this.windowEl),this.titlebarEl=document.createElement("div"),this.titlebarEl.classList.add("ui-window__title-bar");const i=document.createElement("span");i.classList.add("ui-window__title"),i.textContent=e,this.titlebarEl.appendChild(i),this.windowEl.appendChild(this.titlebarEl);const n=document.createElement("div");n.classList.add("ui-window__title-bar__button__wrapper"),this.closeButtonEl=document.createElement("button"),this.closeButtonEl.classList.add("ui-window__title-bar__button");const s=document.createElement("img");s.src="./assets/icons/close.svg",this.closeButtonEl.appendChild(s),n.appendChild(this.closeButtonEl),this.titlebarEl.appendChild(n),this.contentWrapperEl=document.createElement("div"),this.contentWrapperEl.classList.add("ui-window__content__wrapper","left"),this.windowEl.appendChild(this.contentWrapperEl),this.contentBarEl=document.createElement("div"),this.contentBarEl.classList.add("ui-window__content-bar"),this.contentWrapperEl.appendChild(this.contentBarEl),this.contentContainer=document.createElement("div"),this.contentContainer.classList.add("ui-window__content-container"),this.contentWrapperEl.appendChild(this.contentContainer);const o=document.createElement("div");o.style.position="absolute",o.style.left="40px",o.style.borderRadius="0.6rem"}_addEventListener(){this.windowEl.addEventListener("mousedown",this._onFocus),this.titlebarEl.addEventListener("pointerdown",this._onPointerDown),this.titlebarEl.addEventListener("pointermove",this._onPointerMove),this.titlebarEl.addEventListener("pointerup",this._onPointerUp),this.closeButtonEl.addEventListener("click",this._onCloseButtonClick),this.closeButtonEl.addEventListener("pointerdown",this._stopDragPropagation),window.addEventListener("resize",this._onViewportResize)}_closeWindow(){window.removeEventListener("resize",this._onViewportResize),this.titlebarEl.removeEventListener("pointerdown",this._onPointerDown),this.titlebarEl.removeEventListener("pointermove",this._onPointerMove),this.titlebarEl.removeEventListener("pointerup",this._onPointerUp),this.windowEl.removeEventListener("mousedown",this._onFocus),this.windowEl&&this.windowEl.parentElement&&this.windowEl.parentElement.removeChild(this.windowEl),this.windowEl=null,this.titlebarEl!=null,this.closeButtonEl!=null,this.contentWrapperEl!=null,this.contentBarEl!=null,this.contentContainer!=null}_moveWindow(e){const t=this.windowEl.offsetWidth,i=this.windowEl.offsetHeight,n=this.hostEl.offsetWidth,s=this.hostEl.offsetHeight,o=Math.max(0,Math.min(e.x,n-t)),a=Math.max(0,Math.min(e.y,s-i));this.windowEl.style.left=`${o}px`,this.windowEl.style.top=`${a}px`}_snapWindowBacc(){const e=this.windowEl.offsetWidth,t=this.windowEl.offsetHeight,i=this.hostEl.offsetWidth,n=this.hostEl.offsetHeight,s=Math.max(0,i-e),o=Math.max(0,n-t),a=this.windowEl.offsetLeft,l=this.windowEl.offsetTop,r=Math.max(0,Math.min(a,s)),d=Math.max(0,Math.min(l,o));(r!==a||d!==l)&&(this.windowEl.style.left=`${r}px`,this.windowEl.style.top=`${d}px`)}setContentOrientation(e){this.contentWrapperEl.classList.remove("top","bottom","left","right"),this.contentWrapperEl.classList.add(e),this.contentBarOrientation=e}addNewContent(e,t,i){let n=this.contents.length;this.contents.length!==0&&(e.style.display="none"),e.id="container-"+n,this.contentContainer.appendChild(e);const s=document.createElement("button");s.classList.add("ui-window__content-bar__button"),s.title=t,this.contentBarEl.appendChild(s);const o=document.createElement("img");o.classList.add("ui-window__content-bar__button__icon"),o.alt=t,o.src=i,s.appendChild(o),s.addEventListener("click",()=>this.displayContentAtIndex(n)),this.contents.length>0&&(this.contentBarEl.style.display="flex"),this.contentBarButtons.push(s),this.contents.push(e)}displayContent(e){const t=this.contents;for(let i=0;i<t.length;i++){const n=t[i];if(n===e){this.contents.forEach((s,o)=>{s.style.display="none"}),n.style.display="",this.selectedContent=i,this.contentBarButtons.forEach((s,o)=>{o===i?s.classList.add("active"):s.classList.remove("active")});return}}}displayContentAtIndex(e){const t=this.contents[e];t&&(this.contents.forEach((i,n)=>{i.style.display="none"}),t.style.display="",this.selectedContent=e,this.contentBarButtons.forEach((i,n)=>{n===e?i.classList.add("active"):i.classList.remove("active")}))}addContentBarSeparator(e=!1){const t=document.createElement("div");return t.classList.add("ui-window__content-bar__separator"),e&&t.classList.add("is-spacer"),this.contentBarEl.appendChild(t),t}};B.currentZIndex=100;let W=B;class H{constructor(){this.contentElement=document.createElement("div"),this.contentElement.classList.add("ui-window__content")}addSeparator(e=1,t=!1){const i=document.createElement("div");if(i.classList.add("ui-window__content__separator"),i.style.height=`${e}px`,t){const n=document.createElement("div");n.classList.add("ui-window__content__separator__line"),i.appendChild(n)}return this.contentElement.appendChild(i),i}addTitle(e){const t=document.createElement("h3");return t.classList.add("ui-window__content__heading-title"),t.textContent=e,this.contentElement.appendChild(t),t}addSection(e){const t=document.createElement("h4");return t.classList.add("ui-window__content__heading-section"),t.textContent=e,this.contentElement.appendChild(t),t}addText(e,t,i,n){const s=document.createElement("p");return s.classList.add("ui-window__content__text"),s.textContent=e,t!=null&&(s.style.color=t),n!=null&&(s.id=n),i!=null&&(s.style.fontWeight=i),this.contentElement.appendChild(s),s}addLink(e,t,i){const n=document.createElement("p");n.classList.add("ui-window__content__text"),i!=null&&(n.id=i);const s=document.createElement("a");return s.href=t,s.textContent=e,s.target="_blank",n.appendChild(s),this.contentElement.appendChild(n),n}addBulletedList(e){const t=document.createElement("ul");return t.classList.add("ui-window__content"),e.forEach(i=>{const n=document.createElement("li");n.classList.add("ui-window__content"),n.textContent=i,t.appendChild(n)}),this.contentElement.appendChild(t),t}addNumberedList(e){const t=document.createElement("ol");return t.classList.add("ui-window__content"),e.forEach(i=>{const n=document.createElement("li");n.classList.add("ui-window__content"),n.textContent=i,t.appendChild(n)}),this.contentElement.appendChild(t),t}addImage(e,t,i,n){const s=document.createElement("img");return s.classList.add("ui-window__content__image"),s.src=t,s.alt=i,s.width=e.width,s.height=e.height,n!=null&&(s.id=n),this.contentElement.appendChild(s),s}addSlider(e,t,i,n,s,o){const a=document.createElement("div");a.classList.add("ui-window__helper__flex-row"),o!=null&&(a.id=o);const l=document.createElement("label");l.textContent=e+":",a.appendChild(l);const r=document.createElement("input");r.type="range",r.min=t.toString(),r.max=i.toString(),r.value=n.toString(),r.step=s.toString(),o!=null&&(r.id=o+"-range"),a.appendChild(r);const d=document.createElement("input");return d.style.minWidth="40px",d.type="number",d.min=t.toString(),d.max=i.toString(),d.value=n.toString(),d.step=s.toString(),o!=null&&(d.id=o+"-number"),a.appendChild(d),r.oninput=()=>d.value=r.value,d.onchange=()=>{const h=Math.max(t,Math.min(i,parseInt(d.value))).toString();r.value=h,d.value=h},this.contentElement.appendChild(a),a}addTextInput(e,t,i,n){const s=document.createElement("div");s.classList.add("ui-window__content__text-input__wrapper");const o=document.createElement("label");o.textContent=e+":",s.appendChild(o);const a=document.createElement("input");return a.type="text",a.placeholder=t,a.value=i,n!=null&&(a.id=n),s.appendChild(a),this.contentElement.appendChild(s),s}addButton(e,t,i){const n=document.createElement("button");return n.classList.add("ui-window__content__button"),n.textContent=e,t!=null&&(n.id=t),i!=null&&(n.style.backgroundColor=i),this.contentElement.appendChild(n),n}addDropdownButton(e,t,i=0,n){const s=document.createElement("div");s.classList.add("ui-window__helper__flex-row");const o=document.createElement("label");o.textContent=e+":",s.appendChild(o);const a=document.createElement("div");a.classList.add("ui-window__content__dropdown-button__wrapper"),s.appendChild(a);const l=document.createElement("div");l.classList.add("ui-window__content__dropdown-button");const r=document.createElement("span");r.textContent=t[0]?t[0]:"Template Item",n!=null&&(r.id=`${n}-display`),l.appendChild(r),a.appendChild(l);const d=document.createElement("ul");d.classList.add("ui-window__content__dropdown-list"),n!=null&&(d.id=`${n}-list`),a.appendChild(d);let h=Math.max(0,Math.min(i,t.length-1));const p=[];for(let g=0;g<t.length;g++){const y=t[g],m=document.createElement("li");m.style.marginBottom="0px",m.classList.add("ui-window__content__dropdown-item"),m.textContent=y,m.dataset.index=g.toString(),m.dataset.value=y.toLowerCase().replace(/\s/g,"-"),g===h&&(m.classList.add("is-selected"),r.textContent=y),m.addEventListener("click",b=>{b.stopPropagation(),p[h].classList.remove("is-selected"),h=g,m.classList.add("is-selected"),r.textContent=y,d.classList.remove("is-open")}),d.appendChild(m),p.push(m)}return l.addEventListener("click",g=>{if(g.stopPropagation(),d.classList.toggle("is-open")){d.parentElement,d.dataset.originId=a.id,document.body.appendChild(d);const m=l.getBoundingClientRect(),b=d.getBoundingClientRect(),v=d.scrollHeight||b.height,w=document.documentElement.clientHeight;d.style.position="absolute",d.style.left=`${m.left}px`,d.style.width=`${m.width}px`,d.style.zIndex="9999";const f=d.querySelector(".dropdown-item.is-selected");if(f){const u=f.offsetTop;let E=m.top-u;E<0&&(E=0),E+v>w&&(E=Math.max(0,w-v)),d.style.top=`${Math.round(E)}px`,d.scrollTop=u}else{let u=m.bottom;u+v>w&&(u=Math.max(0,w-v)),d.style.top=`${Math.round(u)}px`,d.scrollTop=0}}else d.parentElement===document.body&&a.appendChild(d)}),this.contentElement.appendChild(s),{button:l,items:p}}addToggleSwitch(e,t=!1,i){const n=document.createElement("div");n.classList.add("ui-window__helper__flex-row");const s=document.createElement("label");s.textContent=e+":",n.appendChild(s);const o=document.createElement("div");o.classList.add("ui-window__content__toggle-button__wrapper"),n.appendChild(o);const a=document.createElement("div");a.classList.add("ui-window__content__toggle-button"),a.dataset.state=t?"on":"off",t&&a.classList.add("is-on"),i!=null&&(a.id=i+"-switch"),o.appendChild(a);const l=document.createElement("span");l.classList.add("ui-window__content__toggle-button__indicator","indicator-o"),l.textContent="O",a.appendChild(l);const r=document.createElement("span");r.classList.add("ui-window__content__toggle-button__indicator","indicator-i"),r.textContent="I",a.appendChild(r);const d=document.createElement("div");return d.classList.add("ui-window__content__toggle-button__slider"),a.appendChild(d),a.addEventListener("click",()=>{const h=a.classList.toggle("is-on");a.dataset.state=h?"on":"off"}),this.contentElement.appendChild(n),a}}class et{constructor(e,t){this.boggedState=e,this.host=t,document.addEventListener("click",i=>{document.querySelectorAll(".ui-window__content__dropdown-list.is-open").forEach(n=>{const s=n.dataset.originId,o=s?document.getElementById(s):null;!n.contains(i.target)&&!o?.contains(i.target)&&(n.classList.remove("is-open"),o?.appendChild(n))})})}addPaletteWindow(e){const t="Particle Palette",i={x:320,y:300},n={width:250,height:200},s={width:420,height:400},o=new W(this.host,t,i,n,s);o.setContentOrientation("bottom");const a=document.createElement("div");a.classList.add("particle-palette-container"),o.addNewContent(a,"Solids","./assets/icons/solid.svg");const l=document.createElement("div");l.classList.add("particle-palette-container"),o.addNewContent(l,"Liquids","./assets/icons/liquid.svg");const r=document.createElement("div");r.classList.add("particle-palette-container"),o.addNewContent(r,"Gases","./assets/icons/gas.svg");const d=document.createElement("div");d.classList.add("particle-palette-container"),o.addNewContent(d,"Sands","./assets/icons/sand.svg");const h=document.createElement("div");h.classList.add("particle-palette-container"),o.addNewContent(h,"Electronics","./assets/icons/electronics.svg");const p=new H;let{button:g,items:y}=p.addDropdownButton("Orientation",["Top","Left","Right","Bottom"],3,"palette-orientation");y.forEach(w=>{w.addEventListener("click",()=>{const f=w.dataset.value;f&&o.setContentOrientation(f)})}),o.addContentBarSeparator(!0),o.addNewContent(p.contentElement,"Settings","./assets/icons/settings.svg"),o.displayContent(l);const m=o.contentBarButtons,b=o.contents;for(let w=0;w<m.length-1;w++)m[w].addEventListener("click",()=>{if(this.boggedState.selectedCategoryId===w+1)return;for(const u of b){const E=u.querySelector(".selected");E&&E.classList.remove("selected")}const f=b[w];if(f){const u=f.querySelector(".particle-button");u?(u.classList.add("selected"),this.boggedState.selectedParticleId=parseInt(u.dataset.particleId||"0",10),this.boggedState.selectedCategoryId=parseInt(u.dataset.category||"0",10)):(this.boggedState.selectedParticleId=0,this.boggedState.selectedCategoryId=0)}});let v=!1;for(const w in e){const f=e[w];if(!f)continue;const u=b[f.category-1];if(!u)continue;const E=f.baseColor,L=f.variantColor,C=D.getLuminance(D.hexToColor(E))>210?"#323238":"#FFFFFFFF",F=D.hexToColor(C),S=document.createElement("button");S.className="particle-button",S.textContent=f.name,S.style.setProperty("--particle-button-base-color",E),S.style.setProperty("--particle-button-variant-color",L),S.style.color=C,S.style.textShadow=`1px 1px 2px rgba(${F[0]}, ${F[1]}, ${F[2]}, 0.6)`,S.dataset.particleId=f.id.toString(),S.dataset.category=f.category.toString(),S.addEventListener("click",()=>{for(const j of b){const U=j.querySelector(".selected");U&&U.classList.remove("selected")}S.classList.add("selected"),this.boggedState.selectedParticleId=f.id,this.boggedState.selectedCategoryId=f.category}),u.appendChild(S),!v&&f.category===this.boggedState.selectedCategoryId&&(S.classList.add("selected"),this.boggedState.selectedParticleId=f.id,v=!0)}}}class nt{constructor(e,t,i,n){this.activePointerId=null,this.isAppMenuOpen=!1,this.boggedState=e,this.windowManager=new et(e,t),this.viewport=t,this.canvas=i,this.windowManager.addPaletteWindow(n),this.bindAppMenuEvents(),this.bindCanvasEvents(),this.viewport.addEventListener("contextmenu",s=>{s.preventDefault()}),document.addEventListener("click",s=>{if(!this.isAppMenuOpen)return;s.target?.closest(".app-menu__menu-item")||(document.querySelectorAll(".app-menu__dropdown[style*='block']").forEach(l=>{l.style.display="none"}),this.isAppMenuOpen=!1)})}bindAppMenuEvents(){const e=(n,s)=>{const o=document.createElement("div");return o.classList.add("app-menu__dropdown"),o.style.display="none",s.forEach(a=>{const l=document.createElement("div");l.classList.add("app-menu__dropdown-item"),l.textContent=a,o.appendChild(l)}),n.appendChild(o),o},t=(n,s)=>{n.addEventListener("click",o=>{o.stopPropagation();const a=document.querySelector(".app-menu__dropdown[style*='block']");a&&a!==s&&(a.style.display="none"),s.style.display==="block"?(s.style.display="none",this.isAppMenuOpen=!1):(s.style.display="block",this.isAppMenuOpen=!0)}),n.addEventListener("mouseenter",()=>{if(this.isAppMenuOpen&&s.style.display!=="block"){const o=document.querySelector(".app-menu__dropdown[style*='block']");o&&o!==s&&(o.style.display="none"),s.style.display="block"}})},i=(n,s)=>{const o=document.getElementById(n);if(o instanceof HTMLDivElement){const a=e(o,s);t(o,a)}};i("bog-menu-item",["About bog engine","Settings","Quit"]),i("file-item",["Save","Load","New scene","Exit"]),i("edit-item",["Undo","Redo","Preferences"]),i("view-item",["Zoom In","Zoom Out","Reset View"]),i("help-item",["Documentation","Report Issue"])}bindCanvasEvents(){const e=n=>{try{this.canvas.releasePointerCapture(n.pointerId)}catch{}},t=n=>{try{this.canvas.setPointerCapture(n.pointerId)}catch{}},i=n=>{const s=this.canvas.getBoundingClientRect(),o=this.boggedState.gameWidth/s.width,a=this.boggedState.gameHeight/s.height,l=(n.clientX-s.left)*o,r=this.canvas.height-(n.clientY-s.top)*a;this.boggedState.mouseX=l,this.boggedState.mouseY=r};this.canvas.addEventListener("pointerdown",n=>{switch(i(n),n.button){case 0:this.boggedState.isLeftMouseButtonDown=!0;break;case 2:this.boggedState.isRightMouseButtonDown=!0;break;default:this.boggedState.isLeftMouseButtonDown=!1,this.boggedState.isRightMouseButtonDown=!1;break}t(n),this.activePointerId=n.pointerId}),this.canvas.addEventListener("pointermove",n=>{i(n),typeof n.buttons=="number"&&(this.boggedState.isLeftMouseButtonDown=(n.buttons&1)===1,this.boggedState.isRightMouseButtonDown=(n.buttons&2)===2)}),this.canvas.addEventListener("pointerup",n=>{this.activePointerId===n.pointerId&&(e(n),this.activePointerId=null),this.boggedState.isLeftMouseButtonDown=!1,this.boggedState.isRightMouseButtonDown=!1}),this.canvas.addEventListener("pointercancel",n=>{this.activePointerId===n.pointerId&&(e(n),this.activePointerId=null),this.boggedState.isLeftMouseButtonDown=!1,this.boggedState.isRightMouseButtonDown=!1}),this.canvas.addEventListener("lostpointercapture",n=>{this.activePointerId===n.pointerId&&(e(n),this.activePointerId=null),this.boggedState.isLeftMouseButtonDown=!1,this.boggedState.isRightMouseButtonDown=!1}),this.canvas.addEventListener("pointerenter",()=>{this.boggedState.isBrushOutlineVisible=!0}),this.canvas.addEventListener("pointerleave",()=>{this.boggedState.isBrushOutlineVisible=!1}),this.canvas.addEventListener("focus",()=>{this.boggedState.isBrushOutlineVisible=!0}),this.canvas.addEventListener("blur",()=>{this.boggedState.isBrushOutlineVisible=!1}),this.canvas.addEventListener("wheel",n=>{n.preventDefault();const s=Math.floor(this.boggedState.currentBrushSize-n.deltaY*this.boggedState.brushSensitivity),o=Math.max(0,Math.min(s,this.boggedState.brushMaxSize));this.boggedState.currentBrushSize=o},{passive:!1}),window.addEventListener("pointerup",()=>{this.boggedState.isLeftMouseButtonDown=!1,this.boggedState.isRightMouseButtonDown=!1,this.activePointerId=null}),document.addEventListener("visibilitychange",()=>{document.hidden&&(this.boggedState.isLeftMouseButtonDown=!1,this.boggedState.isRightMouseButtonDown=!1,this.activePointerId=null)})}}class it{constructor(e,t,i=!1){this.frameCount=0,this.fps=0,this.tps=0,this.lastStatsUpdateTime=0,this.boggedState=e,this.isEnabled=i,this.isOverlayEnabled=i,this.elements=new Map,this.initDebug(t)}enableDebug(e){this.isEnabled=!0,e&&(this.isOverlayEnabled=!0)}disableDebug(){this.isEnabled=!1,this.isOverlayEnabled=!1}updateDisplay(e,t){if(!this.isEnabled)return;this.updateStats(e,t);const i=this.elements.get("fps");i&&(i.textContent=`FPS: ${this.fps.toFixed(2)}`);const n=this.elements.get("tps");n&&(n.textContent=`TPS: ${this.tps.toFixed(2)}`)}updateStats(e,t){const i=e-this.lastStatsUpdateTime;i>=1e3&&(this.fps=this.frameCount*1e3/i,this.tps=t.tickCount*1e3/i,this.frameCount=0,t.tickCount=0,this.lastStatsUpdateTime=e),this.frameCount++}initDebug(e){const t=document.createElement("div");t.classList.add("debug-container"),e.appendChild(t),this.elements.set("debug-container",t);const i=document.createElement("div");i.classList.add("debug-info-container"),t.appendChild(i),this.elements.set("info-container",i);const n=document.createElement("div");n.classList.add("debug-info"),i.appendChild(n),this.elements.set("fps",n);const s=document.createElement("div");s.classList.add("debug-info"),i.appendChild(s),this.elements.set("tps",s)}}async function V(c){try{const e=await fetch(c);if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return await e.text()}catch(e){throw console.error(`Failed to read particle data from ${c}:`,e),new Error("Failed to load particle data.")}}async function st(c){const e=await V(c);let t={},i=new Set,n=null;for(const o of e.split(`
`)){const a=o.trim();if(!(a.length===0||a.startsWith("#"))){if(a.startsWith("[")&&a.endsWith("]")){const l=a.slice(1,-1),r=parseInt(l,10);if(isNaN(r)||r<10){n=null;continue}if(i.has(r)){console.warn(`[Loader] Duplicate ID found: ${r}. Ignoring.`),n=null;continue}i.add(r),n=r,t[r]={};continue}if(n!==null){const l=a.split(":").map(r=>r.trim());if(l.length===2){const r=l[0],d=l[1],h=t[n];switch(r){case"name":h.name=d;break;case"category":h.category=parseInt(d,10);break;case"base_color":h.base_color=d;break;case"variant_color":h.variant_color=d;break;case"is_movable":h.is_movable=d==="true";break;case"density":h.density=parseFloat(d);break;case"max_concentration":h.max_concentration=parseInt(d);break;case"repose_angle":h.repose_angle=parseFloat(d);break}}}}}const s={};for(const o in t){const a=t[o],l=parseInt(o,10);if(a.name===void 0||a.category===void 0||a.base_color===void 0||a.variant_color===void 0||a.is_movable===void 0||a.density===void 0){console.warn(`[Loader] Corrupted particle block found of ID: ${l}. Missing core properties.`);continue}let r={id:l,name:a.name,baseColor:a.base_color,variantColor:a.variant_color,isMovable:a.is_movable,density:a.density};a.category===1?s[l]={...r,category:1}:a.category===2?s[l]={...r,maxConcentration:a.max_concentration,category:2}:a.category===3?s[l]={...r,category:3}:a.category===4?s[l]={...r,category:4,reposeAngle:a.repose_angle,reposeDirections:z.calculateRepose(a.repose_angle)}:a.category===5&&(s[l]={...r,category:5})}return s[0]={id:0,name:"Empty",category:0,baseColor:"#0E0E11",variantColor:"#0E0E11",isMovable:!0,density:0},s}async function ot(c){const e=await V(c),t={},i=e.split(/\r?\n/);for(const n of i){const s=n.trim();if(s.length===0||s.startsWith("#"))continue;const o=s.indexOf("."),a=s.indexOf(":");if(a===-1||o===-1||o>=a)continue;const l=s.substring(0,o).trim(),r=s.substring(o+1,a).trim(),d=s.substring(a+1).trim();if(!l||!r||d===void 0||d.length===0)continue;let h;if(l==="engine")switch(r){case"width":h=parseInt(d),isNaN(h)||(t.gameWidth=h);break;case"height":h=parseInt(d),isNaN(h)||(t.gameHeight=h);break;case"render_interval":h=parseFloat(d),isNaN(h)||(t.renderInterval=h);break;case"physics_interval":h=parseFloat(d),isNaN(h)||(t.physicsInterval=h);break}else if(l==="input")switch(r){case"brush_size":h=parseInt(d),isNaN(h)||(t.brushSize=h);break;case"brush_max_size":h=parseInt(d),isNaN(h)||(t.brushMaxSize=h);break;case"brush_sensitivity":h=parseFloat(d),isNaN(h)||(t.brushSensitivity=h);break}else if(l==="debug")switch(r){case"start_enabled":d.toLowerCase()==="true"?t.debugEnabled=!0:d.toLowerCase()==="false"&&(t.debugEnabled=!1);break;case"overlay_start_enabled":d.toLowerCase()==="true"?t.debugOverlayEnabled=!0:d.toLowerCase()==="false"&&(t.debugOverlayEnabled=!1);break}}return{gameWidth:t.gameWidth??342,gameHeight:t.gameHeight??192,renderInterval:t.renderInterval??16.667,physicsInterval:t.physicsInterval??25,brushSize:t.brushSize??4,brushMaxSize:t.brushMaxSize??42,brushSensitivity:t.brushSensitivity??.02,debugEnabled:t.debugEnabled??!1,debugOverlayEnabled:t.debugOverlayEnabled??!1}}class at{constructor(e){this.mouseX=0,this.mouseY=0,this.isLeftMouseButtonDown=!1,this.isRightMouseButtonDown=!1,this.isBrushOutlineVisible=!1,this.gameWidth=e.gameWidth,this.gameHeight=e.gameHeight,this.brushMaxSize=e.brushMaxSize,this.brushSensitivity=e.brushSensitivity,this.selectedParticleId=0,this.selectedCategoryId=2,this.renderInterval=e.renderInterval,this.physicsInterval=e.physicsInterval,this.currentBrushSize=e.brushSize}}async function rt(){try{const c=Y("viewport",HTMLDivElement),e=Y("render-surface",HTMLCanvasElement),t=await st("./src/data/particles.data");if(!t)throw new Error('Failed to load particle data from "./src/data/particles.data"');const i=await ot("./src/data/settings.data");if(!i)throw new Error('Failed to load settings from "./src/data/settings.data"');const n=new at(i),s=new Z(n,e),o=new nt(n,c,e,t),a=new it(n,c,!1);new tt(n,s,o,a,t).start(),console.log(t),dt(c)}catch(c){console.error("ERROR: Failed to initialize app:",c)}}function Y(c,e){const t=document.getElementById(c);if(!(t instanceof e))throw new Error(`Missing or invalid <${e.name.toLowerCase()} id='${c}'> element in DOM.`);return t}rt();function dt(c){const e={x:80,y:80},t={width:380,height:600},i={width:800,height:1200},n=new W(c,"Demo Window",e,t,i),s=new H;s.addTitle("Emitter Controls");const o={width:300,height:100};s.addImage(o,"./assets/preview_image.jpg","Windows XP Background Image"),s.addText("Server Status: Source code loaded.","#4cae50"),s.addSeparator(1),s.addSection("Emitor Settings"),s.addSlider("Emitor Size",0,38,14,1),s.addSlider("Opacity",0,1,.9,.01),s.addToggleSwitch("Anti-aliasing"),s.addDropdownButton("GPU Render Mode",["Fastest","High Quality","Wireframe","Debug"]),s.addSeparator(1),s.addSection("Save & Load"),s.addButton("Save Emitor","save-emitor","#73a2e0ff"),s.addButton("Load Emitor","load-emitor","#84da62ff"),s.addButton("Delete Emitor","delete-emitor","#e04e4eff"),n.addNewContent(s.contentElement,"Emitor Controls","./assets/icons/electronics.svg");const a=new H;a.addTitle("Application Settings"),a.addSection("Display"),a.addDropdownButton("Theme",["Light","Dark","System Default","Cyan","party","Amogus","Sus","nerd","nerd2","nerd3"]),a.addSlider("Brightness",0,100,75,1),a.addToggleSwitch("Enable Animations"),a.addSeparator(1),a.addSection("Performance"),a.addDropdownButton("Render Backend",["Auto","WebGPU","WebGL"]),a.addToggleSwitch("Use Hardware Acceleration"),a.addSlider("Max FPS",30,240,120,10),a.addSeparator(1),a.addSection("System"),a.addButton("Reset Settings","reset-settings","#e04e4eff"),a.addButton("Check for Updates","check-updates"),n.addContentBarSeparator(!0),n.addNewContent(a.contentElement,"Settings","./assets/icons/settings.svg")}
