var _t=l=>{throw TypeError(l)};var at=(l,t,e)=>t.has(l)||_t("Cannot "+e);var h=(l,t,e)=>(at(l,t,"read from private field"),e?e.call(l):t.get(l)),w=(l,t,e)=>t.has(l)?_t("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(l):t.set(l,e),_=(l,t,e,n)=>(at(l,t,"write to private field"),n?n.call(l,e):t.set(l,e),e),x=(l,t,e)=>(at(l,t,"access private method"),e);var ct=(l,t,e,n)=>({set _(i){_(l,t,i,e)},get _(){return h(l,t,n)}});(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}})();const dt={GAME_WIDTH:342,GAME_HEIGHT:192,SELECTED_PARTICLE:10,SELECTED_CATEGORY:1,BRUSH_MAX_SIZE:42,BRUSH_CUR_SIZE:4,BRUSH_SENSITIVITY:.02,CURRENT_PRESSURE:0,CURRENT_CONCENTRATION:1,DEBUG_START_ENABLED:!0,DEBUG_OVERLAY_START_ENABLED:!1,RENDER_UPDATE_INTERVAL:16.667,PHYSICS_UPDATE_INTERVAL:25},pt={lerp(l,t,e){return l+(t-l)*e},shuffleArray(l){const t=[...l];for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t},calculateRepose(l){let t=Math.max(10,Math.min(l,80));const e=t*Math.PI/180;let n=[];if(n.push([{dx:0,dy:-1}]),t<50){n.push([{dx:1,dy:-1},{dx:-1,dy:-1}]);const i=Math.round(1/Math.tan(e));n.push([{dx:i,dy:-1},{dx:i*-1,dy:-1}])}else{const i=Math.round(Math.tan(e));n.push([{dx:1,dy:-i},{dx:-1,dy:-i}])}return n}};async function bt(l){try{const t=await fetch(l);if(!t.ok)throw new Error(`HTTP error! Status: ${t.status}`);return await t.text()}catch(t){throw console.error(`Failed to read particle data from ${l}:`,t),new Error("Failed to load particle data.")}}async function St(l){const t=await bt(l);let e={},n=new Set,i=null;for(const s of t.split(`
`)){const r=s.trim();if(!(r.length===0||r.startsWith("#"))){if(r.startsWith("[")&&r.endsWith("]")){const c=r.slice(1,-1),a=parseInt(c,10);if(isNaN(a)||a<10){i=null;continue}if(n.has(a)){console.warn(`[Loader] Duplicate ID found: ${a}. Ignoring.`),i=null;continue}n.add(a),i=a,e[a]={};continue}if(i!==null){const c=r.split(":").map(a=>a.trim());if(c.length===2){const a=c[0],d=c[1],u=e[i];switch(a){case"name":u.name=d;break;case"category":u.category=parseInt(d,10);break;case"base_color":u.base_color=d;break;case"variant_color":u.variant_color=d;break;case"is_movable":u.is_movable=d==="true";break;case"density":u.density=parseFloat(d);break;case"max_concentration":u.max_concentration=parseInt(d);break;case"repose_angle":u.repose_angle=parseFloat(d);break}}}}}const o={};for(const s in e){const r=e[s],c=parseInt(s,10);if(r.name===void 0||r.category===void 0||r.base_color===void 0||r.variant_color===void 0||r.is_movable===void 0||r.density===void 0){console.warn(`[Loader] Corrupted particle block found of ID: ${c}. Missing core properties.`);continue}let a={id:c,name:r.name,baseColor:r.base_color,variantColor:r.variant_color,isMovable:r.is_movable,density:r.density};r.category===1?o[c]={...a,category:1}:r.category===2?o[c]={...a,maxConcentration:r.max_concentration,category:2}:r.category===3?o[c]={...a,category:3}:r.category===4?o[c]={...a,category:4,reposeAngle:r.repose_angle,reposeDirections:pt.calculateRepose(r.repose_angle)}:r.category===5&&(o[c]={...a,category:5})}return o[0]={id:0,name:"Empty",category:0,baseColor:"#0E0E11",variantColor:"#0E0E11",isMovable:!0,density:0},o}var B,mt,yt,lt;class Tt{constructor(t,e){w(this,B);this._canvas=t,this._ctx=this._canvas.getContext("2d"),this._renderWidth=e.GAME_WIDTH,this._renderHeight=e.GAME_HEIGHT,this._frameBuffer=new Uint8ClampedArray(this._renderWidth*this._renderHeight*4),this._queuedParticles=[],this._queuedOverlayPixels=[],this._queuedUIPixels=[],this._canvas.width=this._renderWidth,this._canvas.height=this._renderHeight,this._ctx.imageSmoothingEnabled=!1,this._ctx.translate(0,this._canvas.height),this._ctx.scale(1,-1)}queueUIPixels(t){this._queuedUIPixels=[],this._queuedUIPixels=t}queueParticles(t,e){if(this._queuedParticles.push(...t),e){const n=this._renderWidth,i=this._renderHeight;for(const o of t){const r=(i-1-o.position.y)*n+o.position.x;this._queuedOverlayPixels.push({index:r,value:e})}}}queueOverlayPixels(t){this._queuedOverlayPixels.push(...t)}renderThisFrame(){x(this,B,mt).call(this);let t=new Uint8ClampedArray(this._frameBuffer);x(this,B,lt).call(this,t,this._queuedOverlayPixels),x(this,B,lt).call(this,t,this._queuedUIPixels);const e=new ImageData(t,this._renderWidth,this._renderHeight);this._ctx.putImageData(e,0,0),this._queuedParticles.length=0,this._queuedOverlayPixels=[],this._queuedUIPixels=[]}}B=new WeakSet,mt=function(){const t=this._queuedParticles,e=this._renderWidth,n=this._renderHeight;for(const i of t){const o=i.position.x,s=i.position.y,c=(n-1-s)*e+o;let a=x(this,B,yt).call(this,i);this._frameBuffer[c*4+0]=a[0],this._frameBuffer[c*4+1]=a[1],this._frameBuffer[c*4+2]=a[2],this._frameBuffer[c*4+3]=a[3]}},yt=function(t){return t.color},lt=function(t,e){for(const{index:n,value:i}of e){const o=t[n*4+0],s=t[n*4+1],r=t[n*4+2],c=t[n*4+3],a=i[0],d=i[1],u=i[2],f=i[3],g=f/255,y=Math.round(a*g+o*(1-g)),p=Math.round(d*g+s*(1-g)),m=Math.round(u*g+r*(1-g)),v=Math.min(c,f);t[n*4+0]=y,t[n*4+1]=p,t[n*4+2]=m,t[n*4+3]=v}};const ft=Object.freeze({WHITE:new Uint8ClampedArray([255,255,255,255]),BLACK:new Uint8ClampedArray([0,0,0,255]),GRAY:new Uint8ClampedArray([128,128,128,255]),RED:new Uint8ClampedArray([255,0,0,255]),GREEN:new Uint8ClampedArray([0,255,0,255]),BLUE:new Uint8ClampedArray([0,0,255,255]),YELLOW:new Uint8ClampedArray([255,255,0,255]),CYAN:new Uint8ClampedArray([0,255,255,255]),MAGENTA:new Uint8ClampedArray([255,0,255,255]),TRANSPARENT_BLACK:new Uint8ClampedArray([0,0,0,0]),SEMI_TRANSPARENT_WHITE:new Uint8ClampedArray([255,255,255,128])}),$={createColor(l){return this.hexToColor(l)},hexToColor(l){if(l==null)return ft.BLACK;let t=l.replace("#","");if(t.length===6)t+="FF";else if(t.length===3){let n="";for(const i of t)n+=i,n+=i;t=n+"FF"}else return ft.BLACK;const e=parseInt(t,16);return new Uint8ClampedArray([e>>24&255,e>>16&255,e>>8&255,e&255])},colorToHex(l){const[t,e,n,i]=l,o=s=>s.toString(16).padStart(2,"0");return`#${o(t)}${o(e)}${o(n)}${o(i)}`},lerpColor(l,t,e){const n=l[0]+(t[0]-l[0])*e,i=l[1]+(t[1]-l[1])*e,o=l[2]+(t[2]-l[2])*e,s=l[3]+(t[3]-l[3])*e;return new Uint8ClampedArray([n,i,o,s])},createColorRamp(l,t,e){if(e<2)return[l,t];const n=1/(e-1),i=new Array(e);for(let o=0;o<e;o++){const s=o*n;i[o]=this.lerpColor(l,t,s)}return i},invertColor(l){const t=255-l[0],e=255-l[1],n=255-l[2],i=l[3];return new Uint8ClampedArray([t,e,n,i])},getLuminance(l){const t=l[0],e=l[1],n=l[2];return .299*t+.587*e+.114*n}},Dt=Object.freeze({ALL_NEIGHBORS:[{dx:-1,dy:1},{dx:0,dy:1},{dx:1,dy:1},{dx:-1,dy:0},{dx:1,dy:0},{dx:-1,dy:-1},{dx:0,dy:-1},{dx:1,dy:-1}]}),st=Object.freeze({UP_LEFT:{dx:-1,dy:1},UP:{dx:0,dy:1},UP_RIGHT:{dx:1,dy:1},LEFT:{dx:-1,dy:0},RIGHT:{dx:1,dy:0},DOWN_LEFT:{dx:-1,dy:-1},DOWN:{dx:0,dy:-1},DOWN_RIGHT:{dx:1,dy:-1}});var I,O,z,ht,wt;class At{constructor(t,e,n){w(this,z);w(this,I);w(this,O);this.width=t,this.height=e,_(this,I,new Array(t*e)),_(this,O,new Set),this.ParticleDataBlueprint=n,x(this,z,wt).call(this,0)}get data(){return h(this,I)}get dirtyParticles(){return h(this,O)}createParticleAt(t,e,n,i,o){if(!this.isInBounds(t,e))return!1;let s=x(this,z,ht).call(this,n);return s.position.x=t,s.position.y=e,s.index=e*this.width+t,i&&this.markDirty(s,o),h(this,I)[e*this.width+t]=s,!0}getParticleAt(t,e){return this.isInBounds(t,e)?h(this,I)[e*this.width+t]:null}tryMoveParticle(t,e,n=!1,i=!1,o=!1){for(const s of e){if(!s)continue;const r=pt.shuffleArray(s);for(const c of r){let a=c.dx;n&&Math.random()>.5&&(a=c.dx*-1);const d=t.position.x+a,u=t.position.y+c.dy,f=this.getParticleAt(d,u);if(f&&f.isMovable&&t.density>f.density){h(this,I)[f.index]=t,h(this,I)[t.index]=f;const g={x:t.position.x,y:t.position.y},y=t.index;return t.position=f.position,t.index=f.index,f.position=g,f.index=y,i&&(this.markDirty(t,o),this.markDirty(f,o)),f}}}return null}swapParticles(t,e,n,i){h(this,I)[t.index]=e,h(this,I)[e.index]=t;const o={x:t.position.x,y:t.position.y},s=t.index;t.position=e.position,t.index=e.index,e.position=o,e.index=s,n&&(this.markDirty(t,i),this.markDirty(e,i))}getNeighborOf(t,e){const n=t.position.x+e.dx,i=t.position.y+e.dy;return this.getParticleAt(n,i)}getNeighborsOf(t,e,n,i){return e.map(s=>this.getNeighborOf(t,s)).filter(s=>s!==null).filter(s=>{const r=n===void 0||s.category===n,c=i===void 0||s.id===i;return r&&c})}markDirty(t,e){if(h(this,O).add(t.index),e){const n=this.getNeighborsOf(t,Dt.ALL_NEIGHBORS);for(const i of n)h(this,O).add(i.index)}}isInBounds(t,e){return t>=0&&t<this.width&&e>=0&&e<this.height}fillCircleAt(t,e,n,i){for(let o=-n;o<=n;o++)for(let s=-n;s<=n;s++){if(o*o+s*s>n*n)continue;const r=t+o,c=e+s;if(!this.isInBounds(r,c))continue;const a=this.getParticleAt(r,c);(i===0||a===null||a.id===0)&&this.createParticleAt(r,c,i,!0,!0)}}}I=new WeakMap,O=new WeakMap,z=new WeakSet,ht=function(t){const e=this.ParticleDataBlueprint[t];if(!e)return null;let i=Math.random(),s=6-1,r=Math.round(i*s)/s;const c=$.hexToColor(e.baseColor),a=$.hexToColor(e.variantColor),d=$.lerpColor(c,a,r);let u={handle:-1,id:e.id,name:e.name,color:d,position:{x:-1,y:-1},index:0,isMovable:e.isMovable,density:e.density};return e.category===0?{...u,category:0}:e.category===1?{...u,category:1}:e.category===2?{...u,category:2,concentration:0,maxConcentration:e.maxConcentration}:e.category===3?{...u,category:3}:e.category===4?{...u,category:4,reposeAngle:e.reposeAngle,reposeDirections:e.reposeDirections}:e.category===5?{...u,category:5,node:-1}:null},wt=function(t){const e=this.width,n=this.height;_(this,I,new Array(e*n));for(let i=0;i<n;i++)for(let o=0;o<e;o++){let s=i*e+o,r=x(this,z,ht).call(this,t);r&&(r.position.x=o,r.position.y=i,r.index=s,h(this,I)[s]=r,h(this,O).add(r.index))}};const gt=Object.keys(st);var W,et,X,it,nt,b,P,N,R,ot,V,U,G,j,rt,K,T,Et,Ct,vt,xt,Pt;class Mt{constructor(t,e,n,i,o){w(this,T);w(this,W);w(this,et);w(this,X);w(this,it);w(this,nt);w(this,b);w(this,P);w(this,N);w(this,R);w(this,ot);w(this,V);w(this,U);w(this,G);w(this,j,0);w(this,rt,60);w(this,K,t=>{if(!h(this,N))return;if(!h(this,U)){_(this,U,t),_(this,R,requestAnimationFrame(h(this,K)));return}const e=t-h(this,U);_(this,U,t),h(this,et).processInput(h(this,b),h(this,W)),_(this,G,h(this,G)+e);let n=0;for(;h(this,G)>=h(this,V);){const i=[];for(const s of h(this,b).dirtyParticles)i.push(h(this,b).data[s]);ct(this,j)._++,h(this,j)>h(this,rt)&&(h(this,b).dirtyParticles.clear(),_(this,j,0));const o=new Uint8ClampedArray([210,55,55,180]);h(this,W).queueParticles(i,h(this,X).isOverlayEnabled?o:void 0),x(this,T,Et).call(this,i),this.tickCount++,_(this,G,h(this,G)-h(this,V)),n++,n>60&&_(this,G,0)}h(this,W).renderThisFrame(),h(this,X).updateDisplay(t,this),_(this,R,requestAnimationFrame(h(this,K)))});_(this,W,n),_(this,et,i),_(this,X,o),_(this,it,e.GAME_WIDTH),_(this,nt,e.GAME_HEIGHT),_(this,b,new At(h(this,it),h(this,nt),t)),_(this,P,new Set),_(this,N,!1),_(this,R,null),_(this,ot,dt.RENDER_UPDATE_INTERVAL),_(this,V,dt.PHYSICS_UPDATE_INTERVAL),_(this,U,null),_(this,G,0),this.tickCount=0}start(){h(this,N)||(_(this,N,!0),h(this,K).call(this,0))}stop(){_(this,N,!1),h(this,R)&&(cancelAnimationFrame(h(this,R)),_(this,R,null))}groupParticles(t,e){const n=t.width,i=t.height,o=[],s=[],r={};for(let a=i-1;a>=0;a--)for(let d=0;d<n;d++){const u=a*n+d,f=t.getParticleAt(d,a);if(!f||f.category!==e||f.category!==e)continue;const g=t.getNeighborOf(f,st.UP),y=t.getNeighborOf(f,st.LEFT),p=g&&g.id===f.id,m=y&&y.id===f.id;let v=-1;m&&(v=a*n+(d-1));let D=-1;p&&(D=(a+1)*n+d);const H=g&&g.id===0;if(!m&&!p){const E=s.length;o.push([u]),s.push({liquidParticle:[],emptyParticle:[]}),H&&(s[E].liquidParticle.push(f),s[E].emptyParticle.push(g)),r[u]=E}else if(m&&!p){const E=r[v];o[E].push(u),H&&(s[E].liquidParticle.push(f),s[E].emptyParticle.push(g)),r[u]=E}else if(!m&&p){const E=r[D];o[E].push(u),H&&(s[E].liquidParticle.push(f),s[E].emptyParticle.push(g)),r[u]=E}else{const E=r[D];o[E].push(u),H&&(s[E].liquidParticle.push(f),s[E].emptyParticle.push(g)),r[u]=E;const L=r[v];if(L!==E){const C=s[L];for(const S of C.liquidParticle)s[E].liquidParticle.push(S);for(const S of C.emptyParticle)s[E].emptyParticle.push(S);const q=o[L];for(const S of q)r[S]=E;o[L]=[],s[L]={liquidParticle:[],emptyParticle:[]}}}}return s.filter(a=>a.liquidParticle.length>30)}}W=new WeakMap,et=new WeakMap,X=new WeakMap,it=new WeakMap,nt=new WeakMap,b=new WeakMap,P=new WeakMap,N=new WeakMap,R=new WeakMap,ot=new WeakMap,V=new WeakMap,U=new WeakMap,G=new WeakMap,j=new WeakMap,rt=new WeakMap,K=new WeakMap,T=new WeakSet,Et=function(t){h(this,P).clear(),t=pt.shuffleArray(t),t.sort((n,i)=>n.position.y-i.position.y);for(const n of t)if(n&&!h(this,P).has(n.index))switch(n.category){case 1:break;case 2:x(this,T,Ct).call(this,n);break;case 3:x(this,T,vt).call(this,n);break;case 4:x(this,T,xt).call(this,n);break;case 5:break;default:continue}let e=this.groupParticles(h(this,b),2);x(this,T,Pt).call(this,e)},Ct=function(t){let e=[[{dx:0,dy:-1}],[{dx:-1,dy:-1},{dx:1,dy:-1}],[{dx:-1,dy:0},{dx:1,dy:0}]];const n=h(this,b).tryMoveParticle(t,e,!1,!0,!0);n&&(h(this,P).add(t.index),h(this,P).add(n.index))},vt=function(t){const e=gt[Math.floor(Math.random()*gt.length)];let i=[[st[e]]];const o=h(this,b).tryMoveParticle(t,i,!1,!0,!0);o&&(h(this,P).add(t.index),h(this,P).add(o.index))},xt=function(t){let e=t.reposeDirections;const n=h(this,b).tryMoveParticle(t,e,!0,!0,!0);n&&(h(this,P).add(t.index),h(this,P).add(n.index))},Pt=function(t){for(const e of t){const n=e.liquidParticle.sort((c,a)=>a.position.y-c.position.y),i=e.emptyParticle.sort((c,a)=>c.position.y-a.position.y),o=n.length;let s=0;const r=o/4;for(let c=0;c<o;c++){const a=n[c],d=i[c];if(Math.sqrt(a.position.x*d.position.x+a.position.y*d.position.y),a.position.y>d.position.y&&(h(this,b).swapParticles(a,d,!0,!0),h(this,P).add(a.index),h(this,P).add(d.index),s++,s>=r))break}}};const M=class M{constructor(t,e,n,i,o,s,r,c,a){this._containers=[],this._categoryButtons=[],this._onFocus=()=>{this._isFocused||(M.currentZIndex++,this._window.style.zIndex=M.currentZIndex.toString())},this._onPointerDown=d=>{if(d.stopPropagation(),this._onFocus(),d.button===0){this._titlebar.setPointerCapture(d.pointerId);const u=this._window.getBoundingClientRect();this._dragOffset.x=d.clientX-u.left,this._dragOffset.y=d.clientY-u.top,this._isDragging=!0}else this._isDragging=!1},this._onPointerUp=d=>{this._isDragging&&(this._titlebar.releasePointerCapture(d.pointerId),this._isDragging=!1)},this._onPointerMove=d=>{if(this._isDragging){const u=d.clientX-this._dragOffset.x,f=d.clientY-this._dragOffset.y;this._moveWindow(u,f)}},this._onCloseButtonClick=d=>{this._closeWindow()},this._onViewportResize=()=>{this._snapWindowBacc()},this._stopDragPropagation=d=>{d.stopPropagation()},this._handleGlobalClick=d=>{document.querySelectorAll(".dropdown-list.is-open").forEach(u=>{const f=u.closest(".custom-dropdown-container");f&&!f.contains(d.target)&&u.classList.remove("is-open")})},this.hostElement=t,i.width=Math.max(40,Math.min(i.width,o.width)),i.height=Math.max(40,Math.min(i.height,o.height)),this._size=i,this._maxSize=o,this._isFocused=!1,this._isDragging=!1,this._dragOffset={x:0,y:0},this._selectedCategory=0,this._initWindow(e,n,s,r,c,a),this._addEventListener(),this._onFocus(),document.addEventListener("click",this._handleGlobalClick)}destroy(){this._closeWindow(),document.removeEventListener("click",this._handleGlobalClick)}_initWindow(t,e,n,i,o,s){const r=document.createElement("div");r.classList.add("ui-window"),this.hostElement.appendChild(r),this._window=r,this._window.style.left=`${e.x}px`,this._window.style.top=`${e.y}px`,this._window.style.width=`${this._size.width}px`,this._window.style.height=`${this._size.height}px`,this._window.style.maxWidth=`${this._maxSize.width}px`,this._window.style.maxHeight=`${this._maxSize.height}px`;const c=document.createElement("div");c.classList.add("ui-window__titlebar"),this._window.appendChild(c),this._titlebar=c;const a=document.createElement("span");a.classList.add("ui-window__title"),a.textContent=t,c.appendChild(a);const d=document.createElement("div");d.classList.add("ui-window__controls"),this._titlebar.appendChild(d);const u=document.createElement("button");u.classList.add("ui-window__title-button");const f=document.createElement("img");f.src="./assets/icons/close.svg",u.appendChild(f),d.appendChild(u),this._closeButton=u;const g=document.createElement("div");g.classList.add("ui-window__content-area"),g.style.flexDirection=n==="left"||n==="right"?"row":"column",this._window.appendChild(g),this._contentArea=g;const y=document.createElement("div");y.classList.add("ui-window__category-strip",`strip-${n}`),this._categoryStrip=y;const p=document.createElement("div");p.classList.add("ui-window__content-container"),this._contentContainer=p,n==="left"||n==="top"?(g.appendChild(y),g.appendChild(p)):(g.appendChild(p),g.appendChild(y));let m=null;s?m=s:(m=document.createElement("div"),m.classList.add("ui-window__content")),m.id="container-0",p.appendChild(m),this._containers.push(m),this._createNewCategory(i,o,0)}_addEventListener(){this._window.addEventListener("mousedown",this._onFocus),this._titlebar.addEventListener("pointerdown",this._onPointerDown),this._titlebar.addEventListener("pointermove",this._onPointerMove),this._titlebar.addEventListener("pointerup",this._onPointerUp),this._closeButton.addEventListener("click",this._onCloseButtonClick),this._closeButton.addEventListener("pointerdown",this._stopDragPropagation),window.addEventListener("resize",this._onViewportResize)}_closeWindow(){window.removeEventListener("resize",this._onViewportResize),this._titlebar.removeEventListener("pointerdown",this._onPointerDown),this._titlebar.removeEventListener("pointermove",this._onPointerMove),this._titlebar.removeEventListener("pointerup",this._onPointerUp),this._window.removeEventListener("mousedown",this._onFocus),this._window&&this._window.parentElement&&this._window.parentElement.removeChild(this._window)}_moveWindow(t,e){const n=this._window.offsetWidth,i=this._window.offsetHeight,o=Math.max(0,Math.min(t,window.innerWidth-n)),s=Math.max(0,Math.min(e,window.innerHeight-i));this._window.style.left=`${o}px`,this._window.style.top=`${s}px`}_snapWindowBacc(){const t=this._window.offsetWidth,e=this._window.offsetHeight,n=Math.max(0,window.innerWidth-t),i=Math.max(0,window.innerHeight-e),o=this._window.offsetLeft,s=this._window.offsetTop;let r=o,c=s;o>n?r=n:o<0&&(r=0),s>i?c=i:s<0&&(c=0),(r!==o||c!==s)&&(this._window.style.left=`${r}px`,this._window.style.top=`${c}px`)}_showCategory(t){this._selectedCategory=t,this._containers.forEach((n,i)=>{n.style.display=i===t?"":"none"}),this._categoryStrip.querySelectorAll(".ui-window__category-button").forEach((n,i)=>{i===t?n.classList.add("active"):n.classList.remove("active")})}_createNewCategory(t,e,n){const i=document.createElement("button");i.classList.add("ui-window__category-button");const o=document.createElement("img");return o.alt=t,o.src=e,i.title=t,o.classList.add("ui-window__category-icon"),i.appendChild(o),this._categoryButtons.push(i),this._categoryStrip.appendChild(i),i.addEventListener("click",()=>this._showCategory(n)),i}getAllCategoryContainer(){return this._containers}getAllCategoryButtons(){return this._categoryButtons}addCategory(t,e,n){let i=this._containers.length,o=null;n?o=n:(o=document.createElement("div"),o.classList.add("ui-window__content")),o.id="container-"+i,o.style.display="none",this._contentContainer.appendChild(o),this._containers.push(o);const s=this._createNewCategory(t,e,i);return this._categoryStrip.style.display="flex",s}addCategorySpacer(){const t=document.createElement("div");return t.classList.add("ui-flex-spacer"),this._categoryStrip.appendChild(t),t}addCategoryDivider(){const t=document.createElement("div");return t.classList.add("ui-flex-divider"),this._categoryStrip.appendChild(t),t}addTitle(t,e){const n=this._containers[t];if(!n)return null;const i=document.createElement("h2");return i.classList.add("ui-title"),i.textContent=e,n.appendChild(i),i}addSection(t,e){const n=this._containers[t];if(!n)return null;const i=document.createElement("h4");return i.classList.add("ui-section"),i.textContent=e,n.appendChild(i),i}addDivider(t){const e=this._containers[t];if(!e)return null;const n=document.createElement("div");return n.classList.add("ui-window__divider"),e.appendChild(n),n}addText(t,e,n,i,o){const s=this._containers[t];if(!s)return null;const r=document.createElement("p");return r.classList.add("ui-text"),r.textContent=e,n&&(r.style.color=n),o&&(r.id=o),i&&(r.style.fontWeight=i),s.appendChild(r),r}addLink(t,e,n){const i=this._containers[t];if(!i)return null;const o=document.createElement("p");o.classList.add("ui-text");const s=document.createElement("a");return s.href=n,s.textContent=e,s.target="_blank",o.appendChild(s),i.appendChild(o),o}addBulletedList(t,e){const n=this._containers[t];if(!n)return null;const i=document.createElement("ul");return i.classList.add("ui-text"),e.forEach(o=>{const s=document.createElement("li");s.textContent=o,i.appendChild(s)}),n.appendChild(i),i}addNumberedList(t,e){const n=this._containers[t];if(!n)return null;const i=document.createElement("ol");return i.classList.add("ui-text"),e.forEach(o=>{const s=document.createElement("li");s.textContent=o,i.appendChild(s)}),n.appendChild(i),i}addImage(t,e,n,i){const o=this._containers[t];if(!o)return null;const s=document.createElement("img");return s.classList.add("ui-image"),s.src=e,s.alt=n,s.width=i.width,s.height=i.height,o.appendChild(s),s}addSlider(t,e,n,i,o){const s=this._containers[t];if(!s)return null;const r=document.createElement("div");r.classList.add("flex-row");const c=document.createElement("label");c.textContent=e+":",r.appendChild(c);const a=document.createElement("input");a.type="range",a.id=n+"-range",a.min=i.x.toString(),a.max=i.y.toString(),a.value=o.toString(),i.y-i.x<2&&i.y>i.x&&(a.step=.01.toString()),r.appendChild(a);const d=document.createElement("input");return d.style.minWidth="40px",d.type="number",d.id=n+"-number",d.min=i.x.toString(),d.max=i.y.toString(),d.value=o.toString(),a.oninput=()=>d.value=a.value,d.onchange=()=>{const u=Math.max(i.x,Math.min(i.y,parseInt(d.value))).toString();a.value=u,d.value=u},r.appendChild(d),s.appendChild(r),r}addTextInput(t,e,n,i,o){const s=this._containers[t];if(!s)return null;const r=document.createElement("div");r.classList.add("flex-row","ui-text-input-container");const c=document.createElement("label");c.textContent=e+":",c.htmlFor=o,r.appendChild(c);const a=document.createElement("input");return a.type="text",a.id=o,a.placeholder=n,a.value=i,r.appendChild(a),s.appendChild(r),r}addButton(t,e,n,i){const o=this._containers[t];if(!o)return null;const s=document.createElement("button");return s.classList.add("ui-window__content__Button"),s.textContent=e,s.id=n,i&&(s.style.backgroundColor=i),o.appendChild(s),s}addDropdown(t,e,n,i){const o=this._containers[t];if(!o)return null;const s=document.createElement("div");s.classList.add("flex-row");const r=document.createElement("label");r.textContent=e+":",s.appendChild(r);const c=document.createElement("div");c.classList.add("custom-dropdown-container");const a=document.createElement("div");a.classList.add("dropdown-button"),a.innerHTML=`
          <span id="${n}-display">${i[0]}</span>
      `,c.appendChild(a);const d=document.createElement("ul");d.classList.add("dropdown-list"),d.id=n+"-list",c.appendChild(d);let u=0,f=[];return i.forEach((g,y)=>{const p=document.createElement("li");p.style.marginBottom="0px",p.classList.add("dropdown-item"),p.textContent=g,p.dataset.value=g.toLowerCase().replace(/\s/g,"-"),p.dataset.index=y.toString(),y===u&&p.classList.add("is-selected"),p.addEventListener("click",m=>{m.stopPropagation(),f[u].classList.remove("is-selected"),u=y,p.classList.add("is-selected"),document.getElementById(`${n}-display`).textContent=g,d.classList.remove("is-open")}),d.appendChild(p),f.push(p)}),a.addEventListener("click",g=>{if(g.stopPropagation(),document.querySelectorAll(".dropdown-list.is-open").forEach(p=>{p!==d&&p.classList.remove("is-open")}),d.classList.toggle("is-open")){const p=M.DROPDOWN_ITEM_HEIGHT,m=M.DROPDOWN_BUTTON_HEIGHT,v=u*p,D=m-v;d.style.transform=`translateY(${D-m-6}px)`,d.style.top="0px",d.scrollTop=v}}),s.appendChild(c),o.appendChild(s),s}addToggleSwitch(t,e,n,i=!1){const o=this._containers[t];if(!o)return null;const s=document.createElement("div");s.classList.add("flex-row");const r=document.createElement("label");r.textContent=e+":",s.appendChild(r);const c=document.createElement("div");c.classList.add("toggle-container");const a=document.createElement("div");return a.classList.add("toggle-switch"),a.id=n+"-switch",i&&a.classList.add("is-on"),a.innerHTML=`
          <span class="toggle-indicator indicator-o">O</span> 
          <span class="toggle-indicator indicator-i">I</span> 
          <div class="toggle-slider"></div>
      `,a.addEventListener("click",()=>{a.classList.toggle("is-on")}),c.appendChild(a),s.appendChild(c),o.appendChild(s),s}};M.currentZIndex=100,M.DROPDOWN_ITEM_HEIGHT=30,M.DROPDOWN_BUTTON_HEIGHT=30;let ut=M;class Rt{constructor(t,e,n,i,o){this._onPointerDown=s=>{this._activePointerId=s.pointerId,s.button===0?(this.isPainting=!0,this.isErasing=!1,this.activeButton="left"):s.button===2?(this.isErasing=!0,this.isPainting=!1,this.activeButton="right"):(this.isPainting=!1,this.isErasing=!1,this.activeButton="none");try{this._canvas.setPointerCapture(s.pointerId)}catch{}const r=this._canvas.getBoundingClientRect(),c=this._width/r.width,a=this._height/r.height;this.latestMouseCoords.x=(s.clientX-r.left)*c,this.latestMouseCoords.y=this._canvas.height-(s.clientY-r.top)*a},this._onPointerUp=s=>{if(this._activePointerId===s.pointerId){this._activePointerId=null,this.activeButton="none";try{this._canvas.releasePointerCapture(s.pointerId)}catch{}}this.isPainting=!1,this.isErasing=!1},this._onPointerMove=s=>{const r=this._canvas.getBoundingClientRect(),c=this._width/r.width,a=this._canvas.height/r.height;if(this.latestMouseCoords.x=(s.clientX-r.left)*c,this.latestMouseCoords.y=this._canvas.height-(s.clientY-r.top)*a,typeof s.buttons=="number"){const d=(s.buttons&1)===1,u=(s.buttons&2)===2;this.isPainting=d,this.isErasing=u}},this._onPointerCancel=s=>{if(this.isPainting=!1,this.isErasing=!1,this._activePointerId===s.pointerId){try{this._canvas.releasePointerCapture(s.pointerId)}catch{}this._activePointerId=null,this.activeButton="none"}},this._onWindowPointerUp=()=>{this.isPainting=!1,this.isErasing=!1,this._activePointerId=null,this.activeButton="none"},this._onVisibilityChange=()=>{document.hidden&&(this.isPainting=!1,this.isErasing=!1,this._activePointerId=null,this.activeButton="none")},this._onWheel=s=>{s.preventDefault(),this.shouldChangeBrushSize=!0,this.changeBrushSizeDir=s.deltaY},this._onContextMenu=s=>{s.preventDefault()},this._onPointerEnter=()=>{this.isDrawingOverlay=!0},this._onPointerLeave=()=>{this.isDrawingOverlay=!1},this._mainContainer=e,this._canvas=n,this._renderer=o,this._width=i.GAME_WIDTH,this._height=i.GAME_HEIGHT,this._brushSizeSensitivity=i.BRUSH_SENSITIVITY,this._maxBrushSize=i.BRUSH_MAX_SIZE,this._selectedParticle=i.SELECTED_PARTICLE,this._selectedCategory=i.SELECTED_CATEGORY,this._currentBrushSize=i.BRUSH_CUR_SIZE,this._currentPressure=i.CURRENT_PRESSURE,this._currentConcentration=i.CURRENT_CONCENTRATION,this._activePointerId=null,this.isPainting=!1,this.isErasing=!1,this.isDrawingOverlay=!0,this.shouldChangeBrushSize=!1,this.changeBrushSizeDir=0,this.latestMouseCoords={x:0,y:0},this.activeButton="none",this._addEventListeners(),this._addParticlePalette(t)}processInput(t,e){const n=this.latestMouseCoords.x,i=this.latestMouseCoords.y,o={x:Math.floor(n),y:Math.floor(i)};if(this.isDrawingOverlay){const s=this._calculateBrushOutline(o.x,o.y);e.queueUIPixels(s)}if(this.isPainting||this.isErasing){const s=o.x<this._width+this._currentBrushSize&&o.x>=0-this._currentBrushSize,r=o.y<this._height+this._currentBrushSize&&o.y>=0-this._currentBrushSize;if(s&&r){const c=o.x,a=o.y,d=this.isPainting?this._selectedParticle:0;t.fillCircleAt(c,a-1,this._currentBrushSize,d)}}if(this.shouldChangeBrushSize){const s=this.changeBrushSizeDir*this._brushSizeSensitivity;let r=this._currentBrushSize-s;r=Math.floor(r),r=Math.min(this._maxBrushSize,r),r=Math.max(0,r),this._currentBrushSize=r,this.changeBrushSizeDir=0}}_addEventListeners(){const t=this._canvas;t.addEventListener("pointerdown",this._onPointerDown),t.addEventListener("pointermove",this._onPointerMove),t.addEventListener("pointerup",this._onPointerUp),t.addEventListener("pointercancel",this._onPointerCancel),t.addEventListener("lostpointercapture",this._onPointerCancel),t.addEventListener("pointerenter",this._onPointerEnter),t.addEventListener("pointerleave",this._onPointerLeave),t.addEventListener("focus",this._onPointerEnter),t.addEventListener("blur",this._onPointerLeave),t.addEventListener("wheel",this._onWheel,{passive:!1}),this._mainContainer.addEventListener("contextmenu",this._onContextMenu),window.addEventListener("pointerup",this._onWindowPointerUp),window.addEventListener("mouseup",this._onWindowPointerUp),document.addEventListener("visibilitychange",this._onVisibilityChange)}_addParticlePalette(t){const e={x:320,y:300},n={width:250,height:200},i={width:420,height:400},o=document.createElement("div");o.classList.add("particle-palette-container");const s=new ut(this._mainContainer,"Particle Palette",e,n,i,"bottom","Solids","./assets/icons/solid.svg",o),r=document.createElement("div");r.classList.add("particle-palette-container"),s.addCategory("Liquids","./assets/icons/liquid.svg",r);const c=document.createElement("div");c.classList.add("particle-palette-container"),s.addCategory("Gases","./assets/icons/gas.svg",c);const a=document.createElement("div");a.classList.add("particle-palette-container"),s.addCategory("Sands","./assets/icons/sand.svg",a);const d=document.createElement("div");d.classList.add("particle-palette-container"),s.addCategory("Electronics","./assets/icons/electronics.svg",d),s.addCategorySpacer(),s.addCategory("Settings","./assets/icons/settings.svg"),s._showCategory(1),this._selectedCategory=2;const u=s.getAllCategoryContainer(),f=s.getAllCategoryButtons();for(let y=0;y<f.length-1;y++)f[y].addEventListener("click",()=>{for(const m of u){const v=m.querySelector(".selected");v&&v.classList.remove("selected")}const p=u[y];if(p){const m=p.querySelector(".particle-button");m&&(m.classList.add("selected"),this._selectedParticle=parseInt(m.dataset.particleId||"-1",10),this._selectedCategory=parseInt(m.dataset.category||"-1",10))}});let g=!1;for(const y in t){const p=t[y];if(!p)continue;const m=u[p.category-1];if(!m)continue;const v=p.baseColor,D=p.variantColor,E=$.getLuminance($.hexToColor(v))>210?"#323238":"#FFFFFFFF",L=$.hexToColor(E),C=document.createElement("button");C.className="particle-button",C.textContent=p.name,C.style.setProperty("--particle-button-base-color",v),C.style.setProperty("--particle-button-variant-color",D),C.style.color=E,C.style.textShadow=`1px 1px 2px rgba(${L[0]}, ${L[1]}, ${L[2]}, 0.6)`,C.dataset.particleId=p.id.toString(),C.dataset.category=p.category.toString(),C.addEventListener("click",()=>{for(const q of u){const S=q.querySelector(".selected");S&&S.classList.remove("selected")}C.classList.add("selected"),this._selectedParticle=p.id,this._selectedCategory=p.category}),m.appendChild(C),!g&&p.category===this._selectedCategory&&(C.classList.add("selected"),this._selectedParticle=p.id,g=!0)}}_calculateBrushOutline(t,e){const n=this._currentBrushSize,i=[],o=227,s=227,r=227,c=180,a=this._width,d=this._height,u=[-1,1],f=(m,v)=>{for(const D of u)for(const H of u){const E=t+m*H,L=e+v*D,C=t+v*H,q=e+m*D;if(E>=0&&E<a&&L>=0&&L<d){const S=(d-L)*a+E;i.push({index:S,value:new Uint8ClampedArray([o,s,r,c])})}if(C>=0&&C<a&&q>=0&&q<d){const S=(d-q)*a+C;i.push({index:S,value:new Uint8ClampedArray([o,s,r,c])})}}};let g=n,y=0,p=n-n;for(f(g,y);y<g;)y++,p<0?p+=2*y+1:(g--,p+=2*(y-g)+1),f(g,y);return i}}var F,k,A,Y,Z,J,Q,tt,Lt,It;class Bt{constructor(t){w(this,tt);w(this,F);w(this,k);w(this,A);w(this,Y);w(this,Z);w(this,J);w(this,Q);_(this,F,!1),_(this,k,!1),_(this,A,new Map),_(this,Y,0),_(this,Z,0),_(this,J,0),_(this,Q,0),x(this,tt,It).call(this,t)}get isOverlayEnabled(){return h(this,k)}enableDebug(t){_(this,F,!0),t&&_(this,k,!0)}disableDebug(){_(this,F,!1),_(this,k,!1)}updateDisplay(t,e){if(!h(this,F))return;x(this,tt,Lt).call(this,t,e);const n=h(this,A).get("fps");n&&(n.textContent=`FPS: ${h(this,Z).toFixed(2)}`);const i=h(this,A).get("tps");i&&(i.textContent=`TPS: ${h(this,J).toFixed(2)}`)}}F=new WeakMap,k=new WeakMap,A=new WeakMap,Y=new WeakMap,Z=new WeakMap,J=new WeakMap,Q=new WeakMap,tt=new WeakSet,Lt=function(t,e){const n=t-h(this,Q);n>=1e3&&(_(this,Z,h(this,Y)*1e3/n),_(this,J,e.tickCount*1e3/n),_(this,Y,0),e.tickCount=0,_(this,Q,t)),ct(this,Y)._++},It=function(t){const e=document.createElement("div");e.classList.add("debug-container"),t.appendChild(e),h(this,A).set("debug-container",e);const n=document.createElement("div");n.classList.add("debug-info-container"),e.appendChild(n),h(this,A).set("info-container",n);const i=document.createElement("div");i.classList.add("debug-info"),n.appendChild(i),h(this,A).set("fps",i);const o=document.createElement("div");o.classList.add("debug-info"),n.appendChild(o),h(this,A).set("tps",o)};async function Ht(){try{let l=dt;const t=400,e=40,n=1e3,i=4;l.GAME_WIDTH=Math.max(e,Math.min(t,l.GAME_WIDTH)),l.GAME_HEIGHT=Math.max(e,Math.min(t,l.GAME_HEIGHT)),l.PHYSICS_UPDATE_INTERVAL=Math.max(i,Math.min(n,l.PHYSICS_UPDATE_INTERVAL)),Object.freeze(l);const o=document.getElementById("main-canvas");if(!(o instanceof HTMLCanvasElement))throw new Error("HTML element 'main-canvas' does not exist.");const s=document.getElementById("main-panel");if(!(s instanceof HTMLDivElement))throw new Error("HTML element 'main-panel' does not exist.");o.style.aspectRatio=(l.GAME_WIDTH/l.GAME_HEIGHT).toString();const r=new Tt(o,l),c=await St("./src/data/particles.data"),a=new Rt(c,s,o,l,r),d=new Bt(s);d.enableDebug(!1),new Mt(c,l,r,a,d).start(),console.log(c)}catch(l){console.error("ERROR: Failed to initialize engine due to data loading failure.",l)}}Ht();
